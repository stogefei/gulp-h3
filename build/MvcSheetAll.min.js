!function($){$.fn.SheetAttachment=function(){return $.MvcSheetUI.Run.call(this,"SheetAttachment",arguments)},$.MvcSheetUI.Controls.SheetAttachment=function(e,t,i){_PORTALROOT_GLOBAL,this.SheetAttachmentHandler=_PORTALROOT_GLOBAL+"/FileUpload/UploadFile",this.FileUpload=$("<input type='file' id='myUpfile' />").attr("data-attachment",!0),this.Files=0,this.AddAttachments={},this.UploadAttachmentsIds=[],this.RomveAttachments=[],this.XHRJson={},this.SchemaCode="",this.Multiple=!0,this.MaxUploadSizefloat=e.getAttribute("data-maxuploadsize"),$.MvcSheetUI.Controls.SheetAttachment.Base.constructor.call(this,e,t,i)},$.MvcSheetUI.Controls.SheetAttachment.Inherit($.MvcSheetUI.IControl,{Render:function(){this.Visiable?(this.HtmlRender(),this.InitValue(),this.IsHtml5?this.Html5Render():this.NotHtml5Render()):$(this.Element).hide()},RenderMobile:function(){this.Render();var e=$(this.Element).closest("div.item");e.css("padding","1px").removeClass("item-input");var t=$(this.Element).parent().prev().remove(),i=$("<div class='item item-input attachment'></div>");if(i.append(t),this.Visiable&&i.insertBefore(e),$(this.Element).parent().width("100%"),this.Editable){this.btnUpload=$('<div class="detail item-icon-right file-up"><span>'+SheetLanguages.Current.PleaseSelect+'</span><div class="paperclip"></div></div>').appendTo(i),this.FileUpload.appendTo(i);var a=this;i.bind("click.uploadAttachment",function(){a.MobileSelectFileAction()})}$(this.Element).find(".file").next(".input-label").each(function(e,t){var i=$(this).text();i&&15<=i.length&&(i=i.substr(0,12)+"..."),$(this).text(i)})},MobileSelectFileAction:function(){var t=this,e=navigator.userAgent,i=(-1<e.indexOf("Android")||e.indexOf("Adr"),!!e.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)),a=$.MvcSheetUI.IonicFramework.$rootScope.dingMobile.isDingMobile;if(i||a)document.getElementById("myUpfile").addEventListener("click",function(){});else{var n=$.MvcSheetUI.IonicFramework.$ionicActionSheet.show({buttons:[{text:SheetLanguages.Current.TakePhotos},{text:SheetLanguages.Current.FileSelect}],cancelText:SheetLanguages.Current.Cancel,cancel:function(){return!1},buttonClicked:function(e){if(0==e){if(n(),t.FileUpload.removeAttr("multiple").attr("accept","image/*").attr("capture","camera"),$(t.Element).data($.MvcSheetUI.DataFieldKey.toLowerCase())!=t.DataField)return;t.FileUpload.click()}else{if(n(),t.FileUpload.removeAttr("capture").removeAttr("accept"),$(t.Element).data($.MvcSheetUI.DataFieldKey.toLowerCase())!=t.DataField)return;t.FileUpload.click()}}});$.MvcSheetUI.IonicFramework.$timeout(function(){n()},1e4)}},MobileDownLoad:function(e){},MobileItemClick:function(a,n,e){var s=this,t=[{text:SheetLanguages.Current.Preview,code:"Preview"},{text:SheetLanguages.Current.Delete,code:"delete"}];!n&&this.Editable&&(t=[{text:SheetLanguages.Current.Delete,code:"delete"}]),n&&!this.Editable&&(t=[{text:SheetLanguages.Current.Preview,code:"Preview"}]);var i="ID:"+$.MvcSheetUI.SheetInfo.UserCode,l="UserName:"+$.MvcSheetUI.SheetInfo.UserName,h=new Date,r=h.getFullYear(),o=h.getMonth()+1,d=h.getDate(),c=h.getHours(),u=h.getMinutes(),p=h.getSeconds(),m=encodeURIComponent(i+l+("Time:"+r+"年"+o+"月"+d+"日"+c+":"+u+":"+p));$.MvcSheetUI.IonicFramework.$ionicActionSheet.show({buttons:t,titleText:SheetLanguages.Current.AtatchmentAcction,cancelText:SheetLanguages.Current.Cancel,buttonClicked:function(e,t){if("Preview"==t.code){var i=window.location.href;if(i=i.split(_PORTALROOT_GLOBAL)[0],"dingtalk"==$.MvcSheetUI.IonicFramework.$rootScope.loginfrom&&dd)!!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)?dd.biz.util.openLink({url:i+n+"?"+Math.random(),onSuccess:function(e){},onFail:function(e){$.MvcSheetUI.IonicFramework.fcommonJS.loadingShow("响应错误")}}):$.ajax({type:"POST",url:i+n+"&AppLogin=true?"+Math.random(),cache:!1,success:function(e){if(e&&e.success&&e.url){var t=e.url;-1<["jpg","gif","jpeg","png","txt","doc","docx","pdf","xls","xlsx","ppt","pptx","xml"].indexOf(e.extension)?($.MvcSheetUI.IonicFramework.$rootScope.AttachmentUrl=t,$.MvcSheetUI.IonicFramework.$state.go("form.downLoadFile",{extension:e.extension})):$.MvcSheetUI.IonicFramework.fcommonJS.loadingShow("不支持"+e.extension+"格式文件的预览")}else $.MvcSheetUI.IonicFramework.fcommonJS.loadingShow("不支持"+e.extension+"格式文件的预览")}});else $.ajax({type:"POST",url:i+n+"&AppLogin=true?"+Math.random(),cache:!1,success:function(e){if(e&&e.success&&e.url){var t=e.url;if(-1<["jpg","gif","jpeg","png","txt","doc","docx","pdf","xls","xlsx","ppt","pptx","xml"].indexOf(e.extension)){$.MvcSheetUI.IonicFramework.$rootScope.AttachmentUrl=t;navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);window.location.href=t+"&watermark="+m}else $.MvcSheetUI.IonicFramework.fcommonJS.loadingShow("不支持"+e.extension+"格式文件的预览")}else $.MvcSheetUI.IonicFramework.fcommonJS.loadingShow("不支持"+e.extension+"格式文件的预览")},error:function(){$.MvcSheetUI.IonicFramework.fcommonJS.loadingShow("响应错误")}})}else"delete"==t.code&&s.RemoveFile.apply(s,[a]);return!0}})},InitValue:function(){if(this.V){null==this.BizObjectID&&(this.BizObjectID=this.SheetInfo.BizObjectID);for(var e=0;e<this.V.length;++e){var t=this.V[e].Name,i=t.lastIndexOf("."),a=t.lastIndexOf("@");0<a&&(t=this.V[e].Name.substring(a,i),t=this.V[e].Name.replace(t,"")),this.CreateFileElement($.trim(this.V[e].Code),t,this.V[e].Size,this.V[e].Url,this.V[e].ContentType)}if(!this.IsMobile&&this.AllowBatchDownload&&1<this.V.length){var n=$('<a href="'+_PORTALROOT_GLOBAL+"/ReadAttachment/ReadBatch?BizObjectID="+this.BizObjectID+"&SchemaCode="+this.SchemaCode+"&DataField="+this.DataField+"&DisplayName="+this.DataField+'" class="printHidden">批量下载</a>');$(this.Element).append(n),this.IsMobile?n.css("margin-left","10px").css("margin-right","10px").addClass("button").addClass("block"):n.width("100%").addClass("btn").addClass("btn-outline").addClass("btn-lg").css("border","1px dashed #ddd")}}},Validate:function(e,t){if(!this.Editable)return!0;if(t&&this.Required&&this.Files<1)return this.IsMobile?this.AddMobileInvalidText(this.Element,"*",!1):this.AddInvalidText(this.Element,"*",!1),!1;if(!e){if(this.Required){if(this.Files<1)return this.IsMobile?this.AddMobileInvalidText(this.Element,"*",!1):this.AddInvalidText(this.Element,"*"),!1;0}if(this.FileExtensions||this.MaxUploadSizefloat){if((this.IsMobile?$(this.Element).children(".list").children("a").length:$(this.Element).find("table tr").length)>this.Files)return $(this.Element).addClass("inputError"),!1;$(this.Element).hasClass("inputError")&&$(this.Element).removeClass("inputError")}}if(this.IsHtml5){for(var i in this.AddAttachments)if(0==this.AddAttachments[i].state)return this.AddInvalidText(this.Element,SheetLanguages.Current.Uploading),!1}else this.Form.submit();return this.IsMobile?this.RemoveMobileInvalidText():this.RemoveInvalidText(this.Element),!0},AddMobileInvalidText:function(e,t,i){if(0==$.MvcSheetUI.SheetInfo.IsMobile)$(this.btnUpload).prev().hasClass(this.Css.InvalidText)||$('<label class="'+this.Css.InvalidText+'">'+t+"</label>").insertBefore($(this.btnUpload));else if(0==$(this.btnUpload).closest(".item.item-input").find(".input-label").find("."+this.Css.InvalidText).length){var a=$(this.btnUpload).closest(".item.item-input").find(".input-label")[0],n=$(a).text();$(a).empty(),$("<span>"+n+"</span>").appendTo($(a)),$('<label class="'+this.Css.InvalidText+'">'+t+"</label>").appendTo($(this.btnUpload).closest(".item.item-input").find(".input-label"))}},RemoveMobileInvalidText:function(){0==$.MvcSheetUI.SheetInfo.IsMobile?($(this.btnUpload).removeClass(this.Css.inputError),$(this.btnUpload).prev().hasClass(this.Css.InvalidText)&&$(this.btnUpload).prev().remove()):$(this.btnUpload).closest(".item.item-input").find("."+this.Css.InvalidText).remove()},SaveDataField:function(){var e={};return this.Visiable&&this.Editable&&(e[this.DataField]=this.DataItem,e[this.DataField].V=this.GetValue()),e},GetValue:function(){var e="";if(this.IsHtml5){for(var t in this.AddAttachments)1==this.AddAttachments[t].state&&this.AddAttachments[t].AttachmentId&&(e+=this.AddAttachments[t].AttachmentId+";");null==t&&0<this.DataItem.V.length&&(e+=this.DataItem.V[0].Code+";")}else for(var i=0;i<this.UploadAttachmentsIds.length;i++)e+=this.UploadAttachmentsIds[i]+";";var a="";for(i=0;i<this.RomveAttachments.length;++i)a+=this.RomveAttachments[i]+";";return{AttachmentIds:e,DelAttachmentIds:a}},GetText:function(){return this.Files},ClearFiles:function(){$(this.Element).html(""),this.Files=0,this.Validate()},HtmlRender:function(){$(this.Element).addClass("SheetAttachment"),this.IsMobile?this.UploadList=$("<div class='list'></div>"):this.UploadList=$("<table class='table table-striped'></table>").css("margin",0).css("min-height","0px"),$(this.Element).append(this.UploadList)},NotHtml5Render:function(){if(this.Editable){$(this.Element).width(this.Width);var e=$.MvcSheetUI.NewGuid(),t="DataField="+encodeURI(this.DataField)+"&PostForm=true&BizObjectID="+this.SheetInfo.BizObjectID+"&SchemaCode="+encodeURI(this.SchemaCode);t+="&MaxSize="+1024*this.MaxUploadSize,this.Form=$('<form id="'+e+'" method="post" enctype="multipart/form-data" action="'+this.SheetAttachmentHandler+"?"+t+'"></form>'),$(this.Element).append(this.Form),this.CreateFrame(),this.Multiple?(this.BtnAdd=$("<div>"+SheetLanguages.Current.Add+"</div>").addClass("SheetAttachmentAdd"),$(this.Form).append(this.BtnAdd),$(this.BtnAdd).unbind("click.AddAttachment").bind("click.AddAttachment",this,function(e){e.data.AddAttachment.apply(e.data)})):($(this.FileUpload).attr("name",$.MvcSheetUI.NewGuid()),$(this.Form).append(this.FileUpload)),this.BtnUpload=$("<div>"+SheetLanguages.Current.Upload+"</div>").addClass("SheetAttachmentUpload"),$(this.BtnUpload).unbind("click.UploadAttachment").bind("click.UploadAttachment",this,function(e){e.data.Form.submit();var t="";$(e.data.Form).find("input").each(function(){this.value&&(t+=","+this.name),-1==e.data.UploadAttachmentsIds.indexOf(this.name)&&e.data.UploadAttachmentsIds.push(this.name)});var i=e.data;t&&setTimeout(function(){i.CheckUpload(t)},500)}),$(this.Form).append(this.BtnUpload),this.AddAttachment()}},CheckUpload:function(i){var a=this;$.MvcSheet.GetSheet({Command:"GetAttachmentHeader",Param:JSON.stringify([this.SheetInfo.SchemaCode,this.SheetInfo.BizObjectID,i])},function(e){if(e&&0<e.length)for(var t=0;t<e.length;t++)a.CreateFileElement(e[t].AttachmentID,e[t].FileName,e[t].ContentLength,a.PortalRoot+"/ReadAttachment/Read?AttachmentID="+e[t].AttachmentID,e[t].ContentType),i=i.replace(","+$.trim(e[t].AttachmentID),""),$("div[id='"+$.trim(e[t].AttachmentID)+"']").remove();i&&setTimeout(function(){a.CheckUpload(i)},500)})},CreateFrame:function(){var e="uploadFrame_"+$.MvcSheetUI.NewGuid(),t=$("<iframe name="+e+">");t.css("display","none"),$("body").prepend(t),this.Form.attr("target",e),this.Form.attr("method","post"),this.Form.attr("encoding","multipart/form-data")},AddAttachment:function(){var e=$.MvcSheetUI.NewGuid(),t=$("<div>").attr("id",e).addClass("upload").css("clear","both"),i=$('<input type="file" style="width:60%;"  />').attr("name",e),a=$("<a href='#' style=\"padding-left:10px;\">"+SheetLanguages.Current.Remove+"</a>").attr("data-content",e);$(a).unbind("click.DeleteAttachment").bind("click.DeleteAttachment",this,function(e){e.data.Files--,$("#"+$(this).attr("data-content")).remove()}),t.append(i).append(a),$(this.BtnAdd).before(t),this.Files++,this.Validate()},Html5Render:function(){this.Editable&&(this.Multiple&&this.FileUpload.attr("multiple","multiple"),this.SheetAttachmentHandler+="?IsMobile="+this.IsMobile+"&SchemaCode="+encodeURI(this.SchemaCode)+"&fileid=",this.ActionPanel=$("<div>"+SheetLanguages.Current.DragUpload+"</div>"),this.IsMobile?this.ActionPanel.css("margin-left","10px").css("margin-right","10px").addClass("button").addClass("block"):this.ActionPanel.width("100%").addClass("btn").addClass("btn-outline").addClass("btn-lg").css("border","1px dashed #ddd"),$(this.Element).append(this.ActionPanel),this.FileExtensions&&this.FileUpload.attr("accept",this.FileExtensions),$(this.Element).append(this.FileUpload),this.IsMobile?(this.ActionPanel.hide(),this.FileUpload.css({opacity:"0","z-index":"99"})):this.FileUpload.hide(),$(this.ActionPanel).unbind("click.SheetAttachment").bind("click.SheetAttachment",this,function(e){$.extend(this,e.data),$(this.Element).data($.MvcSheetUI.DataFieldKey.toLowerCase())==this.DataField&&this.FileUpload.click()}),this.FileUpload.unbind("change.FileUpload").bind("change.FileUpload",this,function(e){e.data.AddFiles.apply(e.data,[e.data.getFiles(this.files)]),$(this).val("")}),this.BindDrag())},BindDrag:function(){if(!this.IsMobile){$(this.ActionPanel).on({dragenter:function(e){e.stopPropagation(),e.preventDefault()},dragleave:function(e){e.stopPropagation(),e.preventDefault()},dragover:function(e){e.stopPropagation(),e.preventDefault()}});var i=this;this.ActionPanel[0].addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault();var t=i.getFiles(e.dataTransfer.files);i.AddFiles.apply(i,[t])},!1)}},getFiles:function(e){for(var t=[],i=0;i<e.length;i++)t.push(e[i]);return t},_OpenImage:function(e){var t=$(e.target);t.is("[data-img-url]")||(t=$(t).closest("[data-img-url]"));var i=$(t).attr("img-panel-id");if(i)$.ui.loadContent(i);else{i=$.uuid(),$(t).attr("img-panel-id",i);var a=$("<div>").addClass("panel").attr("id",i).attr("js-scrolling","false").attr("data-footer","none"),n=$("<div>").addClass("img-wrapper"),s=document.createElement("img");n.append(s),a.append(n),a.appendTo("#content"),$.ui.loadContent(i),s.onload=function(){var e=$(arguments[0].target),t=e.width(),i=$(e).closest(".panel").width(),a=1;i<t&&(a=i/t),setTimeout(function(){imgScroll=new IScroll(n.get(0),{zoom:!0,zoomMin:a,zoomMax:4,scrollX:!0,scrollY:!0,wheelAction:"zoom"}),imgScroll.zoom(a)},600)};var l=$(t).attr("data-img-url");$.ajax({type:"POST",url:l,success:function(e){s.src=e}})}},RenderImageAnchor:function(e,t){e.unbind("click").bind("click",this._OpenImage)},CreateFileElement:function(e,t,i,u,a){var n=0;n=1048576<i?(Math.round(100*i/1048576)/100).toString()+"MB":(Math.round(100*i/1024)/100).toString()+"KB";var s=$("<td data-filesize='"+e+"'><span data-filerate='"+e+"'>"+SheetLanguages.Current.Loading+"</span> ("+n+")</td>").addClass("text-info"),l=$("<td data-action='"+e+'\' class="printHidden"></td>');this.IsMobile&&(s=$("<span class='item-note' data-filesize='"+e+"'>（"+n+"）</span><span class='item-note' data-filerate='"+e+"'>"+SheetLanguages.Current.Loading+"</span>"),l=$("<span data-action='"+e+'\' class="printHidden"></span>'));var h=$("<a href='#' class='fa fa-minus'>"+SheetLanguages.Current.Remove+"</a>");this.Editable?h.unbind("click.fileDeleteBtn").bind("click.fileDeleteBtn",this,function(e){confirm(SheetLanguages.Current.ConfirmRemove)&&e.data.RemoveFile.apply(e.data,[$(this).closest("tr").attr("id")])}):h.hide();var r=!0,o=t,d="";if(0<o.lastIndexOf(".")&&(d=(d=t.substring(t.lastIndexOf("."),t.length)).toLowerCase()),this.IsMobile&&15<=o.length&&(o=o.substr(0,12)+"..."),null==u)if(this.FileExtensions&&(""!=d?this.FileExtensions.indexOf(d)<0&&(r=!1):r=!1),r){var c=Math.round(100*i/1024)/100;if(0!=parseFloat(this.MaxUploadSizefloat)&&this.MaxUploadSizefloat||(this.MaxUploadSizefloat="10"),c>Math.round(1024*parseFloat(this.MaxUploadSizefloat))&&(r=!1,window.console.log("最大设置上传大小"+Math.round(1024*parseFloat(this.MaxUploadSizefloat))+"kb"),s=this.IsMobile?$("<span data-filesize='"+e+"'data-filerate='"+e+"' style='color:red;'>"+SheetLanguages.Current.OverMaxLength+"</span><span>("+n+")</span>"):$("<td data-filesize='"+e+"'><span data-filerate='"+e+"'  style='color:red;'>"+SheetLanguages.Current.OverMaxLength+"</span> ("+n+")</td>").addClass("text-info")),this.IsMobile)!!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)&&-1<a.indexOf("video")&&(s=$("<span style='color:red;'>"+SheetLanguages.Current.ISOVideoUploadWarn+"</span>").addClass("text-info"),r=!1)}else s=this.IsMobile?$("<span data-filesize='"+e+"'data-filerate='"+e+"' style='color:red;'>"+SheetLanguages.Current.FileExtError+"</span><span>("+n+")</span>"):$("<td data-filesize='"+e+"'><span data-filerate='"+e+"' style='color:red;'>"+SheetLanguages.Current.FileExtError+"</span> ("+n+")</td>").addClass("text-info");else{if(!this.IsMobile){l.append($("<a href='"+u+"' class='fa fa-download' target='_blank' UC=true>"+SheetLanguages.Current.Download+"</a>")),l.append("&nbsp;&nbsp;");var p=$("<a href='#' class='fa fa-file'>&nbsp;预览</a>");p.unbind("click.fileYlBtn").bind("click.fileYlBtn",this,function(e){var t="ID:"+$.MvcSheetUI.SheetInfo.UserCode,i="UserName:"+$.MvcSheetUI.SheetInfo.UserName,a=new Date,n=a.getFullYear(),s=a.getMonth()+1,l=a.getDate(),h=a.getHours(),r=a.getMinutes(),o=a.getSeconds(),d=encodeURIComponent(t+i+("Time:"+n+"年"+s+"月"+l+"日"+h+":"+r+":"+o)),c=window.location.href;c=c.split(_PORTALROOT_GLOBAL)[0],$.ajax({type:"POST",url:c+u+"&IsMobile=true&AppLogin=true",success:function(e){console.log(e),window.open(e.url+"&watermark="+d)}})}),l.append(p),l.append("&nbsp;&nbsp;")}s=this.IsMobile?$("<span class='item-note' data-filesize='"+e+"'>"+n+"</span>"):$("<td data-filesize='"+e+"'>"+n+"</td>").addClass("text-info")}var m=$("<tr></tr>").attr("id",e);if(this.IsMobile&&(m=$("<a class='item item-input item-icon-right' style='white-space:nowrap;flex-wrap:wrap;' href='javascript:void(0)'></a>").attr("id",e)),this.IsMobile&&null!=u?this.IsMobile&&a&&0==a.toLowerCase().indexOf("image/")?(m.attr("data-img-url",u),m.append("<label  class='input-label'>"+t+"<label>"),m.attr("data-url",u),m.bind("click.mobilerow",this,function(e){e.data.MobileItemClick.apply(e.data,[m.attr("id"),u,!0])})):this.IsMobile?(m.append("<label  class='input-label'>"+t+"<label>"),m.attr("data-url",u),m.unbind("click.mobilerow").bind("click.mobilerow",this,function(e){e.data.MobileItemClick.apply(e.data,[m.attr("id"),u])})):m.append("<td ><a href='"+u+"' class='fa fa-download' target='_blank' UC=true><div class='LongWord'>"+t+"</div></a></td>"):null==u&&this.IsMobile?(m.append("<label class='input-label' title='"+t+"'>"+o+"<label>"),m.bind("click.mobilerow",this,function(e){e.data.MobileItemClick.apply(e.data,[m.attr("id"),u])})):m.append("<td ><div class='LongWord'>"+t+"</div></td>"),m.append(s.css("text-align","right")),this.IsMobile){var f=$("<span></span>"),v=t.match(/\.\w+$/),g={img:[".bmp",".jpg",".jpeg",".gif",".png"],ppt:[".ppt",".pptx"],word:[".doc",".docx"],pdf:[".pdf"],excel:[".xls",".xlsx"]};for(key in v=String(v).toLowerCase(),g){if(-1!=g[key].indexOf(v)){f.removeClass("file").addClass(key);break}f.removeClass("file").addClass("file")}m.prepend(f)}this.IsMobile||m.append(l.append(h).css("text-align","center")),this.UploadList.append(m),r&&this.Files++;var S=150;100<$(this.Element).width()&&(S=$(this.Element).width()/2),m.find(".LongWord").width(S+"px");var I=$.MvcSheetUI.NewGuid(),b=$("<span>").attr("id",I).text(t).appendTo("body").width();return $("#"+I).remove(),S<b&&m.find(".LongWord").attr("title",t).css("float","left").after(d),r},AddFiles:function(e){this.Multiple||this.ClearFiles();var t,i;if(e&&0<e.length){var a=$.MvcSheetUI.NewGuid(),n=(t=new RegExp("(^|&)"+"SheetCode"+"=([^&]*)(&|$)"),null!=(i=window.location.search.substr(1).match(t))?unescape(i[2]):null);this.CreateFileElement(a,e[0].name,e[0].size,null,e[0].type)&&(this.AddAttachments[a]={fileid:a,file:e[0],ContentType:e[0].type,xhr:new XMLHttpRequest,state:0},e.splice(0,1),this.UploadFile(a,e,n))}},UploadFile:function(e,t,i){if(null!=this.AddAttachments[e]||0==this.AddAttachments[e].state){var a=new FormData;a.append("fileToUpload",this.AddAttachments[e].file),a.append("MaxSize",1024*this.MaxUploadSize);var n=this.AddAttachments[e].xhr;n.context=this,n.files=t,n.upload.fileid=e,n.abort.fileid=e,n.upload.addEventListener("progress",this.UploadProgress,!1),n.addEventListener("load",this.UploadComplete,!1),n.addEventListener("error",this.UploadFailed,!1),n.addEventListener("abort",this.UploadCanceled,!1),n.open("POST",this.SheetAttachmentHandler+e+"&SheetCode="+i),n.send(a)}},UploadProgress:function(e){if(e.lengthComputable){var t=Math.round(100*e.loaded/e.total);100<=t&&(t=99),$("span[data-filerate='"+e.currentTarget.fileid+"']").html(t+"%")}else this.context.AddAttachments[e.currentTarget.fileid].state=100,$("span[data-filerate='"+e.currentTarget.fileid+"']").css("color","red").html(SheetLanguages.Current.UploadError)},UploadComplete:function(evt){if(200==evt.target.status){var resultObj=eval("("+evt.target.responseText+")"),fileid=resultObj.FileId;this.context.AddAttachments[fileid].state=1,this.context.AddAttachments[fileid].AttachmentId=resultObj.AttachmentId,$("td[data-action='"+fileid+"']").prepend("&nbsp;&nbsp;"),this.context.IsMobile?this.context.AddAttachments[fileid].ContentType&&0==this.context.AddAttachments[fileid].ContentType.toLowerCase().indexOf("image/")?$("#"+fileid).attr("data-img-url",resultObj.Url).attr("data-url",resultObj.Url).unbind("click.mobilerow").bind("click.mobilerow",this.context,function(e){e.data.MobileItemClick.apply(e.data,[fileid,resultObj.Url,!0])}):$("#"+fileid).attr("data-url",resultObj.Url).unbind("click.mobilerow").bind("click.mobilerow",this.context,function(e){e.data.MobileItemClick.apply(e.data,[fileid,resultObj.Url])}):$("td[data-action='"+fileid+"']").prepend($("<a href='"+resultObj.Url+"' class='fa fa-download' target='_blank' UC=true>"+SheetLanguages.Current.Download+"</a>")),$("span[data-filerate='"+fileid+"']").html("100%"),this.context.Validate()}else this.context.UploadFailed(evt);this.context.AddFiles(this.files)},UploadFailed:function(e){this.context.AddAttachments[e.currentTarget.fileid].state=100,$("span[data-filerate='"+e.currentTarget.fileid+"']").html(SheetLanguages.Current.UploadError)},UploadCanceled:function(){},RemoveFile:function(e){e=$.trim(e),$("#"+e).remove(),this.Files--,this.Files=this.Files<0?0:this.Files,this.AddAttachments[e]?(this.AddAttachments[e].xhr.abort(),delete this.AddAttachments[e]):this.RomveAttachments.push(e),this.Validate()}})}(jQuery),function(n){n.fn.SheetCheckbox=function(){return n.MvcSheetUI.Run.call(this,"SheetCheckbox",arguments)},n.MvcSheetUI.Controls.SheetCheckbox=function(e,t,i){n.MvcSheetUI.Controls.SheetCheckbox.Base.constructor.call(this,e,t,i)},n.MvcSheetUI.Controls.SheetCheckbox.Inherit(n.MvcSheetUI.IControl,{Checked:!1,Render:function(){""==this.DefaultValue||"false"==this.DefaultValue?this.DefaultValue=!1:"true"==this.DefaultValue&&(this.DefaultValue=!0);var e=!1;if(e="false"==this.V||0==this.V?this.Checked=!1:this.Checked=!0,this.Originate?(this.Checked=this.DefaultValue||e,this.Element.checked=this.DefaultValue||e):(this.Checked=e,this.Element.checked=this.Checked),this.DefaultValue&&(this.Element.checked=!0),this.Visiable){this.TrackVisiable&&!this.Originate&&-1==this.DataField.indexOf(".")&&this.RenderDataTrackLink(),n(this.Element).unbind("mouseenter").unbind("mouseover").unbind("mouseup").unbind("mouseout"),n(this.Element).css("cursor","pointer");var t=n("<div class='checkbox'><label>"+this.Text+"</label></div>");n(this.Element).before(t),n(this.Element).appendTo(t.children("label")),this.Editable?this.OnChange&&n(this.Element).unbind("click.SheetCheckbox").bind("click.SheetCheckbox",this,function(e){e.data.RunScript(e.data.Element,e.data.OnChange)}):n(this.Element).prop("disabled",!0)}else this.Element.style.display="none"},GetValue:function(){return this.Element.checked},SetValue:function(e){"string"==typeof e&&"true"==e.toLowerCase()?this.Checked=!0:this.Checked="boolean"==typeof e&&1==e,this.Element.checked=this.Checked,this.IsMobile},RenderMobile:function(){var e=!("false"==this.V||0==this.V);if(this.Originate?(this.Checked=this.DefaultValue||e,this.Element.checked=this.DefaultValue||e):(this.Checked=e,this.Element.checked=this.Checked),this.Visiable){var t=n(this.Element).attr("id");t||(t=n.uuid(),n(this.Element).attr("id",t));var i=n("<span class='checkboxtitle'></span>");if(i.text(this.Text),n(this.Element).parent().before(i),n(this.Element).addClass("toggle"),this.Editable||n(this.Element).prop("disabled",!0),this.Editable)n(this.Element).unbind("click.SheetCheckbox").bind("click.SheetCheckbox",this,function(e){e.data.RunScript(e.data.Element,e.data.OnChange)});else{var a=n(this.Element).parent("label");a.children().hide(),a.append(this.Checked?"<span style='font-size:16px;'>是</span>":"<span style='font-size:16px;'>否</span>")}}},Validate:function(){return!0},SaveDataField:function(){var e={};return this.Visiable&&this.Editable?(e[this.DataField]=n.MvcSheetUI.GetSheetDataItem(this.DataField),e[this.DataField]?(e[this.DataField].V=this.GetValue(),e):(-1==this.DataField.indexOf(".")&&alert(SheetLanguages.Current.DataItemNotExists+":"+this.DataField),{})):e}})}(jQuery),function(h){var r=[],o=[];h.fn.SheetCheckboxList=function(){return h.MvcSheetUI.Run.call(this,"SheetCheckboxList",arguments)},h.MvcSheetUI.Controls.SheetCheckboxList=function(e,t,i){this.CheckListDisplay=[],h.MvcSheetUI.Controls.SheetCheckboxList.Base.constructor.call(this,e,t,i)},h.MvcSheetUI.Controls.SheetCheckboxList.Inherit(h.MvcSheetUI.IControl,{Render:function(){this.Visiable?(this.TrackVisiable&&!this.Originate&&-1==this.DataField.indexOf(".")&&this.RenderDataTrackLink(),this.HtmlRender(),this.InitValue(),this.Validate()):h(this.Element).hide()},GetValue:function(){var e="";return h(this.Element).find("input").each(function(){this.checked&&(e+=h(this).val()+";")}),this.IsMobile&&!e&&(e=this.DataItem.V),e},MobileAddItem:function(e,t,i){this.CheckListDisplay.push({text:t,value:e,checked:i})},SetValue:function(e){if(e)var t=e.split(";");if(this.IsMobile&&void 0!==e){var i=this;h(this.Element).find("input").each(function(){h(i.CheckListDisplay).each(function(e,i){h(t).each(function(e,t){i.value==t&&(i.checked=!0)})}),h(this).prop("checked",!1)}),i=null}if(null!=t)for(var a=0;a<t.length;a++)h(this.Element).find("input").each(function(){this.value!=t[a]&&this.value!=t[a].replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\"/g,"&quot;")||h(this).prop("checked",!0)});this.IsMobile&&(this.OnChange&&this.RunScript(this,this.OnChange),this.Mask.text(this.GetText()),this.Editable&&(""==this.Mask.text()||this.Mask.text()==SheetLanguages.Current.PleaseSelect?(this.Mask.text(SheetLanguages.Current.PleaseSelect),this.Mask.css({color:"#797f89"})):this.Mask.css({color:"#2c3038"})))},GetText:function(){var e="";return h(this.Element).find("input").each(function(){this.checked&&(e&&(e+=","),e+=h(this).next().text())}),e},SetReadonly:function(e){e?h(this.Element).find("input").prop("disabled",!0):h(this.Element).find("input").prop("disabled",!1)},SetColumns:function(){if(this.RepeatColumns&&/^([1-9]\d*)$/.test(this.RepeatColumns)){var e,t=100/this.RepeatColumns+"%",i=h(this.Element).find("div");for(e=0;e<i.length;e++)h(i[e]).css({width:t})}},InitValue:function(){var e=void 0,t="";if(null==this.V||""==this.V){if(null==this.SelectedValue||""==this.SelectedValue)return;e=this.SelectedValue.split(";")}else e=this.V.split(";");if(null!=e){h(this.Element).find("input").each(function(){h(this).prop("checked",!1)});for(var i=0;i<e.length;i++)if(h(this.Element).find("input").each(function(){this.value==e[i]&&(t&&(t+="、"),t+=h(this).next().text(),h(this).prop("checked",!0))}),this.IsMobile){for(var a in this.CheckListDisplay)this.CheckListDisplay[a].value==e[i]&&(this.CheckListDisplay[a].checked=!0)}}this.IsMobile&&(this.Editable?this.Mask.html(t):h(this.Element).html(t))},MobileInit:function(){var s=this,e=h.MvcSheetUI.IonicFramework,i=[];s.DisplayRule&&r.push(s.DataField),s.VaildationRule&&o.push(s),this.Editable&&h(this.Element).parent().unbind("click.MobileCheckListBox").bind("click.MobileCheckListBox",function(){e.$ionicModal.fromTemplateUrl("Mobile/form/templates/checkbox_popover.html?v=201909201706",{scope:e.$scope}).then(function(n){n.scope.header=s.N,n.scope.CheckListDisplay=s.CheckListDisplay,n.scope.DataField=s.DataField,n.show(),n.scope.hide=function(){n.hide(),s.Validate(),n.scope.rememberCheck()},n.scope.closePopover=function(){n.hide();for(var e=0;e<n.scope.CheckListDisplay.length;e++)n.scope.CheckListDisplay[e].checked=i[e];var t=s.MobileGetCheckListValue(n.scope.CheckListDisplay);s.SetValue(t)},n.scope.rememberCheck=function(){for(var e=0;e<n.scope.CheckListDisplay.length;e++)0==n.scope.CheckListDisplay[e].checked?i[e]=!1:i[e]=!0},n.scope.checkAllSelected=function(){for(item in n.scope.allSelected=!0,n.scope.CheckListDisplay)0==n.scope.CheckListDisplay[item].checked&&(n.scope.allSelected=!1)},n.scope.checkAllSelected(),n.scope.clickCheckList=function(){var e=s.MobileGetCheckListValue(n.scope.CheckListDisplay);s.SetValue(e),n.scope.displayRole(e,s),n.scope.checkAllSelected()},n.scope.selectAll=function(){var e=h(".active .popover .list").find("label").find("span");for(t in window.console.log(h(".active .popover .list").find("label").find("span").eq(0).text()),e)for(item in n.scope.CheckListDisplay)if(e.eq(t).text().replace(/^\s+|\s+$/g,"")==n.scope.CheckListDisplay[item].text&&(n.scope.CheckListDisplay[item].checked=!0,0!=r.length))for(var t=0;t<r.length;t++){var i=h("div[data-datafield='"+r[t]+"']").attr("data-displayrule");n.scope.DataField==i.substring(i.indexOf("{")+1,i.indexOf("}"))&&n.scope.CheckListDisplay[item].text==i.split("==")[1].split("'")[1]&&h("div[data-datafield='"+r[t]+"']").parent().removeClass("hidden")}var a=s.MobileGetCheckListValue(n.scope.CheckListDisplay);s.SetValue(a),n.scope.allSelected=!0},n.scope.displayRole=function(e,t){if(0!=r.length)for(var i=e.split(";"),a=0;a<r.length;a++){var n=h("div[data-datafield='"+r[a]+"']").attr("data-displayrule").split("==")[1].split("'"),s=h("div[data-datafield='"+r[a]+"']").attr("data-displayrule"),l=h("div[data-datafield='"+r[a]+"']").attr("data-vaildationrule");if(0<s.indexOf(""+t.DataField)&&s.substring(s.indexOf("{")+1,s.indexOf("}"))==t.DataField&&h("div[data-datafield='"+r[a]+"']").attr("data-datafield")!=t.DataField&&(i&&-1!=h.inArray(""+n[1],i)?h("div[data-datafield='"+r[a]+"']").parent().removeClass("hidden"):h("div[data-datafield='"+r[a]+"']").parent().addClass("hidden")),l&&0<l.indexOf(""+t.DataField)&&0<o.length)for(a=0;a<o.length;a++)-1==h.inArray(""+n[1],i)&&o[a].DataField==h("div[data-datafield='"+r[a]+"']").attr("data-datafield")&&-1!=h.inArray(l.split("==")[1].split("'")[1],i)||o[a].DataField==h("div[data-datafield='"+r[a]+"']").attr("data-datafield")&&s==l&&-1!=h.inArray(l.split("==")[1].split("'")[1],i)?o[a].Required=!0:o[a].Required=!1}},n.scope.unSelectAll=function(){for(item in n.scope.CheckListDisplay)if(n.scope.CheckListDisplay[item].checked=!1,0!=r.length)for(var e=0;e<r.length;e++){var t=h("div[data-datafield='"+r[e]+"']").attr("data-displayrule");n.scope.DataField==t.substring(t.indexOf("{")+1,t.indexOf("}"))&&n.scope.CheckListDisplay[item].text==t.split("==")[1].split("'")[1]&&h("div[data-datafield='"+r[e]+"']").parent().addClass("hidden")}var i=s.MobileGetCheckListValue(n.scope.CheckListDisplay);s.SetValue(i),n.scope.allSelected=!1},n.scope.searchFocus=!1,n.scope.searchAnimate=function(){n.scope.searchFocus=!n.scope.searchFocus},n.scope.searChange=function(){n.scope.unSelectAll(),n.scope.searchNum=h(".active .popover .list").children("label").length}})})},MobileGetCheckListValue:function(e){var t=[];if(e&&0<e.length)for(var i in e){var a=e[i];a.checked&&t.push(a.value)}return 0==t.length?"":t.join(";")},HtmlRender:function(){var a=this;if(this.Visiable){h(this.Element).addClass("SheetCheckBoxList"),this.SheetGropName=this.DataField+"_"+Math.floor(1e3*Math.random()),this.Editable&&this.Required&&!h(this.Element).val()&&!this.IsMobile&&this.AddInvalidText(this.Element,"*",!1);var e=h(this.Element).html();if(h(this.Element).html(""),this.MasterDataCategory){a=this;var n=JSON.stringify([this.MasterDataCategory]);if(h.MvcSheetUI.CacheData&&h.MvcSheetUI.CacheData[n]){var t=h.MvcSheetUI.CacheData[n];for(var i in t)a.AddCheckboxItem.apply(a,[t[i].Code,t[i].EnumValue,t[i].IsDefault]);a.InitValue.apply(a),a.DoRepeatDirection.apply(a),a.IsMobile&&a.MobileInit.apply(a)}else h.MvcSheet.GetSheet({Command:"GetMetadataByCategory",Param:n},function(e){if(e){h.MvcSheetUI.CacheData||(h.MvcSheetUI.CacheData={});for(var t=0,i=(h.MvcSheetUI.CacheData[n]=e).length;t<i;t++)a.AddCheckboxItem.apply(a,[e[t].Code,e[t].EnumValue,e[t].IsDefault])}a.InitValue.apply(a),a.DoRepeatDirection.apply(a),a.IsMobile&&a.MobileInit.apply(a)},null,-1==this.DataField.indexOf("."))}else if(this.DefaultItems){for(var s=this.DefaultItems.split(";"),l=0;l<s.length;l++)a.AddCheckboxItem.apply(a,[s[l],s[l],!1]);this.InitValue(),a.IsMobile&&a.MobileInit.apply(a),this.DoRepeatDirection()}else h(this.Element).html(e),this.InitValue(),a.IsMobile&&a.MobileInit.apply(a);h(a.Element).unbind("click").bind("click",[a],function(e){a.SetInvalidText()}),h(a.Element).unbind("change").bind("change",[a],function(e){e.data[0].RunScript(this,e.data[0].OnChange)})}else h(this.Element).hide()},RenderMobile:function(){this.HtmlRender(),this.Editable?(this.SetValue(),this.Mask.insertAfter(h(this.Element)),this.pupIcon=h("<i class='icon ion-ios-arrow-right'></i>").insertAfter(this.Mask),h(this.Element).closest("div.item").addClass("item-icon-right"),h(this.Element).hide()):(h(this.Element).addClass(this.Css.Readonly),this.GetValue()||h(this.Element).hide())},DoRepeatDirection:function(){"Horizontal"==this.RepeatDirection&&h(this.Element).find("[SheetGropName='"+this.SheetGropName+"']").css("float","left"),this.SetColumns()},Validate:function(e,t){if(this.IsMobile){if(!this.Editable)return!0;for(var i=0;i<o.length;i++)o[i].Required?o[i].SetInvalidText():o[i].RemoveInvalidText(o[i].Element,"*",!1);return!(t||!e)||this.SetInvalidText()}return!this.Editable||(!(t||!e)||this.SetInvalidText())},SetInvalidText:function(){var e=!0;if(this.Editable&&this.Required){e=!1;for(var t=h(this.Element).find("input"),i=0;i<t.length;i++)if(h(t[i]).is(":checked")){e=!0;break}e?this.RemoveInvalidText(this.Element,"*",!1):this.AddInvalidText(this.Element,"*",!1)}return e},AddCheckboxItem:function(e,t,i){if(t||e){this.IsMobile&&this.MobileAddItem(e,t,i),t=h("<div/>").text(t).html(),e=h("<div/>").text(e).html();var a=h("<div SheetGropName='"+this.SheetGropName+"'></div>"),n=h.MvcSheetUI.NewGuid(),s=h("<input type='checkbox' />").attr("name",this.SheetGropName).attr("id",n).val(e);s.prop("checked",i),this.Editable||s.prop("disabled","disabled");var l=h("<label for='"+n+'\' style="padding-left:3px;padding-right:5px;">'+(t||e)+"</label>");h(this.Element).append(a),a.append(s),a.append(l)}},SaveDataField:function(){var e={};return this.Visiable&&this.Editable?(e[this.DataField]=h.MvcSheetUI.GetSheetDataItem(this.DataField),e[this.DataField]?(e[this.DataField].V=this.GetValue(),e):(-1==this.DataField.indexOf(".")&&alert(SheetLanguages.Current.DataItemNotExists+":"+this.DataField),{})):e}})}(jQuery),function(b){b.fn.SheetComment=function(){return b.MvcSheetUI.Run.call(this,"SheetComment",arguments)},b.MvcSheetUI.Controls.SheetComment=function(e,t,i){this.SignPosition="BeforeComment",this.SignAlign="Center",this.SignHeight=0,this.SignWidth=0,this.CommentFolded=!1;var a=_PORTALROOT_GLOBAL||"/Portal";this.loCalUrl=a,this.SheetAttachmentHandler=a+"/FileUpload/UploadFile",this.FileUpload=b("<input type='file' />").attr("data-attachment",!0),this.Files=0,this.AddAttachments={},this.UploadAttachmentsIds=[],this.ProcessIds=[],this.RomveAttachments=[],this.XHRJson={},this.SchemaCode="",this.NewComment=!1,this.Multiple=!0,this.MaxUploadSizefloat=e.getAttribute("data-maxuploadsize"),b.MvcSheetUI.Controls.SheetComment.Base.constructor.call(this,e,t,i)},b.MvcSheetUI.Controls.SheetComment.Inherit(b.MvcSheetUI.IControl,{Modal:{},ProcessModal:{},Render:function(){if(this.Visiable){b(this.Element).addClass("SheetComment list-group-item SheetCommentShow"),this.InitHistoryComment();this.O.indexOf("E");if(!this.Editable)return this.NullCommentTitleVisible||this.V&&this.V.Comments&&0!==this.V.Comments.length||b("span["+b.MvcSheetUI.PreDataKey+b.MvcSheetUI.DataFieldKey.toLowerCase()+"='"+this.DataField+"']").parent().hide(),void(this.IsMobile&&b(this.Element).parent().hide());this.InitCommentInput(),this.InitFrequentlyUsedCommentsAndSignature()}else this.Element.style.display="none"},RenderMobile:function(){this.Render();var e=b('<div id="commentTitle" class="nav-icon fa bannerTitle fa-chevron-down"></div>'),t=b('<span id="commentTileLabel" style = " float: none !important; padding-right: 8px; padding-left: 4px;"></span>');t.text(SheetLanguages.Current.Comments),t.appendTo(e),e.insertBefore(this.Element),t.unbind("click.show").bind("click.show",this,function(e){b(".tableContent .SheetComment").addClass("hide"),b(".tableContent .SheetComment").hide(),b(".tableContent .SheetComment").hasClass("SheetCommentShow")?(b(".tableContent .SheetComment").hide().removeClass("SheetCommentShow"),b("#commentTitle").removeClass("fa-chevron-down").addClass("fa-chevron-right")):(b("#commentTitle").removeClass("fa-chevron-right").addClass("fa-chevron-down"),b(".tableContent .SheetComment").show().addClass("SheetCommentShow"))}),b(this.Element).closest(".list").appendTo(b("#mobile-content div.scroll"));var i=b(this.Element).closest("div.item");i.css("padding","0").removeClass("item-input");var a=b(this.Element).parent().prev().remove();this.newDivTitle=b("<div class='item item-input item-icon-right'></div>"),this.newDivTitle.append(a),this.newDivTitle.insertBefore(i),b(this.Element).is(":hidden")&&this.newDivTitle.hide()},Validate:function(e,t){if(!this.Editable)return!0;if(t&&this.Required&&!this.GetValue())return this.AddInvalidText(this.Element,"*",!1),!1;if(!e&&this.Required){if(!this.GetValue())return this.AddInvalidText(this.Element,"*"),!1;this.RemoveInvalidText(this.Element)}return!0},ValidateEx:function(e){if(!this.Editable)return!0;if(!e){if(!this.GetValue())return this.AddInvalidText(this.Element,"*"),!1;this.RemoveInvalidText(this.Element)}return!0},GetValue:function(){var e=b(this.CommentInput).val();return b.MvcSheetUI.rejectText=e},_changeSignaturePic:function(e,t){if(t){e.html("<img alt='' border='0' src='"+b.MvcSheetUI.PortalRoot+"/TempImages/"+t+".jpg' />");var i=e.find("img");this.SignWidth&&i.width(this.SignWidth),this.SignHeight&&i.height(this.SignHeight),setTimeout(function(){i.width()>e.width()&&i.width(e.width())},100)}else e.html("")},SetReadonly:function(e){e?(b(this.Element).find("textarea").hide(),b(this.Element).find("select").hide(),b(this.Element).find(":checkbox").hide(),b(this.Element).find("label").hide()):(b(this.Element).find("textarea").show(),b(this.Element).find("select").show(),b(this.Element).find(":checkbox").show(),b(this.Element).find("label").show())},SaveDataField:function(e){var t={};if(!this.Visiable||!this.Editable)return t;if(t[this.DataField]=this.SheetInfo.BizObject.DataItems[this.DataField],!t[this.DataField])return alert(SheetLanguages.Current.DataItemNotExists+":"+this.DataField),{};var i=this.NewComment,a="";if(this.SignatureSel&&(a=this.SignatureSel.val()),void 0===this.MyComment)this.MyComment={CommentID:b.MvcSheetUI.NewGuid(),UserName:SheetLanguages.Current.MyComment,DateStr:(new Date).toString(),Text:this.GetValue(),Avatar:b.MvcSheetUI.SheetInfo.UserImage,SignatureId:a},i=!0,this.AddCommentItem(this.MyComment);else{var n=b("#"+this.MyComment.CommentID);n.find("div.comment-text").html(this.GetValue());var s=n.find("div.comment-signature");this._changeSignaturePic(s,a)}return t[this.DataField].V={CommentID:i?b.MvcSheetUI.NewGuid():this.MyComment.CommentID,Text:this.GetValue(),IsNewComment:i,SetFrequent:!this.IsMobile&&b(this.SaveFrequentCk).is(":checked"),SignatureId:a},t},InitHistoryComment:function(){var e=this;if(this.V&&this.V.Comments)for(var t=!1,i=0;i<this.V.Comments.length;i++)if(!(this.LastestCommentOnly&&i<this.V.Comments.length-1)){var a=this.V.Comments[i];a.IsMyComment&&""===(this.MyComment=a).DelegantName&&this.IsMobile,e.MyComment&&-1!==e.MyComment.Approval&&(e.NewComment=!0),t=0<e.V.Comments.length&&i<e.V.Comments.length-1,void 0!==a.Approval&&-1!==a.Approval&&(this.IsMobile?e.AddMobileCommentItem(a,i==e.V.Comments.length-1):e.AddCommentItem(a,t))}},AddCommentItem:function(e,t){if(void 0===this.PanelBody){var i=b("<div class='widget-comments'></div>");this.IsMobile&&i.hide(),this.DisplayBorder&&i.addClass("bordered"),this.PanelBody=b("<div class='widget-comments-box'></div>"),i.append(this.PanelBody),b(this.Element).prepend(i)}var a=b("<div class='comment'></div>").attr("id",e.CommentID),n=b("<div class='comment-body'></div>");if(this.DisplayHead||n.css("margin-left:3px"),t&&n.addClass("comment-line"),this.DisplayHead){var s=b("<img alt='' src='"+e.Avatar+"' class='comment-avatar' />");a.append(s)}else n.css({"padding-left":0}),n.css({"margin-left":0});var l=e.UserName;this.OUNameVisible&&null!=e.OUName&&(l=e.OUName+" "+l);var h,r;h=e.DateStr;var o="";if(e.toUsers)for(var d in e.toUsers)o=o+","+e.toUsers[d];0<o.length&&(o=o.substring(1));var c="",u=!0;if(e.commentType&&("Sheet__ConsultComment"===e.commentType?(c=b.Lang("SheetComment.Consult"),u=!1):"Sheet__AssistComment"===e.commentType?(c=b.Lang("SheetComment.Assist"),u=!1):"Sheet__ForwardComment"===e.commentType?(c=b.Lang("SheetComment.Forward"),u=!1):"Sheet__AdjustComment"===e.commentType&&(c=b.Lang("SheetComment.Adjust"),u=!1)),u){var p="";1===e.Approval?p=b.Lang("SheetComment.OperateApprove"):0===e.Approval&&(p=b.Lang("SheetComment.OperateReject"))}if(0!=o.length&&""!=c)if(e.isReply)r=b("<div class='comment-by'><a href='javascript:void(0)'>"+l+"</a> "+b.Lang("SheetComment.Feedback")+"  <a href='javascript:void(0)'>"+o+"</a> "+b.Lang("SheetComment.Of")+" [<a href='javascript:void(0)'>"+c+"</a>]</div>");else if(c){var m=e.Activity;r=b("<div class='comment-by'><a href='javascript:void(0)'>"+o+"["+m+"]</a><a href='javascript:void(0)'>"+("[来自"+l+"的"+c+"]")+"</a></div>")}else r=b("<div class='comment-by'><a href='javascript:void(0)'>"+l+"</a> "+b.Lang("SheetComment.Originate")+"  [<a href='javascript:void(0)'>"+c+"</a>], "+b.Lang("SheetComment.Wait")+" <a href='javascript:void(0)'>"+o+"</a> "+b.Lang("SheetComment.Feedback")+"</div>");else r=e.isReply&&e.DelegantName?(l="[来自"+l+"的"+SheetLanguages.Current.Delegant+"]",b("<div class='comment-by'><a href='javascript:void(0)'>"+l+"</a></div>")):e.Adjust?(o="[来自"+o+"的"+SheetLanguages.Current.PlusSign+"]",b("<div class='comment-by'><a href='javascript:void(0)'>"+o+"</a></div>")):e.Forward&&0!=o.length?(o="[来自"+o+"的"+SheetLanguages.Current.Forward+"]",b("<div class='comment-by'><a href='javascript:void(0)'>"+o+"</a></div>")):e.Transfer&&0!=o.length?(o="[来自"+o+"的"+SheetLanguages.Current.Transferred+"]",b("<div class='comment-by'><a href='javascript:void(0)'>"+o+"</a></div>")):b("<div class='comment-by'><a href='javascript:void(0)'>"+l+"</a></div>");e.Activity&&this.ActivityNameVisible&&""===c&&(m=(m=e.Activity).replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\"/g,"&quot;"),e.DelegantName?r.prepend("<a href='javascript:void(0)'>"+e.DelegantName+"["+m+"]</a>"):e.Adjust?r.prepend("<a href='javascript:void(0)'>"+l+"["+m+"]</a>"):e.Forward&&0!=o.length?r.prepend("<a href='javascript:void(0)'>"+l+"["+m+"]</a>"):e.Transfer&&0!=o.length?r.prepend("<a href='javascript:void(0)'>"+l+"["+m+"]</a>"):r.append("[<a href='javascript:void(0)'>"+m+"</a>]"));e.Text=b("<div/>").text(e.Text).html();var f=b("<div class='comment-text' >"+e.Text.replace(/\n/g,"<br>")+"</div>");if("NOTEXIT"==e.Text&&(f=""),u){var v=e.Text;v&&""!==v.trim()||(1===e.Approval?f=b("<div class='comment-text'>"+b.Lang("SheetComment.Approve")+"</div>"):0===e.Approval&&(f=b("<div class='comment-text'>"+b.Lang("SheetComment.Reject")+"</div>")))}if(this.IsMobile||this.DateNewLine)r.append('<div style="padding-left:5px;">'+h+"</div>");else{var g=p||"";r.append('<span style="padding-left:5px;">'+h+"</span>"),r.append(b("<span class='approval-action'>"+g+"</span>"))}if("Sheet__TransferComment"===e.commentType&&(r=b("<div class='comment-by'><a href='javascript:void(0)'>"+l+"</a><span style='font-weight: bold'> 转派给</span><a href='javascript:void(0)'>"+e.transferName+'</a> <span style="padding-left:5px;">'+h+"</span>")),this.SignPosition&&"BeforeComment"==this.SignPosition?(n.append(r),n.append(f)):(n.append(f),r.css("text-align","right"),n.append(r)),"Sheet__TransferComment"===e.commentType){0<e.circulaters.length&&(copyTo="",b(e.circulaters).each(function(e){copyTo+=0==e?"<a href='javascript:void(0)' style='padding: 0 5px;'>"+this+"</a>":"<a href='javascript:void(0)' style='padding: 0 5px;'>,"+this+"</a>"}),n.append("<div style='margin-bottom:10px'><span style='font-weight: bold;'>抄送:</span>"+copyTo+"</div>")),1==e.noticeFlag&&"已沟通客户";var S=b("<div><span class='attachment'></span></div>");S.find(".attachment").SheetAttachment({AllowBatchDownload:!0,FileExtensions:"",L:24,MaxUploadSize:10,N:"附件",O:"VM",RowNum:0,Type:"SheetAttachment",V:e.attachments}),n.append(S)}a.append(n);var I=b("<div class='comment-signature' style='text-align:"+this.SignAlign+";'></div>");n.append(I),this.DisplaySign&&e.SignatureId&&this._changeSignaturePic(I,e.SignatureId),this.PanelBody.append(a)},AddMobileCommentItem:function(e,t){},InitCommentInput:function(){var e=b("<div class='comment-box'></div>"),t=b("<span class='comment-box-tag'><span class='comment-box-tag-inner'></span></span>"),i=b("<p class='text-length'><span>0</span>/2000</p>");if(this.CommentInput=b("<textarea class='comment-textarea' onchange=\"this.value=this.value.substring(0,2000)\" style='padding-bottom: 15px' maxlength='2000' placeholder='同意'></textarea>").width(this.Width),this.IsMobile){e.addClass("InputPanel item hidden-Mobile"),b("span[data-datafield = "+this.DataField+"]").remove();var a=b("<div class='IPtitle'></div>");a.text("输入"+this.N),e.append(a),this.CommentInput=b("<textarea class='comment-textarea CommentInput' rows='4' placeholder='同意'></textarea>")}else e.append(t),e.append(i);this.MyComment&&-1===this.MyComment.Approval?this.CommentInput.val(this.MyComment.Text):this.CommentInput.val(this.DefaultComment),e.append(this.CommentInput),b(this.Element).append(e);var n=this,s=0;if(b(this.CommentInput).unbind("change.CommentInput").bind("change.CommentInput",this,function(e){e.data.Validate.apply(e.data),s=e.target.value.length,b(n.CommentInput).siblings(".text-length").children("span").html(s),b.MvcSheetUI.rejectText=e.target.value}),b(this.CommentInput).keyup(function(e){s=e.target.value.length,b(n.CommentInput).siblings(".text-length").children("span").html(s)}),b(this.CommentInput).keydown(function(e){s=e.target.value.length,b(n.CommentInput).siblings(".text-length").children("span").html(s)}),this.IsMobile){var l=b(this.CommentInput),h=b.MvcSheetUI.IonicFramework;b(this.CommentInput).focus(function(){var e=this,t=h.$ionicPlatform.is("ios"),i=h.$ionicScrollDelegate.$getByHandle("mainScroll").getScrollPosition().top,a=h.$ionicPosition.offset(l).top/3+i,n=b(".view-container").find(".scroll");t&&h.$timeout(function(){e.scrollIntoView(!0),n.css("transform","translate3d(0px,-"+a+"px, 0px) scale(1)"),h.$ionicLoading.show({template:"loading"}),h.$timeout(function(){h.$ionicLoading.hide()},100)},400)})}},InitFrequentlyUsedCommentsAndSignature:function(){var e,t,i,n=this,s=b.MvcSheetUI.IonicFramework,a=b("<div class='select-comment'></div>").width(this.Width).css({"text-align":"right",margin:"10px 0 15px 0","min-height":"30px"}),l=b("<div></div>").width(this.Width).css({"text-align":"right","margin-top":"3px"});if(n.IsMobile&&((a=b("<div></div>")).addClass("item item-input LatestCommentPanel hidden-Mobile"),(i=b("<div></div>")).addClass("item item-input SignaturePanel"),b(this.Element).append(i),this.Element.dataset.displaysign||i.hide()),b(this.Element).append(a),b(this.Element).append(l),this.FrequentCommentVisible)if(this.IsMobile){b("<span class='input-label'>"+SheetLanguages.Current.FreComments+"</span>").appendTo(a);var h=b("<div class='detail item-icon-right'><span class='input-label'>"+SheetLanguages.Current.PleaseSelectComment+"</span><i class='icon ion-ios-arrow-right'></i></div>").appendTo(a);s.$scope.frequentCommentIndex=-1,a.unbind("click.chooseComments").bind("click.chooseComments",function(e){s.$ionicModal.fromTemplateUrl("Mobile/form/templates/radio_popover2.html?v=201909201706",{scope:s.$scope}).then(function(a){a.scope.header=SheetLanguages.Current.FreComments,a.scope.data={};var e=s.$scope.frequentCommentIndex;a.scope.data.RadioListValue=e,a.scope.RadioListDisplay=n.V.FrequentlyUsedComments,a.show(),a.scope.hide=function(){a.hide()},a.scope.reset=function(){popoverScope=this.$parent;var e=popoverScope.RadioListDisplay;if(0<e.length)popoverScope.data.RadioListValue=-1,n.CommentInput.val(""),h.find("span").text(SheetLanguages.Current.PleaseSelect);else{var t=e[0].id,i=e[0].SignatureImg;popoverScope.radioValue=t,f.val(t),f.parents(".SignaturePanel").find(".detail.item-icon-right").html("<img src="+i+" />")}},a.scope.clickRadio=function(e,t){n.CommentInput.val(e),a.scope.data.textValue=e;var i=a.scope.data.textValue||SheetLanguages.Current.hasBeenSelected;h.find("span").text(i),n.Validate(),s.$scope.frequentCommentIndex=t},a.scope.searchFocus=!1,a.scope.searchAnimate=function(){""==a.$el.find("ion-header-bar").eq(1).find("input").val()&&(a.scope.searchFocus=!a.scope.searchFocus)},a.scope.searChange=function(){a.scope.searchNum=b(".active .popover .list").children("label").length}})})}else{if((e=b("<select  style='max-width:100%' class='select-comment-inner'></select>")).css({width:"83%",float:"left"}),e.append("<option value=''>--"+SheetLanguages.Current.SelectComment+"--</option>"),this.V&&this.V.FrequentlyUsedComments)for(var r=0;r<this.V.FrequentlyUsedComments.length;r++){var o=this.V.FrequentlyUsedComments[r];null!=o&&18<o.length&&(o=o.substring(0,18)+"..."),o=b("<div/>").text(o).html();var d=b("<option value='"+this.V.FrequentlyUsedComments[r]+"'>"+o+"</option>");e.append(d)}b(e).unbind("change.LatestCommentSel").bind("change.LatestCommentSel",this,function(e){if(0<b(this).val().length){e.data.CommentInput.val(b(this).val());var t=b(this).val().length?b(this).val().length:0;b(n.CommentInput).siblings(".text-length").children("span").html(t),e.data.Validate()}}),a.append(e)}if(this.FrequentSettingVisible&&!this.IsMobile){var c=b.MvcSheetUI.NewGuid();t=b("<div class='pretty p-default'></div>").css({"margin-top":"7px","margin-left":"10px"}),this.SaveFrequentCk=b("<input type='checkbox' id='"+c+"' lay-skin='primary' />");var u=b("<label type='checkbox' for='"+c+"'>"+SheetLanguages.Current.FrequentlyUsedComment+"</label>");u.css("cursor","pointer"),t.append(this.SaveFrequentCk),t.append(u),a.append(t),e&&e.width("80%")}if(this.DisplaySign){var p,m=b.MvcSheetUI.SheetInfo.MySignatures;if(m)for(r=0;r<m.length;r++)if(m[r].IsDefault){p=m[r];break}if(this.IsMobile){var f;if(b('<span class="input-label">'+SheetLanguages.Current.Signature+"</span>").appendTo(i),b("<div class='detail item-icon-right'><span>"+SheetLanguages.Current.PleaseSelect+"</span><i class='icon ion-ios-arrow-right'></i></div>").appendTo(i),(f=b('<input type="text" style="display:none;"></input>')).appendTo(i),p&&p.SignatureID)f.val(p.SignatureID),i.find(".detail").html("<img src="+b.MvcSheetUI.PortalRoot+"/TempImages/"+p.SignatureID+".jpg />");this.MyComment&&f.parents(".SignaturePanel").find(".detail .input-label").html("<img src="+b.MvcSheetUI.PortalRoot+"/TempImages/"+this.MyComment.SignatureId+".jpg />")}else{if((f=b("<select></select>").css({"margin-left":"20px"})).append("<option value=''>--"+SheetLanguages.Current.SelectSign+"--</option>"),m){r=0;for(var v=m.length;r<v;r++){var g=m[r];g.Name=b("<div/>").text(g.Name).html();d=b("<option title='"+g.Name+"' value='"+g._ObjectID+"'>"+(18<g.Name.length?g.Name.substring(0,18)+"...":g.Name)+"</option>");f.append(d),g.IsDefault&&f.val(g._ObjectID)}1==m.length&&f.val(m[0]._ObjectID),n._changeSignaturePic(l,f.val())}b(f).unbind("change.signatureSel").bind("change.signatureSel",function(){n._changeSignaturePic(l,b(this).val())}),a.append(f),this.MyComment&&(f.val(this.MyComment.SignatureId),f.trigger("change")),f.width("20%"),e&&e.width("55%")}}f&&(this.SignatureSel=f)}})}(jQuery),function(a){a.fn.SheetCountLabel=function(){return a.MvcSheetUI.Run.call(this,"SheetCountLabel",arguments)},a.MvcSheetUI.Controls.SheetCountLabel=function(e,t,i){a.MvcSheetUI.Controls.SheetCountLabel.Base.constructor.call(this,e,t,i)},a.MvcSheetUI.Controls.SheetCountLabel.Inherit(a.MvcSheetUI.IControl,{Render:function(){if(arguments){var e=arguments[0];if(null==e)return;this.FormatRule?this.GetFromatValue(a(this.Element),e):a(this.Element).text(Number(e).toFixed(2))}}})}(jQuery),function(p){p.fn.SheetDropDownList=function(){return p.MvcSheetUI.Run.call(this,"SheetDropDownList",arguments)},p.MvcSheetUI.Controls.SheetDropDownList=function(e,t,i){this.FilterValue="",this.FilterDataFields=[],this.ParentFilterDataFields=[],p.MvcSheetUI.Controls.SheetDropDownList.Base.constructor.call(this,e,t,i)},p.MvcSheetUI.Controls.SheetDropDownList.Inherit(p.MvcSheetUI.IControl,{Render:function(){var a=p(this.Element),n=this.V,s=this;if(!this.Visiable)return a.hide(),void(a.find("option").length<=0&&a.append('<option value=""></option>'));this.Editable?this.Queryable&&!this.IsMobile&&a.select2({placeholder:this.EmptyItemText,minimumResultsForSearch:-1}):a.hide(),this.TrackVisiable&&!this.Originate&&-1==this.DataField.indexOf(".")&&this.RenderDataTrackLink();var e=a.children("option");if(""!=this.SchemaCode.trim()){var t=this._createFilter();0<this.ParentFilterDataFields.length&&p.MvcSheetUI.Loading;var l=JSON.stringify([this.SchemaCode,this.QueryCode,t,this.DataTextField,this.DataValueField]);if(this.SetEmpty(),this.SetEmptyItem(),p.MvcSheetUI.CacheData&&p.MvcSheetUI.CacheData[l]){var i=p.MvcSheetUI.CacheData[l];if("[object Array]"==Object.prototype.toString.call(i))for(var h in i){var r=i;a.find("option[value='"+r[h].key.replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\"/g,"&quot;").replace(/\'/g,"&apos;")+"']")&&0!=a.find("option[value='"+r[h].key.replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\"/g,"&quot;").replace(/\'/g,"&apos;")+"']").length||(s.IsMobile&&s.AddMobileItem(r[h].key,r[h].value,!1),r[h].value&&(r[h].value=r[h].value.replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\"/g,"&quot;"),a.append('<option value="'+r[h].key.replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\"/g,"&quot;")+'">'+r[h].value+"</option>")))}else for(var o in i)o+="",this.IsMobile&&this.AddMobileItem(o,i[o+""],!1),i[o+""]=i[o+""].replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\"/g,"&quot;").replace(/\'/g,"&apos;"),a.append('<option value="'+p("<div/>").text(o).html()+'">'+i[o+""]+"</option>");this._selectItem(a,n),this.IsMobile&&s.Editable&&this.ionicInit(p.MvcSheetUI.IonicFramework)}else{var d=!1;for(var c in t)if(t[c]){d=!0;break}this.Filter&&!d||p.MvcSheet.GetSheet({Command:"GetBizServiceData",Param:l},function(e){if(p.MvcSheetUI.CacheData||(p.MvcSheetUI.CacheData={}),null==e.Successful||e.Successful){if(p.MvcSheetUI.CacheData[l]=e,"[object Array]"==Object.prototype.toString.call(e))for(var t in e)a.find("option[value='"+e[t].key.replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\"/g,"&quot;").replace(/\'/g,"&apos;")+"']")&&0!=a.find("option[value='"+e[t].key.replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\"/g,"&quot;").replace(/\'/g,"&apos;")+"']").length||(s.IsMobile&&s.AddMobileItem(e[t].key,e[t].value,!1),e[t].value&&(e[t].value=e[t].value.replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\"/g,"&quot;"),a.append('<option value="'+e[t].key.replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\"/g,"&quot;")+'">'+e[t].value+"</option>")));else for(var i in e)i+="",a.find("option[value='"+i.replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\"/g,"&quot;").replace(/\'/g,"&apos;")+"']")&&0!=a.find("option[value='"+i.replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\"/g,"&quot;").replace(/\'/g,"&apos;")+"']").length||(s.IsMobile&&s.AddMobileItem(i,e[i],!1),e[i]&&(e[i]=e[i].replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\"/g,"&quot;"),a.append('<option value="'+i.replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\"/g,"&quot;")+'">'+e[i]+"</option>")));s._selectItem(a,n),s.IsMobile&&s.Editable&&s.ionicInit(p.MvcSheetUI.IonicFramework)}else;},null,-1==this.DataField.indexOf("."))}this.FilterValue=l}else if(""!=this.MasterDataCategory.trim()){this.SetEmpty(),this.SetEmptyItem();l=JSON.stringify([this.MasterDataCategory]);if(p.MvcSheetUI.CacheData&&p.MvcSheetUI.CacheData[l]){i=p.MvcSheetUI.CacheData[l];for(var o in i)this.IsMobile&&this.AddMobileItem(i[o].Code,i[o].EnumValue,!1),i[o].Code=p("<div/>").text(i[o].Code).html(),i[o].EnumValue=p("<div/>").text(i[o].EnumValue).html(),a.append('<option value="'+i[o].Code+'"'+(i[o].IsDefault?' selected="selected"':"")+">"+i[o].EnumValue+"</option>");this._selectItem(a,n),this.IsMobile&&this.Editable&&this.ionicInit(p.MvcSheetUI.IonicFramework)}else p.MvcSheet.PostSheet({Command:"GetMetadataByCategory",Param:l},function(e){if(e){p.MvcSheetUI.CacheData||(p.MvcSheetUI.CacheData={});for(var t=0,i=(p.MvcSheetUI.CacheData[l]=e).length;t<i;t++)s.IsMobile&&s.AddMobileItem(e[t].Code,e[t].EnumValue,!1),e[t].Code=e[t].Code.replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\"/g,"&quot;"),e[t].EnumValue=e[t].EnumValue.replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\"/g,"&quot;"),a.append('<option value="'+e[t].Code+'"'+(e[t].IsDefault&&!s.DisplayEmptyItem?' selected="selected"':"")+">"+e[t].EnumValue+"</option>")}s._selectItem(a,n),s.IsMobile&&s.Editable&&s.ionicInit(p.MvcSheetUI.IonicFramework)},null,-1==this.DataField.indexOf("."))}else if(""!=this.DefaultItems.trim()){this.SetEmptyItem();var u=this.DefaultItems.split(";");for(h=0;h<u.length;h++)this.IsMobile&&this.AddMobileItem(u[h],u[h],!1),u[h]=p("<div/>").text(u[h]).html(),a.append('<option value="'+u[h]+'">'+u[h]+"</option>");this._selectItem(a,n),this.IsMobile&&this.Editable&&this.ionicInit(p.MvcSheetUI.IonicFramework)}else this.SetEmptyItem(),e&&0<e.length&&(a.append(e),a.val(a.children(":eq(0)").val()),this._selectItem(a,n));a.unbind("change.SheetDropDownList").bind("change.SheetDropDownList",function(){s.TextDataField&&p.MvcSheetUI.SetControlValue(s.TextDataField,s.GetText(),s.RowNum),s.Validate(),s.OnChange&&s.RunScript(this,s.OnChange)})},AddMobileItem:function(e,t,i){var a={DataField:this.DataField,Value:e,Text:t};this.MobileOptions.push(a)},ionicInit:function(t){var i=this;if(p(this.Element.parentElement).unbind("click.showChoice").bind("click.showChoice",function(e){t.$ionicModal.fromTemplateUrl("Mobile/form/templates/radio_popover.html?v=201909201706",{scope:t.$scope}).then(function(e){if(e.scope.header=i.N,e.scope.RadioListDisplay=[],e.scope.Queryable=i.Queryable,i.DisplayEmptyItem&&i.EmptyItemText){var t={DataField:i.DataField,Value:"",Text:i.EmptyItemText};e.scope.RadioListDisplay.push(t)}e.scope.RadioListDisplay=e.scope.RadioListDisplay.concat(i.MobileOptions),e.scope.RadioListValue=i.GetValue(),e.show(),0==i.Queryable&&p("#content").css("top","40px"),e.scope.hide=function(){e.hide()},e.scope.clickRadio=function(e,t){i.SetValue(e),t=t.replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\"/g,"&quot;"),p(i.Mask).html(t)},e.scope.searchFocus=!1,e.scope.searchAnimate=function(){e.scope.searchFocus=!e.scope.searchFocus}})}),i.IsMobile){var e=i.GetText();i.Editable?(i.Mask.html(e),p(i.Mask).css({color:"#2c3038"})):p(i.Element).html(e)}},SetEmptyItem:function(){if(this.DisplayEmptyItem){""==this.EmptyItemText&&(this.EmptyItemText=" ");var e=this.EmptyItemText.replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\"/g,"&quot;");p(this.Element).append('<option value="">'+e+"</option>")}},SetEmpty:function(){p(this.Element).empty(),0<p("#s2id_"+p(this.Element).attr("id")).length&&p("#s2id_"+p(this.Element).attr("id")).find(".select2-chosen").html(""),1==p(this.element).find("div[class='afFakeSelect']").length&&$element.parent().find("div[class='afFakeSelect']").html("")},SetValue:function(e){if(p(this.Element).val(e),this.Queryable){var t=p(this.Element).find("option:selected").text();p("#s2id_"+this.Element.id).find(".select2-chosen").html(t),1==p(this.Element).parent().find("div[class='afFakeSelect']").length&&p(this.Element).parent().find("div[class='afFakeSelect']").html(t)}p(this.Element).trigger("change")},GetValue:function(){var e=p(this.Element).val()||p(this.Element).find("option:selected").val();return this.IsMobile&&!e&&(e=this.DataItem.V),e},_createFilter:function(){var e=this,t={};if(this.Filter){var i=this.Filter.split(","),a={};if(i)for(var n=0;n<i.length;n++)if(i[n]&&2==i[n].split(":").length){var s=i[n].split(":")[0],l=i[n].split(":")[1],h=p.MvcSheetUI.GetElement(s,e.GetRowNumber());if(h){h.unbind("change."+this.DataField+e.GetRowNumber()).bind("change."+this.DataField+e.GetRowNumber(),function(){p.MvcSheetUI.Loading||(e.IsMobile?e.RenderMobile():e.Render())});var r=(a[s]=h).SheetUIManager();if(r&&r instanceof p.MvcSheetUI.Controls.SheetDropDownList){for(var o in r.FilterDataFields)this.ParentFilterDataFields.push(r.FilterDataFields[o]);for(var o in r.ParentFilterDataFields)this.ParentFilterDataFields.push(r.FilterDataFields[o])}t[l]=p.MvcSheetUI.GetControlValue(s,e.GetRowNumber())}else document.getElementById(s)?(p("#"+s).unbind("change."+this.DataField+e.GetRowNumber()).bind("change."+this.DataField+e.GetRowNumber(),function(){p.MvcSheetUI.Loading||e.Render()}),t[l]=p("#"+s).val()):t[l]=s;this.FilterDataFields.push(s)}for(var d in a)-1<this.ParentFilterDataFields.indexOf(d)&&a[d].unbind("change."+this.DataField+e.GetRowNumber())}return t},_selectItem:function(e,t){if(""!=(t=t||this.SelectedValue)&&e.val(t),0==e.find("option:selected").length&&0<e.find("option").length&&(e.find("option")[0].selected=!0),1==e.parent().find("div[class='afFakeSelect']").length){var i=e.find("option:selected").text();e.parent().find("div[class='afFakeSelect']").html(i)}if(e.trigger("change"),!this.Editable){var a=e.parent().find("#myselecttext");if(0<a.length)a.text(this.GetText());else{var n=this.GetText();n=n.replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\"/g,"&quot;"),e.after("<label id='myselecttext' for='"+e.attr("id")+"' style='width:100%;'>"+n+"</label>")}}},RenderMobile:function(){this.MobileOptions=[],this.Render(),this.Editable?(this.MoveToMobileContainer(),this.pupIcon=p("<i class='icon ion-ios-arrow-right'></i>").insertAfter(this.Mask),p(this.Element).closest("div.item").addClass("item-icon-right"),p(this.Element).hide()):p(this.Element).addClass(this.Css.Readonly)},GetText:function(){return p(this.Element).children("option:selected").text()},SaveDataField:function(){var e={};if(!this.Visiable||!this.Editable)return e;if(this.DataField){var t=p.MvcSheetUI.GetSheetDataItem(this.DataField,this.GetRowNumber());if(t){var i=p(this.Element).val();e[this.DataField]=t,e[this.DataField].V=i}else alert(SheetLanguages.Current.DataItemNotExists+":"+this.DataField)}return e}})}(jQuery),function(S){var g=[];S.fn.SheetGridView=function(){return S(this).find(".template>*[data-datafield]").children().each(function(){var e=S(this).attr("data-datafield");S(this).removeAttr("data-datafield").attr("data-field",e)}),S(this).find("td[data-datafield]").each(function(){S(this).attr("data-field",S(this).attr("data-datafield")),S(this).removeAttr("data-datafield")}),S.MvcSheetUI.Run.call(this,"SheetGridView",arguments)},S.MvcSheetUI.Controls.SheetGridView=function(e,t,i){this.pageIndex=0,this.loadNum=10,this.dataContainerDivHeight=0,this.originateValue=null,S.MvcSheetUI.Controls.SheetGridView.Base.constructor.call(this,e,t,i)},S.MvcSheetUI.Controls.SheetGridView.Inherit(S.MvcSheetUI.IControl,{Render:function(){this.loadNum=this.VirtualPageNum,this.Visiable?(this.HtmlRender(),this._BindEvents(),this.SetValue(),this.SetVisible(),this.OnRendered&&this.RunScript(this,this.OnRendered,arguments)):this.VirtualPaging?S(this.Element).parent().hide():S(this.Element).hide()},_BindEvents:function(){S(this.addbtn).unbind("click").bind("click",[this],function(e){null!=e.data[0]._AddNewRow()&&e.data[0]._AddNewRow().apply(this,!0)}),S(this.clearbtn).unbind("click").bind("click",[this],function(e){null!=e.data[0]._Clear()&&e.data[0]._Clear().apply(this,arguments)}),S(this.exportbtn).unbind("click").bind("click",[this],function(e){e.data[0]._Export.apply(e.data[0],arguments)}),S(this.importbtn).find("a").unbind("click").bind("click",[this],function(e){e.data[0]._Import.apply(e.data[0],arguments)})},SetVisible:function(){if(this.VirtualPaging){var e=S(this.Element).height();e<S(this.Element).parent().parent().height()&&(S(this.Element).parent().css("height",e+60+"px"),S(this.Element).parent().parent().css("height",e+150+"px"))}if(this.V.R&&1==this.V.R.length&&(this.IsEmptyRow(S(this.Element).find("tr.rows:first"))||this.Originate)&&0<this.DefaultRowCount)for(var t=0;t<this.DefaultRowCount-1;t++)this._AddRow();if(this.DisplayAdd&&this.L!=S.MvcSheetUI.LogicType.BizObject&&this.Editable||S(this.addbtn).css("display","none"),this.DisplayExport&&this.L!=S.MvcSheetUI.LogicType.BizObject||S(this.exportbtn).css("display","none"),this.DisplayImport&&this.L!=S.MvcSheetUI.LogicType.BizObject&&this.Editable||S(this.importbtn).css("display","none"),this.DisplayClear&&this.L!=S.MvcSheetUI.LogicType.BizObject&&this.Editable||S(this.clearbtn).css("display","none"),this.DisplayInsertRow&&this.L!=S.MvcSheetUI.LogicType.BizObject&&this.Editable&&!this.VirtualPaging||S(this.Element).find("a.insert").css("display","none"),this.DisplayDelete&&this.L!=S.MvcSheetUI.LogicType.BizObject&&this.Editable||S(this.Element).find("a.delete").css("display","none"),(!this.DisplayInsertRow&&!this.DisplayDelete||!this.Editable)&&this.L!=S.MvcSheetUI.LogicType.BizObject){if(1<S(this.template).length){var i=S(S(this.template)[0]).find("td").length;S(this.Element).find("tr").each(function(e){S(this).find("td").length==i&&0<S(this).find("td:last").find("a.delete").length&&S(this).find("td:last").css("display","none")})}else S(this.Element).find("tr[data-row]").each(function(e){S(this).find("td:last").css("display","none")});S(this.Element).find("tr:first").find("td:last").css("display","none"),S(this.Element).find("tr.footer").find("td:last").css("display","none"),this.VirtualPaging&&S(S(this.Element).parent().parent().find("tr.header")).find("td.rowOption").hide()}if(!this.DisplaySequenceNo){if(1<S(this.template).length){i=S(S(this.template)[0]).find("td").length;S(this.Element).find("tr").each(function(e){S(this).find("td").length==i&&S(this).find("td:first").css("display","none")})}else S(this.Element).find("tr").each(function(e){S(this).find("td:first").css("display","none")});this.VirtualPaging&&S(S(this.Element).parent().parent().find("tr.header")).find("td:first").hide()}if(this.DisplaySummary&&this.L!=S.MvcSheetUI.LogicType.BizObject){var a=S(this.template).find("td"),n=!1;for(t=0;t<a.length;t++)this.GetSummaryTd(a[t])&&(this._Summary(S(a[t]).children()),n=!0);n||S(this.Summary).css("display","none")}else S(this.Summary).css("display","none");a=S(this.Element).find("td");this.VirtualPaging&&(a=S(this.Element).parent().parent().find("td"));for(t=0;t<a.length;t++){var s=S(a[t]).attr("data-field");if(s){var l=S.MvcSheetUI.GetSheetDataItem(s,1);l&&l.O.indexOf("V")<0&&S(a[t]).css("display","none")}}this.VirtualPaging&&this._SetVirtualPagingContainerHeight()},GetSummaryTd:function(e){var t=S(e).attr("data-field");if(t){var i=S.MvcSheetUI.GetSheetDataItem(t,1);if(i&&(i.L==S.MvcSheetUI.LogicType.Int||i.L==S.MvcSheetUI.LogicType.Double||i.L==S.MvcSheetUI.LogicType.Long))return!0}return!1},_Summary:function(e){for(var t,i=S(e).closest("td").attr("data-field"),a=S(this.Summary).find("label"),n=0;n<a.length;n++)S(a[n]).attr("data-datafield")==i&&(t=S(a[n]));var s=0,l=0,h=new Array,r=S(this.Element).find("tr.rows").find("td");for(n=0;n<r.length;n++)if(S(r[n]).attr("data-field")==i){var o=S(r[n]).children().text()||S(r[n]).children().val()||"0",d=o;isNaN(o)&&(d=parseFloat(o.replace(/,/g,"").replace(/$/g,"").replace(/¥/g,""))),l+=parseFloat(d),s++,h.push(d)}var c=Math.max.apply(Math,h),u=Math.min.apply(Math,h);if(!isNaN(l)){var p=S(t).SheetCountLabel();if(p&&p.StatType)switch(p.StatType){case"SUM":p.Render(l);break;case"AVG":p.Render((l/s).toFixed(2));break;case"MAX":p.Render(c);break;case"MIN":p.Render(u)}}},_SummaryOTher:function(e){var t=S(e).attr(S.MvcSheetUI.PreDataKey+S.MvcSheetUI.DataFieldKey);if(t){for(var i=S(e).parent(),a=0;!(i.is("tr")||(i=i.parent(),10<++a)););var n=i.find("input[data-computationrule*='{"+t+"}'],label[data-computationrule*='{"+t+"}'],span[data-computationrule*='{"+t+"}']");if(0<n.length)for(a=0;a<n.length;a++)this._Summary(n[a])}},GetText:function(){return(this.IsMobile?S(this.Element).find("ul.list").length-1:S(this.Element).find("tr.rows").length)+SheetLanguages.Current.Records},GetValue:function(){var e=new Array,t={};if(this.IsMobile){var i=this.MobileRows;if(i)for(var a=0;a<i.length;a++){if((c=i[a]).id=c.RowControl.attr("id"),c){for(var n=c.Editors,s=0;s<n.length;s++){var l=n[s];if(l){var h=l.DataField;if(h)if("SheetTimeSpan"==l.Type){var r=l.GetValue();r=r.replace("$","."),t[h.split(".")[1]]=r}else t[h.split(".")[1]]=l.GetValue()}}c.id&&(t.ObjectID=c.id),e.push(t),t={}}}}else{var o=S(this.Element).find("tr.rows"),d=S(this.Element).attr("id");S(this.Element).attr("data-datafield");if(1<this.template.length)for(a=0;a<o.length;a+=this.template.length){for(var c=o[a],u=S(c).attr("data-row"),p=S("#"+d+" tr[data-row='"+u+"']"),m=0;m<p.length;m++)t=arguments&&arguments[0]?this.GetRowValue(p[m],t,arguments[0]):this.GetRowValue(p[m],t);null!=this.OnEditorSaving&&this.RunScript(this,this.OnEditorSaving,[p,t]),e.push(t),t={}}else for(a=0;a<o.length;a++){c=o[a];t=arguments&&arguments[0]?this.GetRowValue(c,t,arguments[0]):this.GetRowValue(c,t),null!=this.OnEditorSaving&&this.RunScript(this,this.OnEditorSaving,[S(c),t]),e.push(t),t={}}}return e},GetRowValue:function(e,t,i){if(!this.IsEmptyRow(e)||this.V&&this.V.R&&0<this.V.R.length||this.L==S.MvcSheetUI.LogicType.BizObject){for(var a=S(e).find("td"),n=0;n<a.length;n++){var s=a[n],l=S(s).find("[data-datafield]"),h=l.attr("data-datafield");if(null!=h)if(i){var r=S.MvcSheetUI.GetSheetDataItem(h,1);if(r&&r.L==S.MvcSheetUI.LogicType.Attachment){for(var o=l.find("table").find("tr"),d="",c=0;c<o.length;c++)d+=S(o[c]).find("td:first").find("div").html()+";";t[h.split(".")[1]]=d}else t[h.split(".")[1]]=null!=l.SheetUIManager()?""==l.SheetUIManager().GetValue()?l.SheetUIManager().V:l.SheetUIManager().GetValue():r.V}else l.SheetUIManager(S(e).attr("data-row"))&&(t[h.split(".")[1]]=l.SheetUIManager(S(e).attr("data-row")).GetValue())}null!=S(e).attr("id")&&(t.ObjectID=S(e).attr("id"))}return t},IsEmptyRow:function(e){var t="",i=S(e).attr("data-row");return S(e).find("td").each(function(){if(S(this).children().SheetUIManager(i))if("SheetAttachment"==S(this).children().attr("class")){var e=S(this).children().SheetUIManager(i).GetValue();""==e.AttachmentIds&&""==e.DelAttachmentIds||(t+="1")}else t+=S(this).children().SheetUIManager(i).GetValue()}),""==t||""==t.replace("0","")},SetValue:function(o){this.VirtualPaging&&!this.IsMobile?(this._SetValueByPage(0,this.loadNum,null),S(this.Element.parentElement).unbind("scroll.horizontal").bind("scroll.horizontal",[this],function(e){var t=S(this).scrollLeft();S(this.parentElement).find(".SheetGridViewTitle").scrollLeft(t)}),S(this.Element.parentElement).unbind("scroll.PageShow").bind("scroll.PageShow",[this],function(e){var t=S(this).height(),i=S(this).find("table[data-type='SheetGridView']").height(),a=S(this).scrollTop(),n=Math.ceil(i/t);if((n-2)/n<a/Number(i)){!0;var s=e.data[0].pageIndex,l=e.data[0].loadNum,h=s*l,r=(s+1)*l;e.data[0]._SetValueByPage(h,r,o)}})):this._SetValueByPage(0,-1,o)},_SetValueByPage:function(e,t,i){this.V.T&&(this.DefaultRow=this.V.T);var a=i;if(this.L==S.MvcSheetUI.LogicType.BizObjectArray?a=a||this.V.R:this.L==S.MvcSheetUI.LogicType.BizObject&&(a=a||this.V),a&&(-1==t&&(t=a.length),!(this.Originate&&this.DefaultRowCount<1)))if(this.L==S.MvcSheetUI.LogicType.BizObjectArray){if(e<a.length){for(var n=e;n<t;n++){var s=a[n];if(null!=s){var l=S(this.Element).attr("data-datafield")+".ObjectID";this.IsMobile?this._AddMobileRow(s.DataItems[l].V):this._AddRow(s.DataItems[l].V)}}this.pageIndex+=1}if(t>=a.length){if(this.IsMobile)return!0;this.Element.parentElement.removeAttribute("scroll"),S(this.Element.parentElement).unbind("scroll.PageShow")}}else if(this.L==S.MvcSheetUI.LogicType.BizObject)if(this.IsMobile)this._AddMobileRow();else{this.newRow=S(this.Element).find("tr.template").removeClass("template").addClass("rows").attr("data-row","1");l=this.V.DataItems[S(this.Element).attr("data-datafield")+".ObjectID"].V;S(this.newRow).attr("id",l),S(this.newRow).find("td").each(function(){var e=S(this).find("[data-field]"),t=S(e).attr("data-field");S(e).removeAttr("data-field").attr("data-datafield",t).attr("data-row","1"),S(e).SheetUIManager(1)})}},HtmlRender:function(){this.VirtualPaging&&this._RenderVirtualPagingContainer(),this.ButtonId=this.DataField+"_"+Math.floor(1e3*Math.random()),this.RowCount=0,this.RowNum=0,this.template=S(this.Element).find("tr.template"),S(this.Element).parent().css("overflow","auto");this.template.find("td");this.Summary=S(this.Element).find("tr.footer");var e=S("<div></div>").css("width","100%");this.addbtn=S("<div><a id='Add_"+this.ButtonId+"'>"+SheetLanguages.Current.Add+"</a></div>").css("width","8%").css("float","left").css("padding-top","3px"),this.clearbtn=S("<div><a id='Clear_"+this.ButtonId+"'>"+SheetLanguages.Current.Clear+"</a></div>").css("width","8%").css("float","left").css("padding-top","3px"),this.importbtn=S("<div><input id='importExcel_"+this.ButtonId+"' name='importExcel' type='file' style='width:60%' /><a id='Import_"+this.ButtonId+"'>"+SheetLanguages.Current.Import+"</a></div>").css("float","left"),this.exportbtn=S("<div><a id='Export_"+this.ButtonId+"'>"+SheetLanguages.Current.Export+"</a></div>").css("width","8%").css("float","left").css("padding-top","3px"),e.append(this.addbtn).append(this.clearbtn).append(this.exportbtn).append(this.importbtn),this.VirtualPaging?S(this.Element).parent().after(e):S(this.Element).after(e)},_RenderVirtualPagingContainer:function(){this.dataContainerDivHeight=S(this.Element).parent().height()-70,this.dataContainerDivHeight=this.dataContainerDivHeight<80?80:this.dataContainerDivHeight,S("table").css("max-width","none");var e=S("<div class='SheetGridView SheetGridViewTitle' data-datafield='"+this.DataField+"' style='overflow:hidden;width:100%;'></div>"),t=S("<div class='SheetGridView SheetGridViewData' data-datafield='"+this.DataField+"' data-type='SheetGridView' style='overflow:auto;width:100%;height:"+this.dataContainerDivHeight+"px;' scroll='scroll'></div>");S(this.Element).parent().append(e),S(this.Element).parent().append(t),t.append(S(this.Element));var i=S(this.Element).width(),a=S("<table class='SheetGridView'></table>").css("max-width","none").css({width:i,"table-layout":"fixed"});S(this.Element).css("width",S(this.Element).width());var n=S("<tbody class=''></tbody>"),s=S(this.Element).find("tr.header");n.append(s),a.append(n),e.append(a)},RenderMobile:function(){if(this.Visiable){S(this.Element).closest("div[class=tableContent list]").hide(),g=S(this.Element).find("tr")[0].innerText.replace(/\s+/g,",").split(","),S(this.Element).closest("div[class=list]").hide();var e=S(this.Element).data(S.MvcSheetUI.DataFieldKey.toLowerCase()),t=S(this.Element).data(S.MvcSheetUI.SheetIDKey);this.template=S(this.Element).find(".template"),S(this.Element).find("table").remove(),S(this.Element).data(S.MvcSheetUI.SheetIDKey,t);var i=S(this.Element).closest("div[class=tableContent list]");S(this.Element.parentElement).hasClass("hidden")?this.Element=S("<div>").attr("data-datafield",e).addClass("SheetGridView hidden"):this.Element=S("<div>").attr("data-datafield",e).addClass("SheetGridView"),i.after(this.Element);var a=SheetLanguages.Current.ChildSchemaInfo1,n=0;n=null!=this.V.DataItems?(this.IsAssociation=!0,1):(this.IsAssociation=!1,this.V.R.length),this.DataItem.N&&7<this.DataItem.N.length&&(this.DataItem.N=this.DataItem.N.substr(0,7)+"..."),txt=this.DataItem.N+SheetLanguages.Current.ChildSchemaInfo2+n+SheetLanguages.Current.ChildSchemaInfo3,this.title=S("<div>").addClass("item item-title").append("<span>"+txt+"</span>"),this.title.appendTo(this.Element);var s=S("<div>").addClass("item-content").addClass("tab-mode");s.appendTo(this.Element),this.modal='<div class="item-index"><div class="buttons-left"><ion-scroll class="scroll" direction="x" scrollbar-x="false" delegate-handle="'+this.DataField+'_1" style="display:none;"><button class="button button-small" type="button" ng-click="test()">1</button></ion-scroll><ion-scroll class="scroll" direction="x" scrollbar-x="false" delegate-handle="'+this.DataField+'" style="display:block;"></ion-scroll></div><div class="buttons-right"><span style="font-size:35px;" class="addrow">+</span></div></div><div class="item-content" style="height:100%;border-top:1px solid rgb(221, 221, 221);border-bottom:1px solid rgb(221, 221, 221);"><div class="slider-slides"></div></div>',S(this.modal).appendTo(s),this.IsAssociation&&S(this.Element).find("div[class='buttons-right']").addClass("hide"),this.InitMobileIndex(),S.MvcSheetUI.IonicFramework.$compile(S(S(this.Element).find("ion-scroll")))(S.MvcSheetUI.IonicFramework.$scope),this.changeSchemeShowMode=S("<div></div>").addClass("button-fun").attr("align","center").append(S("<a>").addClass("button button-small button-red").text(SheetLanguages.Current.ChangeMode)),this.title.append(this.changeSchemeShowMode),this.Editable||0==n&&(s.addClass("list-mode"),S(this.changeSchemeShowMode).hide()),this.addbtnBottom=S('<div class="addbtn"><span>+</span>'+SheetLanguages.Current.AddChildSchema+"</div>"),this.V.R&&s.append(this.addbtnBottom),this.RowCount=0,this.RowNum=0,this.MobileRow=S("<div>").addClass("slider-slide").attr("style","display:none;");var l=S("<div></div>").addClass("list-title"),h=S("<div></div>").addClass("list-title-left");h.text(a);var r=S("<div></div>").addClass("list-title-right");r.append(S("<div></div>").addClass("copy").text(SheetLanguages.Current.Copy)).append(S("<div></div>").addClass("delete").text(SheetLanguages.Current.Delete)),l.append(h).append(r),this.MobileRow.append(l);var o=S(this.template).find("td");if(this.L==S.MvcSheetUI.LogicType.BizObjectArray)for(var d=1;d<o.length-1;d++){var c=S(o[d]).find("[data-field]"),u=S(c).attr("data-field"),p=S.MvcSheetUI.GetSheetDataItem(u,1);p.N!=g[d+1]&&(p.N=g[d+1]),this.GetChildrenTd(o[d])}else for(d=0;d<o.length;d++)this.GetChildrenTd(o[d]);this.SetValue(),this.currentIndex=0,this.ShowMobileData(0),this.childSchemaShowMode="tabMode";var m=this;this.bindAddLast=function(e){e.unbind("click.add").bind("click.add",[this],function(e){e.data[0]._AddMobileRow(),v(m.currentIndex,"add"),f(),S.MvcSheetUI.IonicFramework.$ionicScrollDelegate.resize()})},this.bindAddAfter=function(e){e.unbind("click.add").bind("click.add",[this],function(e){e.data[0]._InsertMobileRow.apply(e.data[0],[S(this),!1]),v(m.currentIndex,"insert"),f()})},S(this.changeSchemeShowMode.find("a")).unbind("click.changeMode").bind("click.changeMode",[this],function(e){if("listMode"==m.childSchemaShowMode){s.removeClass("list-mode").addClass("tab-mode"),m.childSchemaShowMode="tabMode";m.Element.find(".slider-slide").hide();m.Element.find(".item-index").find("button").each(function(e,t){t.getAttribute("index")==m.currentIndex&&m.MobileIndexButtonClick(t)})}else s.removeClass("tab-mode").addClass("list-mode"),m.childSchemaShowMode="listMode";S.MvcSheetUI.IonicFramework.$ionicScrollDelegate.resize()}),this.bindCopy=function(e){e.unbind("click.copy").bind("click.copy",[this],function(e){var t=S(e.target).parents(".slider-slide")[0].getAttribute("data-row")-1;m.currentIndex=t,0!=S(e.data[0].Element).find("div[class='slider-slide']").length&&(e.data[0]._InsertMobileRow.apply(e.data[0],[S(this),!0]),v(m.currentIndex,"insert"),f())})},this.bindDelete=function(e){e.unbind("click.delete").bind("click.delete",[this],function(e){m.currentIndex=S(e.target).parents(".slider-slide")[0].getAttribute("data-row")-1;var t=m.currentIndex,i=S(this).closest('div[data-datafield="'+m.DataField+'"]').find('div[class="slider-slide"]');if(0!=i.length){m.OnPreRemove&&m.RunScript(S(i[t]),m.OnPreRemove),m.OnRemoved&&m.RunScript(S(i[t]),m.OnRemoved);for(var a=0;a<m.V.R.length;a++){if((l=m.V.R[a].DataItems[m.DataField+".ObjectID"].V)==S(i[t]).attr("id")){m.V.R.splice(a,1);break}}var n=m.MobileRows[t];for(var s in n.Editors){var l;(l=S(n.Editors[s].Element).data(S.MvcSheetUI.SheetIDKey))&&S.MvcSheetUI.ControlManagers[l]&&delete S.MvcSheetUI.ControlManagers[l]}S(i[t]).remove(),m.MobileRows.splice(t,1),t==m.MobileRows.length&&0!=t&&t--,--m.RowCount,m.ShowMobileData(t),v(m.currentIndex,"delete"),this.OnRemoved&&this.RunScript(S(deleterow),this.OnRemoved),S.MvcSheetUI.MvcRuntime.init(S("body")),f()}})},this.bindAddLast(this.Element.find(".addrow")),this.bindAddLast(this.addbtnBottom);var f=function(){var e=m.Element.find(".copy"),t=m.Element.find(".delete");e.each(function(e,t){m.bindCopy(S(t))}),t.each(function(e,t){m.bindDelete(S(t))}),m.Element.find(".list-title").each(function(e,t){var i=S(t).find(".list-title-left")[0],a=S(i).parents(".slider-slide")[0].getAttribute("data-row");S(i).text(SheetLanguages.Current.ChildSchema+"("+a+")")})};f();var v=function(e,t){var i=S(m.Element).find("ion-scroll");if("delete"==t){(s=S(i[1]).find("button"))[e].remove(),s=S(i[1]).find("button");for(var a=0;a<s.length;a++)S(s[a]).attr("id",m.DataField+(a+1)).attr("index",a).text(a+1);var n=S(m.Element).find("div.slider-slide");for(a=0;a<n.length;a++)S(n[a]).attr("data-row",a+1);S(s[e]).addClass("button-blue")}else{var s=S(i[0]).find("button").clone(!0);0==S(i[1]).find("button").length?(S(S(i[1]).find("div.scroll")).append(s),S(s).addClass("button-blue"),m.ShowMobileData(0)):(S(S(i[1]).find("button:last")).after(s),"add"==t?m.ShowMobileData(m.RowCount-1):m.ShowMobileData(e+1)),S(s).attr("index",m.RowCount-1).attr("id",m.DataField).text(m.RowCount),S(s).unbind("click.switch").bind("click.switch",[m],function(e){e.data[0].MobileIndexButtonClick(this)})}var l=m.DataItem.N+SheetLanguages.Current.ChildSchemaInfo2+S(i[1]).find("button").length+SheetLanguages.Current.ChildSchemaInfo3;m.title.find("span").text(l),S.MvcSheetUI.IonicFramework.$ionicScrollDelegate.$getByHandle(m.DataField).resize()};if(this.DisplayAdd&&this.L!=S.MvcSheetUI.LogicType.BizObject&&this.Editable||(S(this.Element).find("div[class='buttons-right']").css("display","none"),S(this.Element).find(".copy").css("display","none"),S(this.Element).find(".addbtn").css("display","none")),this.DisplayDelete&&this.L!=S.MvcSheetUI.LogicType.BizObject&&this.Editable||S(this.Element).find(".delete").css("display","none"),this.OnRendered&&this.RunScript(this,this.OnRendered,arguments),S.MvcSheetUI.SheetInfo.IsOriginateMode){for(d=1;d<this.DefaultRowCount;d++)this._AddMobileRow(),v(this.currentIndex,"add");this.ShowMobileData(0)}}else S(this.Element).hide()},InitMobileIndex:function(e){this.currentIndex=e||0;var t=S(this.Element).find("ion-scroll"),i=(this.V.R,0);if(i=this.IsAssociation?1:this.V.R.length,!(this.Originate&&this.DefaultRowCount<1)){for(var a=1;a<i+1;a++){var n=S("<button>").addClass("button button-small").attr("id",this.DataField+"-"+a).attr("type","button").attr("index",a-1).text(a);S(t[1]).append(n),S(n).unbind("click.switch").bind("click.switch",[this],function(e){e.data[0].MobileIndexButtonClick(this)})}S(S(t[1]).find("button")[this.currentIndex]).addClass("button-blue")}},MobileIndexButtonClick:function(e){var t=Number(S(e).attr("index")),i=S(e).closest("ion-scroll");S(S(i[0]).find("button")).removeClass("button-blue"),S(S(i[0]).find("button")[t]).addClass("button-blue"),this.ShowMobileData(t)},ShowMobileData:function(e){var t=S(this.Element).find("div[class='slider-slide']");if(0!=t.length){var i=S(this.Element).find("ion-scroll");S.MvcSheetUI.IonicFramework.$ionicScrollDelegate.$getByHandle(this.DataField);S(S(i[1]).find("button")[this.currentIndex]).removeClass("button-blue"),S(S(i[1]).find("button")[e]).addClass("button-blue"),S(t[this.currentIndex]).hide(),S(t[e]).show(),this.currentIndex=e;var a=S(i[1]).find("button")[e];this.SetNavPosition(a)}},SetNavPosition:function(e){var t=S.MvcSheetUI.IonicFramework.$ionicScrollDelegate.$getByHandle(this.DataField),i=t.getScrollPosition().left,a=S(e).offset().left;t.scrollTo(i-120+a,0,!0)},_AddMobileRow:function(e){this.MobileRows||(this.MobileRows=[]);var t,i,a,h=this;(this.OnPreAdd&&this.RunScript(S(this.Element),this.OnPreAdd,arguments),getTrValue=function(e){for(var t={},i=h.MobileRows[e],a=i.Editors,n=0;n<a.length;n++){var s=a[n];if(s){var l=s.DataField;l&&(t[l.split(".")[1]]=s.GetValue())}}return i.id&&(t.ObjectID=i.id),t},MobileRowCtor=function(e,s,l,t,i,h){this.RowControl=S(e).clone().attr("data-row",s).attr("id",i),this.RowControl.find("[data-datafield]").attr("data-row",s),s!=l&&0<S(t).find("div[class='slider-slide']").length?S(S(t).find("div[class='slider-slide']")[s-2]).after(this.RowControl):S(t).find("div[class='slider-slides']").append(this.RowControl),S.MvcSheetUI.IonicFramework.$compile(S(this.RowControl))(S.MvcSheetUI.IonicFramework.$scope);var r=[];return this.RowControl.find("div.list").each(function(){var e=S(this).children(":last").children();if(S(e).attr("id")){var t=S(e).attr("id");t=t+"_Row"+s,S(e).attr("id",t)}if(h){var i=getTrValue(s-2),a=S(e).SheetUIManager(l),n=i[a.DataField.split(".")[1]];a.SetValue(n)}r.push(S(e).SheetUIManager(l))}),this.Editors=r,this},arguments&&1==arguments.length)?(t=e,a=this.RowCount+1,i=new MobileRowCtor(this.MobileRow,a,++this.RowNum,this.Element,t,!1)):i=arguments&&2==arguments.length?(t=S.uuid(),a=this.currentIndex+2,new MobileRowCtor(this.MobileRow,a,++this.RowNum,this.Element,t,arguments[1])):(t=S.uuid(),a=this.RowCount+1,new MobileRowCtor(this.MobileRow,a,++this.RowNum,this.Element,t,!1));this.OnAdded&&this.RunScript(S(this.Element),this.OnAdded,[this,this.V.R[this.RowCount]]),++this.RowCount;this.RowCount;this.MobileRows.splice(a-1,0,i),S.MvcSheetUI.MvcRuntime&&!S.MvcSheetUI.Loading&&S.MvcSheetUI.MvcRuntime.init(S("body"))},_InsertMobileRow:function(e){for(var t=this.currentIndex+1,i=S(this.Element).find("div.slider-slide"),a=0;a<i.length;a++){var n=i[a],s=parseInt(S(n).attr("data-row"));t<s&&(s=s-1+2,S(n).attr("data-row",s),S(n).find("[data-row]").attr("data-row",s),S(n).find("td:first").html()==s-1&&S(n).find("td:first").html(s))}this._AddMobileRow(e,arguments[1])},GetChildrenTd:function(e){window.console.log(""+g);var t,i=S(e).find("[data-field]");t=S(e).attr("class")&&-1!=S(e).attr("class").indexOf("hidden")?S("<div></div>").addClass("list hidden").attr("type","item-text-wrap"):S("<div></div>").addClass("list").attr("type","item-text-wrap");var a=S(i).attr("data-field");S(i).removeAttr("data-field").attr("data-datafield",a),S(t).attr("data-field",a);var n=S.MvcSheetUI.GetSheetDataItem(a,1);n&&S(t).append(S("<div></div>").addClass("col-md-2").append(S("<label>"+n.N+"</label>"))),S(t).append(S("<div></div>").addClass("col-md-4").append(S(i))),S(this.MobileRow).append(t)},SetRowReadOnly:function(e){if(e<this.V.R.length)for(var t in this.V.R[e].DataItems)this.V.R[e].DataItems[t].O=this.V.R[e].DataItems[t].O.replace("E","")},_AddNewRow:function(e){this.SheetInfo.BizObject.DataItems[this.DataField].V.R||this.TransferValue();var t=this.RowCount;if(this.OnPreAdd&&this.RunScript(S(this.Element),this.OnPreAdd,[this,t]),this.newRow=this.template.clone(!0).attr("class","rows").attr("data-row",this.RowCount+1).removeAttr("style","display:none"),S(this.newRow).find("td").each(function(){var e=S(this).find("[data-field]"),t=e.attr("data-field");e.removeAttr("data-field").attr("data-datafield",t),e.attr("data-row",S(this).closest("tr").attr("data-row"))}),this.L==S.MvcSheetUI.LogicType.BizObjectArray&&(1<this.newRow.length?S(S(this.newRow)[0]).find("td:first").html(++this.RowCount):S(this.newRow).find("td:first").html(++this.RowCount)),arguments&&1==arguments.length){var i=e;S(this.newRow).attr("id",i)}if(1<arguments.length){var a=S(arguments[1]).attr("data-row")-1+2;if(this.newRow.attr("data-row",a),1<this.newRow.length){var n;S(S(this.newRow)[0]).find("td:first").html(a);for(var s=0;s<this.newRow.length;s++)n=S(arguments[1]).next("tr");S(n).after(this.newRow)}else S(this.newRow).find("td:first").html(a),S(arguments[1]).after(this.newRow)}else 0==S(this.Element).find("tr.rows").length?1<this.template.length?S(S(this.template)[this.template.length-1]).after(this.newRow):S(this.template).after(this.newRow):S(this.Element).find("tr.rows:last").after(this.newRow);++this.RowNum;var l=this.RowCount,h=this;S(this.newRow).find("td").each(function(){var e=S(this).children();if(S(e).attr("id")){var t=S(e).attr("id");t=t+"_Row"+h.RowNum,S(e).attr("id",t)}S(e).SheetUIManager2(h.RowCount)}),this.AlternatingRowStyle&&l%2==0&&S(this.newRow).attr("style",this.AlternatingRowStyle);var r=S(this.newRow).find("td");for(s=0;s<r.length;s++){var o=r[s];this.GetSummaryTd(o)&&S(o).children().unbind("change.Summary").bind("change.Summary",[this],function(e){e.data[0]._Summary(this)})}S.MvcSheetUI.MvcRuntime&&!S.MvcSheetUI.Loading&&S.MvcSheetUI.MvcRuntime.init(S("body"));var d=S(this.newRow).find("a.delete");S(d).unbind("click").bind("click",[this],function(e){e.data[0]._Deleterow(S(this).closest("tr"))});var c=S(this.newRow).find("a.insert");S(c).unbind("click").bind("click",[this],function(e){e.data[0]._Insertrow(S(this).closest("tr"))}),this.OnAdded&&this.RunScript(S(this.newRow),this.OnAdded,[this,this.V.R[t],t]);var u=this.Element;if(this.deafaultTableHeight=S(u).height(),this.VirtualPaging){this._SetVirtualPagingContainerHeight();var p=S(this.Element).parent(".SheetGridViewData").siblings(".SheetGridViewTitle").find("tr.header td");if(S(this.Element).find("tr.rows").find("td").each(function(e,t){S(t).children().each(function(){S(this).attr("data-displayrule")&&S(t).children().addClass("block")})}),S(this.Element).find("tr.rows").eq(0).find("td").each(function(e,t){p.eq(e).css("width",S(t).outerWidth(!0))}),"scroll"==this.Element.parentElement.getAttribute("scroll"));else{var m=S(this.Element).find("tr[class='rows']:last").find("td:first").next();0<m.find("input").length?m.find("input").focus():0<m.find("textarea").length?m.find("textarea").focus():0<m.find("select").length&&m.find("select").focus()}}},_AddRow:function(e){this.SheetInfo.BizObject.DataItems[this.DataField].V.R||this.TransferValue();var t=this.RowCount;if(this.OnPreAdd&&this.RunScript(S(this.Element),this.OnPreAdd,[this,t]),this.newRow=this.template.clone(!0).attr("class","rows").attr("data-row",this.RowCount+1).removeAttr("style","display:none"),S(this.newRow).find("td").each(function(){var e=S(this).find("[data-field]"),t=e.attr("data-field");e.removeAttr("data-field").attr("data-datafield",t),e.attr("data-row",S(this).closest("tr").attr("data-row"))}),this.L==S.MvcSheetUI.LogicType.BizObjectArray&&(1<this.newRow.length?S(S(this.newRow)[0]).find("td:first").html(++this.RowCount):S(this.newRow).find("td:first").html(++this.RowCount)),arguments&&1==arguments.length){var i=e;S(this.newRow).attr("id",i)}if(1<arguments.length){var a=S(arguments[1]).attr("data-row")-1+2;if(this.newRow.attr("data-row",a),1<this.newRow.length){var n;S(S(this.newRow)[0]).find("td:first").html(a);for(var s=0;s<this.newRow.length;s++)n=S(arguments[1]).next("tr");S(n).after(this.newRow)}else S(this.newRow).find("td:first").html(a),S(arguments[1]).after(this.newRow)}else 0==S(this.Element).find("tr.rows").length?1<this.template.length?S(S(this.template)[this.template.length-1]).after(this.newRow):S(this.template).after(this.newRow):S(this.Element).find("tr.rows:last").after(this.newRow);++this.RowNum;var l=this.RowCount,h=this;S(this.newRow).find("td").each(function(){var e=S(this).children();if(S(e).attr("id")){var t=S(e).attr("id");t=t+"_Row"+h.RowNum,S(e).attr("id",t)}S(e).SheetUIManager(h.RowCount)}),this.AlternatingRowStyle&&l%2==0&&S(this.newRow).attr("style",this.AlternatingRowStyle);var r=S(this.newRow).find("td");for(s=0;s<r.length;s++){var o=r[s];this.GetSummaryTd(o)&&S(o).children().unbind("change.Summary").bind("change.Summary",[this],function(e){e.data[0]._Summary(this)})}S.MvcSheetUI.MvcRuntime&&!S.MvcSheetUI.Loading&&S.MvcSheetUI.MvcRuntime.init(S("body"));var d=S(this.newRow).find("a.delete");S(d).unbind("click").bind("click",[this],function(e){e.data[0]._Deleterow(S(this).closest("tr"))});var c=S(this.newRow).find("a.insert");S(c).unbind("click").bind("click",[this],function(e){e.data[0]._Insertrow(S(this).closest("tr"))}),this.OnAdded&&this.RunScript(S(this.newRow),this.OnAdded,[this,this.V.R[t],t]);var u=this.Element;if(this.deafaultTableHeight=S(u).height(),this.VirtualPaging){this._SetVirtualPagingContainerHeight();var p=S(this.Element).parent(".SheetGridViewData").siblings(".SheetGridViewTitle").find("tr.header td");if(S(this.Element).find("tr.rows").find("td").each(function(e,t){S(t).children().each(function(){S(this).attr("data-displayrule")&&S(t).children().addClass("block")})}),S(this.Element).find("tr.rows").eq(0).find("td").each(function(e,t){p.eq(e).css("width",S(t).outerWidth(!0))}),"scroll"==this.Element.parentElement.getAttribute("scroll"));else{var m=S(this.Element).find("tr[class='rows']:last").find("td:first").next();0<m.find("input").length?m.find("input").focus():0<m.find("textarea").length?m.find("textarea").focus():0<m.find("select").length&&m.find("select").focus()}}},_Deleterow:function(e,t){var i=parseInt(S(e).attr("data-row"));this.OnPreRemove&&this.RunScript(S(e),this.OnPreRemove),S(e).find("[data-datafield]").each(function(e,t){var i=S(this).data(S.MvcSheetUI.SheetIDKey);i&&S.MvcSheetUI.ControlManagers[i]&&(S.MvcSheetUI.ControlManagers[i].DataItem.V="",delete S.MvcSheetUI.ControlManagers[i])}),S(e).remove();var a=S(this.Element).find("tr.rows");if(void 0===t||!t){for(var n=0;n<a.length;n++){var s=a[n];S(s).attr("data-row")==i&&S(s).remove();var l=parseInt(S(s).attr("data-row"));i<l&&(this.AlternatingRowStyle&&(l%2==1?S(s).attr("style",this.AlternatingRowStyle):S(s).attr("style","")),S(s).attr("data-row",l-1),S(s).find("td:first").html()==l&&S(s).find("td:first").html(l-1),S(s).find("td").each(function(){S(this).attr("data-title")&&S(this).attr("data-title",l-1),S(this).children()&&S(this).find("[data-datafield]")&&S(this).find("[data-datafield]").attr("data-row",l-1)}))}var h=S(this.template).find("td");for(n=0;n<h.length;n++)this.GetSummaryTd(h[n])&&this._Summary(S(h[n]).children())}if(this.RowCount=this.RowCount-1,this.OnRemoved&&this.RunScript(S(e),this.OnRemoved),void 0!==t&&t||S.MvcSheetUI.MvcRuntime&&S.MvcSheetUI.MvcRuntime.init(S("body")),this.VirtualPaging&&(this._SetVirtualPagingContainerHeight(),!S(this.Element).find("tr.rows").length&&!S(this.Element).find("tr.footer").is(":hidden"))){var r=S(this.Element).parent(".SheetGridViewData").siblings(".SheetGridViewTitle").find("tr.header td");S(this.Element).find("tr.footer").eq(0).find("td").each(function(e,t){r.eq(e).css("width",S(t).outerWidth(!0))})}},_Insertrow:function(e){for(var t=parseInt(S(e).attr("data-row")),i=S(this.Element).find("tr.rows"),a=0;a<i.length;a++){var n=i[a],s=parseInt(S(n).attr("data-row"));t<s&&(s=s-1+2,S(n).attr("data-row",s),S(n).find("td:first").html()==s-1&&S(n).find("td:first").html(s))}this._AddRow(!0,e)},_Clear:function(e){var t=this;S(this.Element).find("tr.rows").each(function(e){t._Deleterow.apply(t,[S(this),!0])}),this.RowCount=0;for(var i=S(this.template).find("td"),a=0;a<i.length;a++)this.GetSummaryTd(i[a])&&this._Summary(S(i[a]).children());S.MvcSheetUI.MvcRuntime&&S.MvcSheetUI.MvcRuntime.init(),this.VirtualPaging&&this._SetVirtualPagingContainerHeight()},_SetVirtualPagingContainerHeight:function(){var e=this.Element,t=this.Element.parentElement,i=S(e).height(),a=i;this.trHeight=a-(null==this.trHeight?this.deafaultTableHeight:this.trHeight),a=i>10*this.trHeight&&0<this.trHeight?10*this.trHeight:i,S(t).css("height",a),S(t.parentElement).css("height",100+a),this.trHeight=i},_Export:function(e){var t={};if(this.VirtualPaging)var i=S(this.Element).parent().parent().find("tr.header").find("td");else i=S(this.Element).find("tr.header").find("td");for(var a=0;a<i.length;a++){var n=S(i[a]).attr("data-field");if(n){var s=S.MvcSheetUI.GetSheetDataItem(n,1);s&&(t[n.split(".")[1]]=s.N)}}var l=this.GetValue(!0);if(this.VirtualPaging){var h=this.pageIndex*this.loadNum;if(h<this.V.R.length&&0!=h){var r=this.GetNotShowData(h,"Export");if(0<r.length)for(a=0;a<r.length;a++)l.push(r[a])}}S.MvcSheet.PostSheet({Command:"Exportexcel",Param:JSON.stringify([l,t])},function(e){e&&(window.location.href=e.FileUrl)},null,!0)},_Import:function(e){var n=this;S("#importExcel_"+n.ButtonId).val()?S.ajaxFileUpload({url:S.MvcSheetUI.PortalRoot+"/ImportHandler/ImportHandler",secureuri:!1,fileElementId:"importExcel_"+this.ButtonId,type:"post",success:function(e,t){S("#importExcel_"+n.ButtonId).val("");var i=S(e).find("body").text(),a=S.parseJSON(i);a.sucess&&0<a.data.length?n._ImportInit.apply(n,[a.data]):alert(S.Lang(a.message))},error:function(e){}}):alert("未选择任何文件！")},_ImportInit:function(e){this._Clear();for(var t=0;t<e.length;t++){var i=e[t];this._AddRow();for(var a=i.split(";"),n=S(this.newRow).find("td"),s=0,l=0;l<n.length;l++)S(n[l]).find("[data-datafield]")&&0<S(n[l]).find("[data-datafield]").length&&S(n[l]).is(":visible")&&null!=a[s]&&(S(n[l]).find("[data-datafield]").SheetUIManager(t+1).SetValue(a[s]),this._Summary(S(n[l]).find("[data-datafield]")),s++);this.VirtualPaging&&(this.pageIndex=Math.ceil(e.length/this.loadNum))}},GetDefaultRow:function(e){var t=S(this.Element).parent().parent().find("tr.header").find("td");e.push("ObjectID");for(var i=0;i<t.length;i++){var a=S(t[i]).attr("data-field");if(a){var n=a.split(".")[1];e.push(n)}}return e},GetNotShowData:function(e,t){var i=[],a=this.V.R;if(e<a.length){var n=S(this.Element).attr("data-datafield"),s=[];s=this.GetDefaultRow(s);for(var l=e;l<a.length;l++){var h={},r=a[l].DataItems;for(var o in s){var d=s[o];if(null!=r[n+"."+d])if(24==r[n+"."+d].L)if("save"==t){var c=r[n+"."+d].V,u={},p="";if(0<c.length)for(var m=0;m<c.length;m++)p=p+c[m].Code+";";u.AttachmentIds=p,u.DelAttachmentIds="",h[d]=u}else h[d]="";else if(26==r[n+"."+d].L){f=null==r[n+"."+d].V?"":r[n+"."+d].V,h[d]=f}else if(27==r[n+"."+d].L){var f=new Array,v=r[n+"."+d].V;if(""==v||null==v)h[d]="";else if(0<v.length){for(m=0;m<v.length;m++){var g=v[m].Code;f.push(g)}h[d]=f}}else{f=null==r[n+"."+d].V?"":r[n+"."+d].V,h[d]=f}}i.push(h)}}return i},TransferValue:function(){if(null!=this.originateValue){for(var e=this.SheetInfo.BizObject.DataItems[this.DataField].V,t=this.originateValue,i=[],a=0;a<e.length;a++)i.push(JSON.parse(JSON.stringify(this.originateValue.R[0])));for(a=0;a<e.length;a++){var n=e[a];for(var s in i[0].DataItems){var l=s.split(".")[1];i[a].DataItems[s].V=n[l],delete i[a].DataItems[s].BizObjectID,delete i[a].DataItems[s].RoeNum}}var h={};h.R=i,h.T=t.T,this.SheetInfo.BizObject.DataItems[this.DataField].V=h}},SaveDataField:function(){null==this.originateValue&&(this.originateValue=this.SheetInfo.BizObject.DataItems[this.DataField].V);var e={};if(!this.Visiable||!this.Editable)return e;if(e[this.DataField]=this.SheetInfo.BizObject.DataItems[this.DataField],!e[this.DataField])return alert(SheetLanguages.Current.DataItemNotExists+":"+this.DataField),{};var t=this.GetValue();if(this.VirtualPaging){var i=this.pageIndex*this.loadNum;if(i<this.V.R.length&&0!=i){var a=this.GetNotShowData(i,"save");if(0<a.length)for(var n=0;n<a.length;n++)t.push(a[n])}}if(e[this.DataField].V==t)return{};var s=e[this.DataField].V.T;return e[this.DataField].V=t,e[this.DataField].V.T=s,e}})}(jQuery),function(a){a.fn.SheetHiddenField=function(){return a.MvcSheetUI.Run.call(this,"SheetHiddenField",arguments)},a.MvcSheetUI.Controls.SheetHiddenField=function(e,t,i){a.MvcSheetUI.Controls.SheetHiddenField.Base.constructor.call(this,e,t,i)},a.MvcSheetUI.Controls.SheetHiddenField.Inherit(a.MvcSheetUI.IControl,{Render:function(){var e=a(this.Element),t=a.MvcSheetUI.SheetInfo.HiddenFields;if(t)for(var i in t)if(e.attr("id")==i){e.val(t[i]);break}},SaveDataField:function(){var e=a(this.Element),t=a.MvcSheetUI.SheetInfo.HiddenFields;return t&&t[e.attr("id")]?t[e.attr("id")]!=e.val()&&(a.MvcSheetUI.HiddenFields[e.attr("id")]=e.val()):a.MvcSheetUI.HiddenFields[e.attr("id")]=e.val(),{}}})}(jQuery),function(a){a.fn.SheetHyperLink=function(){return a.MvcSheetUI.Run.call(this,"SheetHyperLink",arguments)},a.MvcSheetUI.Controls.SheetHyperLink=function(e,t,i){a.MvcSheetUI.Controls.SheetHyperLink.Base.constructor.call(this,e,t,i)},a.MvcSheetUI.Controls.SheetHyperLink.Inherit(a.MvcSheetUI.IControl,{Render:function(){var e=a(this.Element);if(this.Visiable){var t=this.Text;t=t||this.NavigateUrl,this.TextDataField&&(t=a.MvcSheetUI.GetControlValue(this.TextDataField,this.RowNum)),e.text(t),e.addClass("SheetHyperLink").addClass("printHidden"),a("<span></span>").addClass("viewHidden").text(t).insertAfter(e);var i=this.NavigateUrl;this.NavigateUrlDataField&&(i=a.MvcSheetUI.GetControlValue(this.NavigateUrlDataField,this.RowNum)),i&&this.IsMobile&&(-1!=i.indexOf("?")?i+="&UC=true":i+="?UC=true",e.attr("href",i)),this.IsMobile||(i?(e.attr("target","_blank"),e.attr("href",i)):(e.removeAttr("target"),e.removeAttr("href")))}else e.hide()},RenderMobile:function(){this.Render()},Validate:function(){return!0},SaveDataField:function(){result={},result[this.DataField]=this.DataItem;var e=this.NavigateUrl;return this.NavigateUrlDataField&&(e=a.MvcSheetUI.GetControlValue(this.NavigateUrlDataField,this.RowNum)),result[this.DataField].V=e,result},GetValue:function(){return this.NavigateUrl}})}(jQuery),function(n){n.fn.SheetInstancePrioritySelector=function(){return n.MvcSheetUI.Run.call(this,"SheetInstancePrioritySelector",arguments)},n.MvcSheetUI.Controls.SheetInstancePrioritySelector=function(e,t,i){n.MvcSheetUI.Controls.SheetInstancePrioritySelector.Base.constructor.call(this,e,t,i)},n.MvcSheetUI.Controls.SheetInstancePrioritySelector.Inherit(n.MvcSheetUI.IControl,{Render:function(){var e=n(this.Element),t=this;if(this.Visiable){this.TrackVisiable&&!this.Originate&&-1==this.DataField.indexOf(".")&&this.RenderDataTrackLink(),e.unbind("change.SheetInstancePrioritySelector").bind("change.SheetInstancePrioritySelector",function(){n.isFunction(t.OnChange)?t.OnChange.apply(this):new Function(t.OnChange).apply(this)});var i=n.MvcSheetUI.SheetInfo.Priorities;if(i){for(var a in e.empty(),i)e.append("<option value='"+a+"'>"+i[a]+"</option>"),this.IsMobile&&this.AddMobileItem(a,i[a],!1);this.V=this.V||this.DefaultValue,this.V&&""!=this.V?e.val(this.V):e.val("Normal"),this.Editable||(e.after("<label style='width:100%;'>"+e.children("option:selected").text()+"</label>"),e.hide()),this.IsMobile&&this.Editable&&this.ionicInit(n.MvcSheetUI.IonicFramework)}}else e.hide()},RenderMobile:function(){this.MobileOptions=[],this.Editable?(this.constructor.Base.RenderMobile.apply(this),this.pupIcon=n("<i class='icon ion-ios-arrow-right'></i>").insertAfter(this.Mask),n(this.Element).closest("div.item").addClass("item-icon-right"),n(this.Element).hide()):this.Render()},ionicInit:function(t){var i=this;if(n(this.Element.parentElement.parentElement).unbind("click.showChoice").bind("click.showChoice",function(e){t.$ionicModal.fromTemplateUrl("Mobile/form/templates/radio_popover.html",{scope:t.$scope}).then(function(e){(t.$scope.popover=e).scope.RadioListDisplay=i.MobileOptions,e.scope.RadioListValue=i.GetValue(),e.show(),e.scope.hide=function(){e.hide()},e.scope.clickRadio=function(e,t){i.SetValue(e),n(i.Mask).html(t),i.Validate()},e.scope.searchFocus=!1,e.scope.searchAnimate=function(){e.scope.searchFocus=!e.scope.searchFocus},e.scope.searChange=function(){e.scope.searchNum=n(".active .popover .list").children("label").length}})}),i.IsMobile){var e=i.GetText();i.Editable?(i.Mask.html(e),n(i.Mask).css({color:"#2c3038"})):n(i.Element).html(e)}},AddMobileItem:function(e,t,i){var a={DataField:this.DataField,Value:e,Text:t};this.MobileOptions.push(a)},GetText:function(){return n(this.Element).children("option:selected").text()},SaveDataField:function(){var e={};return this.Visiable&&this.Editable?(e[this.DataField]=this.SheetInfo.BizObject.DataItems[this.DataField],e[this.DataField]?(n.MvcSheetUI.Priority=n(this.Element).val(),e[this.DataField].V!=n(this.Element).val()?(e[this.DataField].V=n(this.Element).val(),e):{}):(alert(SheetLanguages.Current.DataItemNotExists+":"+this.DataField),{})):e}})}(jQuery),function(a){a.fn.SheetLabel=function(){return a.MvcSheetUI.Run.call(this,"SheetLabel",arguments)},a.MvcSheetUI.Controls.SheetLabel=function(e,t,i){a.MvcSheetUI.Controls.SheetLabel.Base.constructor.call(this,e,t,i)},a.MvcSheetUI.Controls.SheetLabel.Inherit(a.MvcSheetUI.IControl,{Render:function(){if(this.Visiable){if(a(this.Element).css("display","block"),this.BindType.toLowerCase()==this.BindTypeEnum.OnlyData){var e=this.V,t=a(this.Element);if(e=e&&a.trim(e)){var i=e.split("\n");a(i).each(function(e){0<e&&t.append("<br />"),t.text(this.toString())})}else t.text("")}else a(this.Element).text()?a(this.Element).text().trim()||this.DataField&&a(this.Element).text(this.DataField):a(this.Element).text(this.Text||this.N||"");this.OnClick&&a(this.Element).unbind("click.SheetLabel").bind("click.SheetLabel",[this],function(e){var t=e.data[0];new Function(t.OnClick).apply(t.Element,arguments)})}else this.Element.style.display="none"},GetValue:function(){return a(this.Element).text()||this.DataField},SaveDataField:function(){var e={};return this.Visiable&&this.Editable&&this.BindType.toLowerCase()!=this.BindTypeEnum.OnlyVisiable?(e[this.DataField]=a.MvcSheetUI.GetSheetDataItem(this.DataField),e[this.DataField]?e[this.DataField].V!=a(this.Element).html()?(e[this.DataField].V=a(this.Element).html(),e):{}:(-1==this.DataField.indexOf(".")&&alert(SheetLanguages.Current.DataItemNotExists+":"+this.DataField),{})):e}})}(jQuery),function(r){r.fn.SheetOffice=function(){return r.MvcSheetUI.Run.call(this,"SheetOffice",arguments)},r.MvcSheetUI.Controls.SheetOffice=function(e,t,i){this.NTKO=null,r.MvcSheetUI.Controls.SheetOffice.Base.constructor.call(this,e,t,i)},r.MvcSheetUI.Controls.SheetOffice.Inherit(r.MvcSheetUI.IControl,{Render:function(){"undefined"==typeof wordObject?this.wordObject={ReadOnly:!1,Print:!1,Sign:!1,Stamp:!1,Template:!1,Mark:!1,Accept:!1,PDF:!1}:this.wordObject=wordObject;var e=r("<table border='0' style='text-align: center; width: 100%'></table>"),t=r("<object id='TANGER_OCX' classid='clsid:"+this.ClassID+"' codebase='"+this.CABPath+"#version="+this.ProductVersion+"' width='"+this.OfficeWidth+"' height='"+this.OfficeHeight+"'><param name='ProductCaption' value='"+this.ProductCaption+"'><param name='ProductKey' value='"+this.ProductKey+"'></object>");r(e).append(r("<tr></tr>").append(r("<td style='height: "+this.OfficeHeight+";'></td>").append(t))),r(this.Element).append(e);var i=r("<tr></tr>"),a=r("<td><input type='button' value='"+SheetLanguages.Current.CreatePDF+"' ></td>"),n=r("<td><input type='button' value='"+SheetLanguages.Current.ViewPDF+"' ></td>"),s=r("<td><input type='button' value='"+SheetLanguages.Current.AddESP+"' ></td>"),l=r("<td><input type='button' value='"+SheetLanguages.Current.AddTemplate+"' ></td>");r(i).append(r(a)).append(r(n)).append(r(s)).append(r(l)),this.wordObject.PDF||(r(a).hide(),r(n).hide()),this.wordObject.Stamp||r(s).hide(),this.wordObject.Template||r(l).hide(),r(this.Element).before(r(i)),r(a).unbind("click").bind("click",[this],function(e){e.data[0].SavePDF()}),r(n).unbind("click").bind("click",[this],function(e){e.data[0].ViewPDF()}),r(s).unbind("click").bind("click",[this],function(e){e.data[0].AddSign()}),r(l).unbind("click").bind("click",[this],function(e){e.data[0].AddTemplate()});var h=this;setTimeout(function(){h.InitOffice()},1e3)},InitOffice:function(){this.NTKO=document.getElementById(r(this.Element).find("object").attr("id"));var t=!0;try{if(this.Originate)this.NTKO.OpenFromURL(this.Template);else try{var e=_PORTALROOT_GLOBAL+"/Office/WordOpen.aspx?SchemaCode="+r.MvcSheetUI.SheetInfo.SchemaCode+"&BizObjectID="+r.MvcSheetUI.SheetInfo.BizObjectID+"&InstanceID="+r.MvcSheetUI.SheetInfo.InstanceId+"&dataField="+this.DataField;this.NTKO.OpenFromURL(e)}catch(e){this.NTKO.OpenFromURL(this.Template)}}catch(e){t=!1,alert(SheetLanguages.Current.IE)}t&&(this.wordObject.ReadOnly?this.SetReadOnly(this.wordObject.ReadOnly):this.SetReadOnly(!this.Editable),this.NTKO.fileprint=this.wordObject.Print,this.NTKO.fileprintPreview=this.wordObject.Print,this.NTKO.IsNoCopy=!1)},ViewPDF:function(){var e=_PORTALROOT_GLOBAL+"/Office/WordOpen.aspx?SchemaCode="+r.MvcSheetUI.SheetInfo.SchemaCode+"&BizObjectID="+r.MvcSheetUI.SheetInfo.BizObjectID+"&dataField="+this.PDFDataField;window.open(e)},SetReadOnly:function(e){this.NTKO.SetReadOnly(e)},SaveOffice:function(){if(!this.NTKO.ActiveDocument.Saved){if(null==this.wordObject.ReadOnly||this.wordObject.ReadOnly)return;this.NTKO.SaveToURL(_PORTALROOT_GLOBAL+"/Office/OfficeService.aspx","UploadFile","Command=SaveDocument&InstanceID="+r.MvcSheetUI.SheetInfo.InstanceId+"&dataField="+this.DataField+"&SchemaCode="+r.MvcSheetUI.SheetInfo.SchemaCode+"&BizObjectID="+r.MvcSheetUI.SheetInfo.BizObjectID+"&SaveType=Doc","dd.doc",document.forms[0].id,!1)}},SavePDF:function(){var e;if(e=!0,this.NTKO.fileOpen&&this.NTKO.IsPDFCreatorInstalled()){this.setSingPrint(!0);this.NTKO.PublishAsPDFToURL(_PORTALROOT_GLOBAL+"/Office/OfficeService.aspx","SavePDF","DataField="+this.PDFDataField+"&Download=1&FileName="+encodeURI("fileName.pdf")+"&SchemaCode="+r.MvcSheetUI.SheetInfo.SchemaCode+"&BizObjectID="+r.MvcSheetUI.SheetInfo.BizObjectID+"&InstanceID="+r.MvcSheetUI.SheetInfo.InstanceId+"&SaveType=PDF","abc.pdf",0,null,!1,!0,!0,"123",e,!0);return this.setSingPrint(!1),!0}return alert(SheetLanguages.Current.PdfNotSave),!1},AddSign:function(){null==this.wordObject.ReadOnly||this.wordObject.ReadOnly?(this.NTKO.SetReadOnly(!1),this.addServerSign(this.SignUrl,this.SignBookmark,this.SignTop,this.SignLeft,"",this.SignType),this.NTKO.SetReadOnly(!0),this.wordObject.ReadOnly=!1):this.addServerSign(this.SignUrl,this.SignBookmark,this.SignTop,this.SignLeft,"",this.SignType)},setSingPrint:function(e){var t=this.NTKO.ActiveDocument.shapes;for(i=1;i<=t.Count;i++)12==t(i).Type&&"NTKO.SecSignControl".toUpperCase()==t(i).OLEFormat.ClassType.toUpperCase()&&(e?t(i).OLEFormat.object.SetPrintMode(2):t(i).OLEFormat.object.SetPrintMode(0))},addServerSign:function(e,t,i,a,n,s){if(this.NTKO.fileOpen)try{this.NTKO.SetReadOnly(!1),null!=this.NTKO.ActiveDocument.BookMarks&&(this.NTKO.ActiveDocument.BookMarks.Exists(t)?this.NTKO.ActiveDocument.BookMarks(t).Select():(a=100,i=200)),"Server"==s?this.addSecSignFromURL(this.SignUrl,r.MvcSheetUI.SheetInfo.currentUser,parseInt(a),parseInt(i)):"EKEY"==s?this.addSecSignFromEkey(r.MvcSheetUI.SheetInfo.currentUser,parseInt(a),parseInt(i)):"2"==s&&this.addLocalSign(r.MvcSheetUI.SheetInfo.currentUser,parseInt(a),parseInt(i),"")}catch(e){return null!=this.wordObject.ReadOnly&&!this.wordObject.ReadOnly||this.NTKO.SetReadOnly(!0),!1}return!0},addSignFromURL:function(e,t,i,a){this.NTKO.AddSignFromURL(t,e,i,a,t,3,100,1)},addSecSignFromURL:function(e,t,i,a){this.NTKO.AddSecSignFromURL(t,e,i,a,1,0,!1,!1,!0,!1,"",!1,!0)},addSecSignFromEkey:function(e,t,i){this.NTKO.AddSecSignFromEkey(e,t,i,1,0,!1,!1,!0,!1,"",-1,!1,!0)},addSignFromLocal:function(e,t,i,a){this.NTKO.AddSignFromLocal(e,a,!0,t,i,e,1,100,1)},AddTemplate:function(){if(this.OnTemplate)this.RunScript(this,this.OnTemplate);else try{var e,t;SheetLanguages.Current.BookmarkNotExists;if(t=(e=this.NTKO.ActiveDocument).Application.Selection,this.NTKO.AddTemplateFromURL(this.RedTemplate),this.bookmarks=[],this.BookmartMapping){var i=this.BookmartMapping.split(";");if(i&&0<i.length)for(n=0;n<i.length;n++){var a=i[n].split(":");this.bookmarks.push({Name:a[0],Value:a[1]})}}for(var n=0;n<this.bookmarks.length;n++)if(null!=this.bookmarks[n]&&e.BookMarks.Exists(this.bookmarks[n].Name)){var s=r.MvcSheetUI.GetControlValue(this.bookmarks[n].Value);e.BookMarks(this.bookmarks[n].Name).Range.Text=s}t.EndKey(6,1),t.Delete()}catch(e){alert("ERROR："+e.number+":"+e.description)}},SaveDataField:function(){return this.SaveOffice(),{}}})}(jQuery),function(o){o.fn.SheetOriginatorUnit=function(){return o.MvcSheetUI.Run.call(this,"SheetOriginatorUnit",arguments)},o.MvcSheetUI.Controls.SheetOriginatorUnit=function(e,t,i){o.MvcSheetUI.Controls.SheetOriginatorUnit.Base.constructor.call(this,e,t,i)},o.MvcSheetUI.Controls.SheetOriginatorUnit.Inherit(o.MvcSheetUI.IControl,{Render:function(){var e=o(this.Element),t=this;e.unbind("change.SheetOriginatorUnit").bind("change.SheetOriginatorUnit",function(){o.isFunction(t.OnChange)?t.OnChange.apply(this):new Function(t.OnChange).apply(this)});var i=o.MvcSheetUI.SheetInfo.DirectParentUnits;if(i){for(var a in e.empty(),i)e.append("<option value='"+a+"'>"+i[a]+"</option>");this.V=o.MvcSheetUI.SheetInfo.OriginatorOU,this.V&&""!=this.V&&e.val(this.V);var n=0;for(var a in o.MvcSheetUI.SheetInfo.DirectParentUnits)n++;o.MvcSheetUI.SheetInfo.ActivityCode==o.MvcSheetUI.SheetInfo.StartActivityCode&&1!=n&&"view"!=o.MvcSheetUI.QueryString("Mode").toLowerCase()||(e.after("<label style='width:100%;'>"+e.children("option:selected").text()+"</label>"),e.hide())}},RenderMobile:function(){var a=o(this.Element),n=o.MvcSheetUI.SheetInfo.DirectParentUnits;for(var e in a.empty(),n)a.append("<option value='"+e+"'>"+n[e]+"</option>");var t=o.MvcSheetUI.IonicFramework,s=this;a.hide();var i=o('<i class="icon ion-ios-arrow-right"></i>'),l=o("<span class='input-label'></span>");s.Mask=l;var h=a.closest(".detail");h.append(l),h.append(i),s.V=o.MvcSheetUI.SheetInfo.OriginatorOU,s.V&&""!=s.V&&(s.Mask.html(n[s.V]),a.val(s.V)),h.unbind("click.showSelect").bind("click.showSelect",function(){t.$ionicModal.fromTemplateUrl("Mobile/form/templates/radio_popover.html",{scope:t.$scope}).then(function(e){for(var t in e.scope.header=SheetLanguages.Current.BasicInfo.divOriginateOUName,e.scope.RadioListDisplay=[],e.scope.RadioListValue=a.val(),n){var i={Value:t,Text:n[t]};e.scope.RadioListDisplay.push(i)}e.show(),e.scope.hide=function(){e.hide()},e.scope.clickRadio=function(e,t){a.val(e),o(s.Mask).html(t)},e.scope.searchFocus=!1,e.scope.searchAnimate=function(){e.scope.searchFocus=!e.scope.searchFocus}})});var r=function(e){var t=0;for(var i in e)e.hasOwnProperty(i)&&t++;return t}(n);o.MvcSheetUI.SheetInfo.ActivityCode!=o.MvcSheetUI.SheetInfo.StartActivityCode||1==r||"view"==o.MvcSheetUI.QueryString("Mode").toLowerCase()?(s.Mask.text(a.children("option:selected").text()),i.hide(),h.addClass("uneditableOU"),h.unbind("click.showSelect")):h.addClass("editableOU")},GetText:function(){return o(this.Element).children("option:selected").text()},SaveDataField:function(){o.MvcSheetUI.ParentUnitID=o(this.Element).val()}})}(jQuery),function(d){d.fn.SheetQuery=function(){return d.MvcSheetUI.Run.call(this,"SheetQuery",arguments)},d.MvcSheetUI.Controls.SheetQuery=function(e,t,i){this.QueryCss={List:"list",AfList:"orglist"},this.InputMapJson={},this.OutputMapJson={},this.FilterFlag=!0,this.Columns=null,this.ControlType={TextBox:0,DropdownList:1,RadioButtonList:2,CheckBoxList:3,RichTextBox:4},d.MvcSheetUI.Controls.SheetQuery.Base.constructor.call(this,e,t,i)},d.MvcSheetUI.Controls.SheetQuery.Inherit(d.MvcSheetUI.IControl,{Validate:function(){return!0},RenderMobile:function(){this.MappingSetting(),this.InitQuery()},AfterMobileEditShow:function(){(null==this.Scrllable||0<this.InputMappings.length)&&(this.IsBindInputVlues=!1,this.LoadQueryData())},MappingSetting:function(){for(var e=this.OutputMappings.split(","),t=0;t<e.length;t++){var i=e[t].split(":");this.OutputMapJson[i[0]]=i[1]}this.InputMappingSetting()},InputMappingSetting:function(){for(var e=this.InputMappings.split(","),t=0;t<e.length;t++){var i=e[t].split(":"),a=i[0],n=d.MvcSheetUI.GetElement(a,this.RowNum);null!=n&&(this.InputMapJson[i[1]]=n.SheetUIManager())}},InitQuery:function(){d(this.Element).append('<div class="scroll-wrapper"><div class="scroller"></div></div>'),this.UlElementID=d.MvcSheetUI.NewGuid(),this.UlElement=d("<ul>").attr("id",this.UlElementID).addClass(this.QueryCss.AfList).addClass(this.QueryCss.List).appendTo(d(this.Element).find("div.scroller"))},LoadQueryData:function(){var a=this,e={Action:"GetQuerySettingAndData",SchemaCode:this.SchemaCode,QueryCode:this.QueryCode,InputMapping:this.GetInputMappings()};a.FilterPanelID&&(e.Action="GetQueryData",a.IsBindInputVlues||a.BindFilterInputValues.apply(a),e.Filters=a.GetFilters()),this.Scrllable?(this.UlElement.html(""),this.Scrllable.UpdateLoadParams(e)):(this.Scrllable=new ScrollableList({url:d.MvcSheetUI.PortalRoot+"/BizQueryHandler/BizQueryHandler",panelSelector:"#"+this.MobilePanelID,ulSelector:"#"+this.UlElementID,loadMoreAble:!0,loadParams:e,OnSucceed:function(e,t,i){a.QueryData=e.QueryData,a.Columns=e.Columns,a.QuerySetting||(a.QuerySetting=e.QuerySetting,a.FilterItems=a.QuerySetting.QueryItems,a.FilterItems||(a.FilterFlag=!1),a.BindFilter.apply(a)),i||a.UlElement.html(""),a.BindData.apply(a)}}),this.Scrllable.LoadItems())},GetDisplayName:function(e){return this.Columns&&this.Columns[e]||e},BindFilter:function(){if(this.FilterFlag){this.FilterFlag=!1,this.FilterBtn=d("<a  class='icon magnifier big'></a>").css("position","absolute").css("bottom","20px").css("right","50px").css("z-index","999").css("cursor","pointer").appendTo(d(this.Element).find(".scroll-wrapper")),this.FilterPanelID=d.MvcSheetUI.NewGuid(),this.FilterPanel=d("<div>").attr("id",this.FilterPanelID).hide().appendTo(this.Element);for(var e=d("<ul>").addClass("list").appendTo(this.FilterPanel),t=0;t<this.FilterItems.length;t++){var i=this.FilterItems[t];if(i.Visible&&3!=i.FilterType){i.DefaultValue;this.InputMapJson[i.PropertyName];var a=d("<li>").appendTo(e),n=d("<label for='"+this.FilterPanelID+i.PropertyName+"'>"+this.GetDisplayName(i.PropertyName)+"</label>").css("text-align","left");switch(a.append(n),i.DisplayType){case this.ControlType.DropdownList:var s=d("<select id='"+this.FilterPanelID+i.PropertyName+"' data-property='"+i.PropertyName+"'>");s.append("<option value=''>"+SheetLanguages.Current.All+"</option>");for(var l=i.SelectedValues.split(";"),h=0;h<l.length;h++)""!=l[h]&&s.append("<option value='"+l[h]+"'>"+l[h]+"</option>");s.val(i.DefaultValue),a.append(s);break;case this.ControlType.RadioButtonList:for(l=i.SelectedValues.split(";"),h=0;h<l.length;h++)if(""!=l[h]){var r=d.MvcSheetUI.NewGuid();a.append("<input id='"+r+"' type='radio' name='"+i.PropertyName+"' value='"+l[h]+"'></input>"),a.append("<label for='"+r+"'>"+l[h]+"</label>")}d("input[name='"+i.PropertyName+"'][value='"+i.DefaultValue+"']").attr("checked","checked"),a.append("<br style='clear: both;'></br>");break;case this.ControlType.CheckBoxList:for(l=i.SelectedValues.split(";"),h=0;h<l.length;h++)if(""!=l[h]){r=d.MvcSheetUI.NewGuid();a.append("<input id='"+r+"' type='checkbox' name='"+i.PropertyName+"' value='"+l[h]+"'></input>"),a.append("<label for='"+r+"'>"+l[h]+"</label>")}d("input[name='"+i.PropertyName+"'][value='"+i.DefaultValue+"']").attr("checked","checked"),a.append("<br style='clear: both;'></br>");break;default:a.append("<input type='text' id='"+this.FilterPanelID+i.PropertyName+"' data-property='"+i.PropertyName+"'></input>"),d("#"+i.PropertyName).val(i.DefaultValue)}}}d.ui.addContentDiv(this.FilterPanelID),this.FooterID=d.MvcSheetUI.NewGuid();var o=d("<footer id="+this.FooterID+" ><a class='icon magnifier big' >"+SheetLanguages.Current.OK+"</a><footer>");d("#afui").append(o),d(o).unbind("click.footerObj").bind("click.footerObj",this,function(e){e.data.LoadQueryData(),d.ui.goBack()}),this.FilterPanel.attr("data-footer",this.FooterID),this.FilterBtn.unbind("click.FilterBtn").bind("click.FilterBtn",this,function(e){d.ui.loadContent(e.data.FilterPanelID)})}},BindFilterInputValues:function(){this.IsBindInputVlues=!0;for(var e=0;e<this.FilterItems.length;e++){var t=this.FilterItems[e];if(t.Visible&&(3!=t.FilterType&&this.InputMapJson[t.PropertyName]))switch(t.DisplayType){case this.ControlType.RadioButtonList:case this.ControlType.CheckBoxList:this.FilterPanel.find("input[name='"+t.PropertyName+"'][value='"+this.InputMapJson[t.PropertyName].GetValue()+"']").attr("checked","checked");break;default:d("#"+this.FilterPanelID+t.PropertyName).val(this.InputMapJson[t.PropertyName].GetValue())}}},GetFilters:function(){for(var e={},t=0;t<this.FilterItems.length;t++){var i=this.FilterItems[t];if(i.Visible&&3!=i.FilterType)switch(i.DisplayType){case this.ControlType.RadioButtonList:case this.ControlType.CheckBoxList:this.FilterPanel.find("input[name='"+i.PropertyName+"']:checked").val()&&(e[i.PropertyName]=d("input[name='"+i.PropertyName+"']:checked").val());break;default:d("#"+this.FilterPanelID+i.PropertyName).val()&&(e[i.PropertyName]=d("#"+this.FilterPanelID+i.PropertyName).val())}}return JSON.stringify(e)},GetInputMappings:function(){var e={};if(this.InputMapJson)for(var t in this.InputMapJson)this.InputMapJson[t]&&(e[t]=this.InputMapJson[t].GetValue());return JSON.stringify(e)},getPropertyNameFromData:function(e,t){for(var i in e)if(i.toLocaleLowerCase()==t.toLocaleLowerCase())return i},BindData:function(){for(var e=0;e<this.QueryData.length;e++){for(var t=this.QueryData[e],i=d("<li>").data("dataindex",e).data("v",JSON.stringify(t)),a=d("<p>"),n=d("#"+this.ElementID).attr("data-datafield"),s=0;s<this.QuerySetting.Columns.length;s++){var l=this.QuerySetting.Columns[s].PropertyName;(l=this.getPropertyNameFromData(t,l))==this.OutputMapJson[n]?(i.html(""),i.append("<h2>"+t[l]+"</h2>")):0==s?i.append("<h2>"+t[l]+"</h2>"):1==this.QuerySetting.Columns[s].Visible&&a.append("<span style='font-style:italic'>"+this.GetDisplayName(l)+"</span>:"+t[l]+"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")}i.append(a).appendTo(this.UlElement),i.unbind("click.liElement").bind("click.liElement",this,function(e){e.data.ItemClick.apply(e.data,[JSON.parse(d(this).data("v"))])})}},ItemClick:function(e){var t=d("#"+this.ElementID).attr("data-datafield"),i=d("#"+this.ElementID).attr("data-row");for(var a in this.OutputMapJson)if(a==t){d("#"+this.ElementID).val(e[this.OutputMapJson[a]]),d(this.ElementMask).text(e[this.OutputMapJson[a]]);try{d.MvcSheetUI.ControlManagers[d("#"+this.ElementID).data("sheetid")].Validate()}catch(n){}}else{var n=d.MvcSheetUI.GetElement(a,i);null!=n&&n.data(d.MvcSheetUI.SheetIDKey)&&(n.SheetUIManager().SetValue(e[this.OutputMapJson[a]]),n.SheetUIManager().Validate&&n.SheetUIManager().Validate())}d.ui.goBack(0)}})}(jQuery),function(r){r.fn.SheetRadioButtonList=function(){return r.MvcSheetUI.Run.call(this,"SheetRadioButtonList",arguments)},r.MvcSheetUI.Controls.SheetRadioButtonList=function(e,t,i){r.MvcSheetUI.Controls.SheetRadioButtonList.Base.constructor.call(this,e,t,i)},r.MvcSheetUI.Controls.SheetRadioButtonList.Inherit(r.MvcSheetUI.IControl,{Render:function(){this.Visiable?(this.TrackVisiable&&!this.Originate&&-1==this.DataField.indexOf(".")&&this.RenderDataTrackLink(),this.HtmlRender(),r(this.Element).unbind("change.SheetRadioButtonList").bind("change.SheetRadioButtonList",[this],function(e){e.data[0].Validate(),e.data[0].RunScript(this,e.data[0].OnChange)})):this.Element.style.display="none"},GetValue:function(){var e="";return r(this.Element).find("input").each(function(){this.checked&&(e=r(this).val())}),e},SetValue:function(e){r(this.Element).find("input").each(function(){this.value==e&&r(this).prop("checked","checked")}),this.IsMobile&&(this.Mask.text(this.GetText()),this.OnChange&&this.RunScript(this,this.OnChange),this.Editable&&(""==this.Mask.text()||this.Mask.text()==SheetLanguages.Current.PleaseSelect?(this.Mask.text(SheetLanguages.Current.PleaseSelect),this.Mask.css({color:"#797f89"})):this.Mask.css({color:"#2c3038"})))},GetText:function(){return this.OnChange&&this.RunScript(this,this.OnChange),r(this.Element).find("input:checked").next().text()},SetReadonly:function(e){e?r(this.Element).find("input").prop("disabled",!0):r(this.Element).find("input").prop("disabled",!1)},SetColumns:function(){if(this.RepeatColumns&&/^([1-9]\d*)$/.test(this.RepeatColumns)){var e,t=100/this.RepeatColumns+"%",i=r(this.Element).find("div");for(e=0;e<i.length;e++)r(i[e]).css({width:t})}},SaveDataField:function(){var e={};return this.Visiable&&this.Editable?(e[this.DataField]=this.SheetInfo.BizObject.DataItems[this.DataField],e[this.DataField]?(e[this.DataField].V=this.GetValue(),e):(alert(SheetLanguages.Current.DataItemNotExists+":"+this.DataField),{})):e},InitValue:function(){if(this.SheetInfo.SheetMode!=r.MvcSheetUI.SheetMode.Originate||this.V||this.DefaultSelected&&(0===r(this.Element).find("input:checked").length&&(r(this.Element).find("input").first().prop("checked","checked"),this.V=r(this.Element).find("input").first().val()),this.SelectedValue&&1==r(this.Element).find("input[type='radio'][value='"+this.SelectedValue+"']").length&&(r(this.Element).find("input[type='radio'][value='"+this.SelectedValue+"']").prop("checked","checked"),this.V=r(this.Element).find("input[type='radio'][value='"+this.SelectedValue+"']").val())),r(this.Element).find("input[type='radio'][value='"+this.V+"']").prop("checked","checked"),this.IsMobile){var e=r(this.Element).find("input[type='radio'][value='"+this.V+"']").text();e=e||r(this.Element).find("input[type='radio'][value='"+this.V+"']").parent().find("label").text(),this.Editable?this.Mask.html(e):(e=e.replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\"/g,"&quot;"),r(this.Element).html(e))}},HtmlRender:function(){if(this.Visiable){r(this.Element).addClass("SheetRadioButtonList"),this.SheetGropName=this.DataField+"_"+r.MvcSheetUI.NewGuid();var e=r(this.Element).html();if(r(this.Element).html(""),this.MasterDataCategory){var a=this,n=JSON.stringify([this.MasterDataCategory]);if(r.MvcSheetUI.CacheData&&r.MvcSheetUI.CacheData[n]){var t=r.MvcSheetUI.CacheData[n];for(var i in t)a.AddRadioItem.apply(a,[t[i].Code,t[i].EnumValue,t[i].IsDefault]);a.InitValue.apply(a),a.DoRepeatDirection.apply(a),a.IsMobile&&a.Editable&&a.ionicInit(r.MvcSheetUI.IonicFramework)}else r.MvcSheet.GetSheet({Command:"GetMetadataByCategory",Param:n},function(e){if(e){if(r.MvcSheetUI.CacheData||(r.MvcSheetUI.CacheData={}),null!=e.Successful&&!e.Successful)return;for(var t=0,i=(r.MvcSheetUI.CacheData[n]=e).length;t<i;t++)a.AddRadioItem.apply(a,[e[t].Code,e[t].EnumValue,e[t].IsDefault])}a.InitValue.apply(a),a.DoRepeatDirection.apply(a),a.IsMobile&&a.Editable&&a.ionicInit(r.MvcSheetUI.IonicFramework)},null,-1==this.DataField.indexOf("."))}else if(this.DefaultItems){for(var s=this.DefaultItems.split(";"),l=0;l<s.length;l++)this.AddRadioItem.apply(this,[s[l],s[l],!1]);this.InitValue(),this.DoRepeatDirection(),this.IsMobile&&this.Editable&&this.ionicInit(r.MvcSheetUI.IonicFramework)}else r(this.Element).html(e),this.InitValue(),this.IsMobile&&this.Editable&&this.ionicInit(r.MvcSheetUI.IonicFramework)}else r(this.Element).hide()},RenderMobile:function(){this.MobileOptions=[],this.HtmlRender(),this.Editable?(this.MoveToMobileContainer(),this.pupIcon=r("<i class='icon ion-ios-arrow-right'></i>").insertAfter(this.Mask),r(this.Element).closest("div.item").addClass("item-icon-right"),r(this.Element).hide(),this.SetValue()):r(this.Element).addClass(this.Css.Readonly)},ionicInit:function(t){var a=this;r(this.Element.parentElement).unbind("click.showChoice").bind("click.showChoice",function(e){t.$ionicModal.fromTemplateUrl("Mobile/form/templates/radio_popover.html",{scope:t.$scope}).then(function(e){e.scope.header=a.N,e.scope.RadioListDisplay=a.MobileOptions,e.scope.RadioListValue=a.GetValue(),e.show(),e.scope.hide=function(){e.hide()},e.scope.clickRadio=function(e,t){for(var i=0;i<r(a.Element).children("div").length;i++)r(r(r(a.Element).children("div"))[i])[0].innerText===e&&(r(r(a.Element).children("div").children("input")[0]).trigger("change",e),r(r(a.Element).children("div").children("input")[0]).val(e));a.SetValue(e),t=t.replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\"/g,"&quot;").replace(/\'/g,"&apos;"),r(a.Mask).html(t),a.Validate()},e.scope.searchFocus=!1,e.scope.searchAnimate=function(){e.scope.searchFocus=!e.scope.searchFocus},e.scope.searChange=function(){e.scope.searchNum=r(".active .popover .list").children("label").length}})})},DoRepeatDirection:function(){if("Horizontal"==this.RepeatDirection&&r(this.Element).find("[SheetGropName='"+this.SheetGropName+"']").css("float","left"),this.SetColumns(),this.Editable&&this.Required)for(var e=r(this.Element).find("input"),t=0;t<e.length;t++)r(e[t]).prop("checked")&&this.RemoveInvalidText(this.Element,"*",!1)},AddRadioItem:function(e,t,i){if(t||e){var a=r("<div SheetGropName='"+this.SheetGropName+"'></div>");if(this.IsMobile){a.attr("style","display:none;");var n={DataField:this.DataField,Value:e,Text:t};this.MobileOptions.push(n)}t=(t=r("<div/>").text(t).html()).replace(/\"/g,"&quot;").replace(/\'/g,"&apos;"),e=(e=r("<div/>").text(e).html()).replace(/\"/g,"&quot;").replace(/\'/g,"&apos;");var s=r.MvcSheetUI.NewGuid(),l=r("<input type='radio' />").prop("name",this.SheetGropName).prop("id",s).val(e);this.DefaultSelected&&l.prop("checked",i),this.Editable||l.prop("disabled",!0);var h=r("<label for='"+s+'\'  style="padding-left:3px;padding-right:5px;">'+(t||e)+"</label>");r(this.Element).append(a),a.append(l),a.append(h)}}})}(jQuery),function(n){n.fn.SheetRelationInstance=function(){return n.MvcSheetUI.Run.call(this,"SheetRelationInstance",arguments)},n.MvcSheetUI.Controls.SheetRelationInstance=function(e,t,i){this.RelationInstances=[],this.ModalId="divModal_RelationInstance",this.LoadUrl=null,this.LinkUrl=null,this.InstanceTable=null,n.MvcSheetUI.Controls.SheetRelationInstance.Base.constructor.call(this,e,t,i)},n.MvcSheetUI.Controls.SheetRelationInstance.Inherit(n.MvcSheetUI.IControl,{Render:function(){this.Visiable?(this.LoadUrl=this.PortalRoot+"/SelectInstance.html?InstanceId="+this.SheetInfo.InstanceId+"&ID="+this.Element.id,this.LinkUrl=this.PortalRoot+"/InstanceSheets.html",this.V&&this.GetInstancesFromValue(),this.RenderHistory(),this.Editable&&this.RenderUpload()):n(this.Element).hide()},GetInstancesFromValue:function(){for(var e=this.V.split("#,#"),t=0;t<e.length;t++)if(-1!=e[t].indexOf("#_#")){var i=e[t].split("#_#");this.RelationInstances.push({ObjectID:i[0],InstanceId:i[1],InstanceName:i[2]})}},GetValueFromInstances:function(){for(var e="",t=0;t<this.RelationInstances.length;t++)0<t&&(e+="#,#"),e+=this.RelationInstances[t].ObjectID+"#_#"+this.RelationInstances[t].InstanceId+"#_#"+this.RelationInstances[t].InstanceName;return e},RenderHistory:function(){if(null==this.InstanceTable){"<tbody>","</tbody>","</table>",this.InstanceTable=n('<table class="table table-striped" style="margin: 0px; min-height: 0px;"><tbody></tbody></table>'),this.InstanceTable.appendTo(n(this.Element))}this.InstanceTable.find("row").remove();for(var e=0;e<this.RelationInstances.length;e++)this.AddItem(this.RelationInstances[e])},RenderUpload:function(){this.Element.id||this.DataField;var e='<div class="btn btn-outline btn-lg" style="width: 100%; border: 1px dashed rgb(221, 221, 221);" data-toggle="modal" data-target="#'+this.ModalId+'">';e+="点击绑定流程",e+="</div>",0==n("#"+this.ModalId).length&&(e+='<div id="'+this.ModalId+'" class="modal fade" tabindex="-1" role="dialog" style="display: none;" aria-hidden="true">',e+='<div class="modal-dialog" style="width:600px;height:452px;">',e+='<div class="modal-content" style="height:100%;">',e+='<div class="modal-header">',e+='<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>',e+='<h4 class="modal-title">请选择关联流程</h4>',e+="</div>",e+='<div class="modal-body">',e+='<iframe id="frm_RelationInstance" name="frm_RelationInstance" scrolling="no" frameborder="0" style="width: 100%; height: 452px;" src="'+this.LoadUrl+'"></iframe>',e+="</div>",e+="</div>",e+="</div>",e+="</div>"),n(e).appendTo(n(this.Element))},AddItem:function(e){var t=this,i=this.LinkUrl+"?RelationID="+encodeURI(e.InstanceId),a='<tr id="'+e.ObjectID+'">';a+="<td>",a+='<a href="'+i+'" target="_blank"><i class="fa fa-angle-right" style="padding-right:5px;"></i>'+e.InstanceName+"</a>",a+="</td>",this.Editable&&(a+='<td class="printHidden" style="text-align: center;width:60px;">',a+='<a href="javascript:void(0);" data-action="'+e.ObjectID+'" class="fa fa-minus">删除</a>',a+="</td>"),n(a+="</tr>").appendTo(this.InstanceTable).find(".fa-minus").click(function(){var e=n(this).data("action");t.RemoveItem(e)})},AddNewItem:function(e,t,i){var a={ObjectID:e,InstanceId:t,InstanceName:i};this.RelationInstances.push(a),this.AddItem(a)},RemoveItem:function(e){for(var t=0;t<this.RelationInstances.length;t++)if(this.RelationInstances[t].ObjectID==e){this.RelationInstances.splice(t,1),this.InstanceTable.find("#"+e).remove();break}window.frames.frm_RelationInstance&&window.frames.frm_RelationInstance.removeItemFromParent&&window.frames.frm_RelationInstance.removeItemFromParent(e)},RenderMobile:function(){this.Render(),this.MoveToMobileContainer(this.Element)},Validate:function(e,t){return!this.Editable||(t&&this.Required&&this.RelationInstances<1?(this.AddInvalidText(this.Element,"*",!1),!1):!e&&this.Required&&this.RelationInstances<1?(this.AddInvalidText(this.Element,"*"),!1):(this.RemoveInvalidText(this.Element),!0))},GetValue:function(){return this.RelationInstances},SetValue:function(e){n.extend(this.RelationInstances,e),this.RenderHistory()},SaveDataField:function(){var e={};return this.Visiable&&this.Editable&&(e[this.DataField]=this.DataItem,e[this.DataField].V=this.GetValueFromInstances()),e}})}(jQuery),function(r){r.fn.SheetRichTextBox=function(){return r.MvcSheetUI.Run.call(this,"SheetRichTextBox",arguments)},r.MvcSheetUI.Controls.SheetRichTextBox=function(e,t,i){this.EditorObject=null,this.EditorIndex=0,r.MvcSheetUI.Controls.SheetRichTextBox.Base.constructor.call(this,e,t,i)},r.MvcSheetUI.Controls.SheetRichTextBox.Inherit(r.MvcSheetUI.IControl,{Render:function(){if(this.Visiable)if(this.TrackVisiable&&!this.Originate&&-1==this.DataField.indexOf(".")&&this.RenderDataTrackLink(),this.Element.id){this.Element.maxLength="2000";var e=r("<p class='text-length'><span>0</span>/2000</p>");this.IsMobile?(this.PlaceHolder=this.PlaceHolder||SheetLanguages.Current.PleaseInput,this.ionicInit(r(this.Element),r.MvcSheetUI.IonicFramework)):(r(this.Element).attr("PlaceHolder","请输入"),r(this.Element).css("position","relative"),this.Editable&&r(this.Element).parent().append(e)),r(this.Element).attr("PlaceHolder",this.PlaceHolder),this.RichTextBox&&this.Editable&&this.IsMobile&&(this.RichTextBox=!1);var t,i=this;r(this.Element).unbind("change.CommentInput").bind("change.CommentInput",this,function(e){var t=e.target.value.length;r(i.Element).siblings().children("span").html(t)}),r(this.Element).keyup(function(e){var t=e.target.value.length;r(i.Element).siblings().children("span").html(t)}),r(this.Element).keydown(function(e){var t=e.target.value.length;r(i.Element).siblings().children("span").html(t)}),t=r.MvcSheetUI.SheetInfo.SheetMode!=r.MvcSheetUI.SheetMode.Originate||this.V?this.V||"":this.DefaultValue||"",this.SetValue(t),this.RichTextBox&&this.Editable&&!this.IsMobile&&this.InitKindEditor(),this.Editable?(this.ToolTip&&r(this.Element).attr("title",this.ToolTip),r(this.Element).unbind("change.SheetRichTextBox").bind("change.SheetRichTextBox",[this],function(e){e.data[0].Validate()})):this.SetReadonly(!0)}else alert("控件:"+this.DataField+"未设置ID");else r(this.Element).hide()},ionicInit:function(e,t){e.attr("rows","4"),e.parent().addClass("textarea")},InitKindEditor:function(){if(null!=KindEditor){this.EditorIndex=KindEditor.instances.length;var l=this.EditorIndex,h=this.SheetInfo;KindEditor.SchemaCode=h.SchemaCode,KindEditor.UserID=h.UserID,KindEditor.BizObjectID=h.BizObjectID,this.EditorObject=KindEditor.create(this.Element,{cssPath:"WFRes/editor/plugins/code/prettify.css",uploadJson:"/upload/upload_json.jsp",fileManagerJson:"/upload/file_manager_json.jsp",allowFileManager:!0,items:["source","|","undo","redo","|","code","plainpaste","wordpaste","|","justifyleft","justifycenter","justifyright","justifyfull","insertorderedlist","insertunorderedlist","indent","outdent","subscript","superscript","clearhtml","selectall","|","fullscreen","/","formatblock","fontname","fontsize","|","forecolor","hilitecolor","bold","italic","underline","strikethrough","lineheight","removeformat","|","image","table","hr","emoticons","anchor","link","unlink","|","about"],afterCreate:function(){r(this.edit.doc).on("paste",function(e){if(window.ActiveXObject||"ActiveXObject"in window||"undefined"!=typeof Worker){var t,i,a=(e.clipboardData||e.originalEvent.clipboardData).items,n=null;for(t=0,i=a.length;t<i;t++)if(0===a[t].type.indexOf("image")){n=a[t].getAsFile();break}if(n){var s=new FormData;s.append("imgFile",n,"screenshot.png"),s.append("BizObjectID",h.BizObjectID),s.append("UserID",h.UserID),s.append("SchemaCode",h.SchemaCode),s.append("EditorIndex",l),r.ajax({url:_PORTALROOT_GLOBAL+"/WFRes/editor/asp.net/upload_json.ashx",type:"POST",data:s,cache:!1,processData:!1,contentType:!1,dataType:"json",success:function(e){0===e.error&&KindEditor.instances[e.editorIndex].insertHtml('<img src="'+e.url+'" alt="" /> ')}})}}})}})}},SetReadonly:function(e){if(e){r(this.Element).hide();var t=r('<label class="SheetRichTextBox"></div>'),i=this.Element.value;if(t.html('<div style="overflow-x:auto;display:block;white-space:inherit;padding:7px 0;" id="divRich_'+this.Element.id+'">'+i+"</div>").insertAfter(r(this.Element)),this.IsMobile){var a={ox:0,oy:0,cx:0,cy:0};this.Element.addEventListener("touchstart",function(){a.ox=event.targetTouches[0].pageX,a.oy=event.targetTouches[0].pageY}),this.Element.addEventListener("touchmove",function(){a.cx=event.targetTouches[0].pageX,a.cy=event.targetTouches[0].pageY,Math.abs(a.cy-a.oy)<Math.abs(a.cx-a.ox)&&event.stopPropagation()})}t.find("p").each(function(){var e=r(this).css("text-indent");e&&(e=parseInt(e.replace("px","")))<0&&r(this).css("text-indent",0)})}else r(this.Element).show(),r(this.Element).next().hasClass("Readonly")&&r(this.Element).next().remove()},Validate:function(e,t){if(!this.Editable)return!0;if(t&&this.Required&&!this.GetValue())return this.AddInvalidText(this.Element,"*",!1),!1;if(!e){var i=this.GetValue();if(this.Required&&!this.DoValidate(this.Valid.Required,[i],"*"))return!1;if(this.RegularExpression&&!this.DoValidate(this.Valid.RegularExpression,[i,this.RegularExpression],this.RegularInvalidText))return!1}return!0},GetValue:function(){var e;return e=null!=this.EditorObject&&""!=this.EditorObject&&void 0!==this.EditorObject&&this.RichTextBox?this.EditorObject.html():r(this.Element).val(),this.AutoTrim&&(e=e.trim()),e},SetValue:function(e){this.RichTextBox&&this.EditorObject?this.EditorObject.html(e):(this.RichTextBox||this.Editable||(e=e.replace(/\n/g,"<br/>")),r(this.Element).val(e))},SetFocus:function(){if(!this.RichTextBox)return this.Element.focus();this.EditorObject.focus()},SaveDataField:function(){var e={};if(!this.Editable)return e;if(e[this.DataField]=this.SheetInfo.BizObject.DataItems[this.DataField],!e[this.DataField])return-1==this.DataField.indexOf(".")&&alert(SheetLanguages.Current.DataItemNotExists+":"+this.DataField),{};var t=this.GetValue();return e[this.DataField].V!=t?(e[this.DataField].V=t,e):{}}})}(jQuery),function(r){r.fn.SheetTextBox=function(){return r.MvcSheetUI.Run.call(this,"SheetTextBox",arguments)},r.MvcSheetUI.Controls.SheetTextBox=function(e,t,i){this.TextRightAlign=!1,this.NumberRightAlign=!1,r.MvcSheetUI.Controls.SheetTextBox.Base.constructor.call(this,e,t,i)},r.MvcSheetUI.Controls.SheetTextBox.Inherit(r.MvcSheetUI.IControl,{Render:function(){if(this.Visiable){this.Element.maxLength="200",r(this.Element).attr("autocomplete","off");var e=r("<p class='text-length textbox-length'><span>0</span>/200</p>");if(this.TrackVisiable&&!this.Originate&&-1==this.DataField.indexOf(".")&&this.RenderDataTrackLink(),this.IsMobile?(this.PlaceHolder=this.PlaceHolder||SheetLanguages.Current.PleaseInput,"wechat"==r.MvcSheetUI.IonicFramework.$rootScope.loginfrom&&this.Element.addEventListener("touchstart",function(){event.stopPropagation()})):(this.PlaceHolder=this.PlaceHolder||"请输入",r(this.Element).css("position","relative"),this.Editable&&r(this.Element).parent().append(e)),r(this.Element).attr("PlaceHolder",this.PlaceHolder),r.MvcSheetUI.SheetInfo.SheetMode!=r.MvcSheetUI.SheetMode.Originate||this.V)this.Editable&&(this.DefaultValue&&""==this.V?this.SetValue(this.DefaultValue):this.SetValue(this.V));else{if(this.DefaultValue)if(-1<this.DefaultValue.indexOf("{")&&-1<this.DefaultValue.indexOf("}")){var t=this.DefaultValue.replace("{","").replace("}","");if(t){var i=r.MvcSheetUI.GetSheetDataItem(t,0);i&&r(this.Element).val(i.V)}}else r(this.Element).val(this.DefaultValue);else r(this.Element).val("");this.DefaultValue||""===this.V||this.Editable&&this.SetValue(this.V)}if(!this.Editable)return this.SetReadonly(!0),void this.SetValue(this.V);this.TextRightAlign?r(this.Element).addClass("txtAlignRight"):this.NumberRightAlign&&this.IsNubmer()&&r(this.Element).addClass("txtAlignRight"),this.ToolTip&&r(this.Element).attr("title",this.ToolTip),r(this.Element).unbind("change.SheetTextBox").bind("change.SheetTextBox",[this],function(e){e.data[0]._OnChange()}),r(this.Element).unbind("focus.SheetTextBox").bind("focus.SheetTextBox",[this],function(e){e.data[0].FormatRule&&(this.value=this.value.replace(/,/g,"").replace(/$/g,"").replace(/¥/g,"")),e.data[0].OnFocus&&e.data[0].RunScript(this,e.data[0].OnFocus)});var a=this;this.OnKeyUp&&r(this.Element).unbind("keyup.SheetTextBox").bind("keyup.SheetTextBox",[this],function(e){var t=e.target.value.length;e.data[0].RunScript(this,e.data[0].OnKeyUp),r(a.Element).siblings().children("span").html(t),200==t&&(r(a.Element).addClass("inputTextError"),r(a.Element).siblings().show(),setTimeout(function(){r(a.Element).removeClass("inputTextError"),r(a.Element).siblings().hide()},3e3))}),r(this.Element).unbind("keydown.SheetTextBox").bind("keydown.SheetTextBox",[this],function(e){var t=e.target.value.length;if("Enter"==e.key)return!1;e.data[0].OnKeyDown&&e.data[0].RunScript(this,e.data[0].OnKeyDown),r(a.Element).siblings().children("span").html(t),200==t&&(r(a.Element).addClass("inputTextError"),r(a.Element).siblings().show(),setTimeout(function(){r(a.Element).removeClass("inputTextError"),r(a.Element).siblings().hide()},3e3))}),r(this.Element).keyup(function(e){var t=e.target.value.length;r(a.Element).siblings().children("span").html(t),200==t&&(r(a.Element).addClass("inputTextError"),r(a.Element).siblings().show(),setTimeout(function(){r(a.Element).removeClass("inputTextError"),r(a.Element).siblings().hide()},3e3))}),r(this.Element).unbind("blur.SheetTextBox").bind("blur.SheetTextBox",[this],function(e){e.data[0].FormatRule&&""!=e.data[0].GetValue()&&e.data[0].GetFromatValue(r(e.data[0].Element),e.data[0].GetValue())}),this.IsMobile?this._mobilePopup():this._createPopup()}else this.Element.style.display="none"},IsNubmer:function(){return 7==this.LogicType||9==this.LogicType||35==this.LogicType},SetValue:function(e){r(this.Element).val(e),r(this.Element).change(),this.FormatRule&&this.GetFromatValue(r(this.Element),e),this.IsMobile&&this.Mask.html(this.GetText())},_mobilePopup:function(){if("None"!=this.PopupWindow){this.ID=r(this.Element).attr("Id"),r(this.Element).hide(),r(this.Element).parent().find("[id*=mask]").remove(),r(this.Element).parent().find("i.icon").remove(),this.Mask=r("<span></span>").insertAfter(this.Element).attr("id","mask_"+this.ID),this.Mask.text(this.GetText()),this.Mask.insertAfter(this.Element).attr("id","mask_"+this.ID);var e=this;e.Editable&&(this.pupIcon=r("<i class='icon ion-ios-arrow-right'></i>").insertAfter(this.Mask),r(this.Element).closest("div.item").addClass("item-icon-right"),r(this.Element).parent().parent().unbind("click.query").bind("click.query",function(){r.MvcSheetUI.IonicFramework.$state.go("form.sheetquery",{datafield:e.DataField,rownum:r(this).find("[data-datafield='"+e.DataField+"']").attr("data-row")})}))}},AfterMobileEditShow:function(){this.PopupElement&&this.PopupElement.SheetQuery().AfterMobileEditShow()},_createPopup:function(){var i=this;if("PopupWindow"===this.PopupWindow){var e=""===this.DisplayText?"&nbsp;":this.DisplayText;e=e.replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\"/g,"&quot;");var a="popupLink"+(new Date).getTime(),n="";""!=this.OutputMappings&&(n="&OutputParams="+encodeURI(this.OutputMappings.replace(/,/g,"|").replace(/:/g,",")));var t=i.PopupWidth?i.PopupWidth:"600px",s=i.PopupHeight?i.PopupHeight:"400px",l="<div id='"+a+"' class='modal fade' tabindex='-1' role='dialog' aria-hidden='true'>";l+="<div class='modal-dialog'>",l+="<div class='modal-content' style='width:"+t+";'>",l+="<div class='modal-header'>",l+="<button type='button' class='close' data-dismiss='modal'>",l+="<span aria-hidden='true'>&times;</span></button>",l+="<h4 class='modal-title'>"+e+"</h4>",l+="</div><div class='modal-body'>",l+="<iframe scrolling='no' frameborder='0' width='100%' height='"+s+"'></iframe>",l=r(l+="</div></div></div></div>");var h=r("<a href='javascript:;'>"+e+"</a>");h.click(function(){var e="";e=-1<(void 0===i.Element.id?"":i.Element.id).indexOf("mutiselect")?i.PortalRoot+"/admin/TabMaster.html?url=ListMasterDataNew.html&OpenType=1&IsPopup=1&SchemaCode="+i.SchemaCode+"&QueryCode="+i.QueryCode+"&CtrlID="+a+n+i._getInputParam():i.PortalRoot+"/admin/TabMaster.html?url=ListMasterData.html&OpenType=1&IsPopup=1&SchemaCode="+i.SchemaCode+"&QueryCode="+i.QueryCode+"&CtrlID="+a+n+i._getInputParam(),l.find("iframe").attr("src",e),l.modal("show")}),r(this.Element).after(h).after(l),window[a]={},window[a].ListMasterCallBack=function(e){if(e)for(var t in e)r.MvcSheetUI.SetControlValue(t,e[t],i.GetRowNumber());l.modal("hide")}}else if("Dropdown"===this.PopupWindow){a="popupLink"+(new Date).getTime(),n="";""!=this.OutputMappings&&(n="&OutputParams="+encodeURI(this.OutputMappings.replace(/,/g,"|").replace(/:/g,",")));l=r("<div style='display:none;z-index:9999;position:absolute;background-color:#f8f8f8;' id='"+a+"'><iframe scrolling='no' frameborder='0' width='550px' height='300px'></iframe></div>");r(this.Element).after(l),r(this.Element).after(h).after(l),r(this.Element).unbind("focus.Popup").bind("focus.Popup",function(){!function(){var e="";r.MvcSheetUI.QueryString("SheetCode"),e=-1<(null==i.Element.id?"":i.Element.id).indexOf("mutiselect")?i.PortalRoot+"/admin/TabMaster.html?url=ListMasterDataNew.html&OpenType=1&IsPopup=1&SchemaCode="+i.SchemaCode+"&QueryCode="+i.QueryCode+"&CtrlID="+a+n+i._getInputParam():i.PortalRoot+"/admin/TabMaster.html?url=ListMasterData.html&OpenType=1&IsPopup=1&SchemaCode="+i.SchemaCode+"&QueryCode="+i.QueryCode+"&CtrlID="+a+n+i._getInputParam(),l.find("iframe").attr("src",e),l.show();var t=r(i.Element).offset();l.offset({top:t.top+r(i.Element).outerHeight()+3,left:t.left})}()}),window[a]={},window[a].ListMasterCallBack=function(e){if(e)for(var t in e)r.MvcSheetUI.SetControlValue(t,e[t],i.GetRowNumber());l.hide()},r(document).unbind("click."+a).bind("click."+a,function(e){"text"==r(e.target).attr("type")&&r(e.target).attr(r.MvcSheetUI.PreDataKey+r.MvcSheetUI.DataFieldKey.toLowerCase())==i.DataField||l.hide()})}},_getInputParam:function(){var e="";if(this.InputMappings){for(var t=this.InputMappings.split(","),i=0;i<t.length;i++){var a=t[i].split(":");a&&2==a.length&&a[0]&&r.MvcSheetUI.GetSheetDataItem(a[0],this.GetRowNumber())&&(e+=a[1]+","+r.MvcSheetUI.GetControlValue(a[0],this.GetRowNumber())+"|")}e=e&&"&InputParam="+encodeURI(e.substring(0,e.length-1))}return e},SetReadonly:function(e){if(e){r(this.Element).hide();var t=r("<label for='"+r(this.Element).attr("id")+"'></label>");this.TextRightAlign?t.addClass("txtAlignRight").css("width",r(this.Element).width()):this.NumberRightAlign&&this.IsNubmer()&&t.addClass("txtAlignRight");var i=r.trim(this.V);if(""!=i){var a=i.split("\n");r(a).each(function(e){0<e&&t.append("<br />"),t.append(r("<span></span>").text(this.toString()))})}t.insertAfter(r(this.Element)),this.GetFromatValue(t,i),this.IsMobile&&this.Mask.html(this.GetText())}else r(this.Element).show(),r(this.Element).next().remove()},_OnChange:function(e){this.Validate(),this.OnChange&&this.RunScript(this.Element,this.OnChange),this.AutoTrim&&(this.Value=that.Value.trim())},Validate:function(e,t){if(!this.Editable)return!0;if(t&&this.Required&&!this.GetValue())return this.AddInvalidText(this.Element,"*",!1),!1;var i=this.GetValue();if(!e){if(r(this.Element).attr("data-required")||-1<this.O.indexOf("R")?this.Required=!0:this.Required=!1,this.Required&&!this.DoValidate(this.Valid.Required,[i],"*"))return this.ValidateResult=!1;if(this.RegularExpression&&i&&(this.RegularInvalidText=this.RegularInvalidText.replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\"/g,"&quot;"),!this.DoValidate(this.Valid.RegularExpression,[i,this.RegularExpression],this.RegularInvalidText)))return this.ValidateResult=!1}switch(this.LogicType){case r.MvcSheetUI.LogicType.Int:if(!this.DoValidate(this.Valid.Integer,[i],SheetLanguages.Current.EnterInteger))return this.ValidateResult=!1;if(!this.DoValidate(this.Valid.VerifyIntRange,[i],SheetLanguages.Current.VerifyIntRange))return this.ValidateResult=!1;break;case r.MvcSheetUI.LogicType.Long:if(!this.DoValidate(this.Valid.Integer,[i],SheetLanguages.Current.EnterInteger))return this.ValidateResult=!1;if(!this.DoValidate(this.Valid.VerifyLongRange,[i],SheetLanguages.Current.VerifyLongRange))return this.ValidateResult=!1;break;case r.MvcSheetUI.LogicType.Double:if(!this.DoValidate(this.Valid.Number,[i],SheetLanguages.Current.EnterNumber))return this.ValidateResult=!1}return this.ValidateResult=!0},SaveDataField:function(){var e={};return this.Visiable&&this.Editable?(e[this.DataField]=r.MvcSheetUI.GetSheetDataItem(this.DataField),e[this.DataField]?(this.RefreshDataTrackLink(),e[this.DataField].V=this.GetValue().trim(),e):(-1==this.DataField.indexOf(".")&&alert(SheetLanguages.Current.DataItemNotExists+":"+this.DataField),{})):e}})}(jQuery),function(r){r.fn.SheetTime=function(){return r.MvcSheetUI.Run.call(this,"SheetTime",arguments)},r.MvcSheetUI.Controls.SheetTime=function(e,t,i){e.removeAttribute("data-viewinnewcontainer"),r.MvcSheetUI.Controls.SheetTime.Base.constructor.call(this,e,t,i)},r.MvcSheetUI.Controls.SheetTime.Inherit(r.MvcSheetUI.IControl,{Render:function(){var e=r(this.Element),t=this.V,i=this;if(this.Visiable){var a;if(this.Originate&&this.Editable||this.Editable&&!t&&"CurrentTime"===this.DefaultValue)if(t&&"0001-01-01 00:00:00"!==t&&"1753-01-01 00:00:00"!==t&&"9999-12-31 00:00:00"!==t)a=new Date(Date.parse(t.replace(/-/g,"/")));else if("CurrentTime"===this.DefaultValue)a=new Date;else{var n=Date.parse(this.DefaultValue.replace(/-/g,"/"));isNaN(n)||(a=new Date(n))}else(""!==this.DefaultValue&&null!=this.DefaultValue||"1970-01-01 00:00:00"!=this.V.toString())&&t?(a="0001-01-01 00:00:00"==t||"1753-01-01 00:00:00"==t||"9999-12-31 00:00:00"==t?"":new Date(Date.parse(t.replace(/-/g,"/"))),"1970-01-01 00:00:00"==t&&(a=new Date)):a="";if("LBInitTime"==this.DefaultValue&&(a=""),!this.Editable)return e.after("<label style='width:100%;'>"+this._getDateTimeFormatString(a).replace(/T/g," ").replace("/Z/g","")+"</label>"),void e.hide();if(this.IsMobile){var s;switch(this.TimeMode){case"FullTime":case"SimplifiedTime":s="datetime-local";break;case"OnlyDate":s="date";break;case"OnlyTime":s="time";break;default:s="date"}e.attr("type","text"),e.attr("placeholder",SheetLanguages.Current.PleaseInput);i=this;this.ionicInit(i,e,s,r.MvcSheetUI.IonicFramework);var l=window.navigator.userAgent.toLowerCase();"micromessenger"==l.match(/MicroMessenger/i)&&l.toLowerCase().indexOf("android"),this.Element.addEventListener("touchend",function(){event.stopPropagation()}),this.Element.addEventListener("touchstart",function(){event.stopPropagation()}),e.val(this._getDateTimeFormatString(a).replace("T"," "));i=this;e.unbind("change.SheetTime").bind("change.SheetTime",function(){i.Validate(),i.OnChange&&i.RunScript(this,i.OnChange)})}else{var h;if(this.TrackVisiable&&!this.Originate&&-1==this.DataField.indexOf(".")&&this.RenderDataTrackLink(),e.val(this._getDateTimeFormatString(a)),e.attr("onclick","WdatePicker("+this._getWdatePickerJson()+")"),e.attr("onchange",""),window.ActiveXObject||"ActiveXObject"in window?e[0].onchange=function(){i.Validate(),i.OnChange&&i.RunScript(this,i.OnChange)}:e.unbind("change.SheetTime").bind("change.SheetTime",function(){i.Validate(),i.OnChange&&i.RunScript(this,i.OnChange)}),"CurrentTime"!=this.MinValue&&isNaN(Date.parse(this.MinValue.replace(/-/g,"/"))))(h=r.MvcSheetUI.GetElement(this.MinValue))&&h.unbind("blur.MinValue").bind("blur.MinValue",function(){e.attr("onclick","WdatePicker("+i._getWdatePickerJson()+")")});if("CurrentTime"!=this.MaxValue&&isNaN(Date.parse(this.MaxValue.replace(/-/g,"/"))))(h=r.MvcSheetUI.GetElement(this.MaxValue))&&h.unbind("blur.MaxValue").bind("blur.MaxValue",function(){e.attr("onclick","WdatePicker("+i._getWdatePickerJson()+")")})}}else this.Element.style.display="none"},ionicInit:function(n,s,e,t){s.attr("readonly","readonly"),t.$scope.dateTimeTitle="选择日期";var i=n.DataField.replace(".","")+"element";t.$scope[i]=s,t.$scope.cancelClick=function(e){e.val("")},s.parent().parent().attr("ion-datetime-picker",""),s.parent().parent().attr("data-title","dateTimeTitle"),s.parent().parent().attr("cancel-Click","cancelClick"),s.parent().parent().attr("element",i),s.parent().parent().attr(e,""),"SimplifiedTime"!=n.TimeMode&&s.parent().parent().attr("seconds","");var a=n.DataField+n.Options.RowNum;s.parent().parent().attr("ng-model",a),t.$compile(s.parent().parent())(t.$scope),t.$scope[a]=new Date,t.$scope.$watch(a,function(e,t){var i=new Date(Date.parse(n.MinValue.replace(/-/g,"/"))),a=new Date(Date.parse(n.MaxValue.replace(/-/g,"/")));if(e&&e<i)alert("不能小于设置的最小时间");else if(a<e)alert("不能大于设置的最大时间");else{if("Invalid Date"==e||e===t)return;e?n._SetValue(new Date(e)):n._SetValue(""),n.RunScript(s,n.OnChange),s.change(),n.Validate()}})},MobilePreBack:function(){return $dp&&"function"==typeof $dp.hide&&$dp.hide(),!0},_getDateTimeFormatString:function(e){if(!e)return"";var t=e.getMonth()+1<10?"0"+(e.getMonth()+1):e.getMonth()+1,i=e.getDate()<10?"0"+e.getDate():e.getDate(),a=e.getHours()<10?"0"+e.getHours():e.getHours(),n=e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes(),s=e.getSeconds()<10?"0"+e.getSeconds():e.getSeconds(),l=e.getFullYear()+"-"+t+"-"+i,h=a+":"+n+":"+s,r=a+":"+n;switch(this.TimeMode){case"OnlyDate":return l;case"FullTime":return l+" "+h;case"OnlyTime":return h;case"SimplifiedTime":return l+" "+r;default:return l}},_getWdatePickerJson:function(){if(""!=this.WdatePickerJson)return this.WdatePickerJson;var e,t,i="";switch(this.TimeMode){case"OnlyDate":i+="dateFmt:'yyyy-MM-dd'";break;case"FullTime":i+="dateFmt:'yyyy-MM-dd HH:mm:ss'";break;case"OnlyTime":i+="dateFmt:'HH:mm:ss'";break;case"SimplifiedTime":i+="dateFmt:'yyyy-MM-dd HH:mm'";break;default:i+="dateFmt:'yyyy-MM-dd'"}if(""!=this.MinValue)if("CurrentTime"==this.MinValue)e=new Date;else{var a=Date.parse(this.MinValue.replace(/-/g,"/"));if(isNaN(a)){if(n=r(":text["+r.MvcSheetUI.PreDataKey+r.MvcSheetUI.DataFieldKey.toLowerCase()+"='"+this.MinValue+"']")){a=Date.parse(n.val().replace(/-/g,"/"));isNaN(a)||(e=new Date(a))}}else e=new Date(a)}if(null!=e&&(i+=",minDate:'"+this._getDateTimeFormatString(e)+"'"),""!=this.MaxValue)if("CurrentTime"==this.MaxValue)t=new Date;else{var n;a=Date.parse(this.MaxValue.replace(/-/g,"/"));if(isNaN(a)){if(n=r(":text["+r.MvcSheetUI.PreDataKey+r.MvcSheetUI.DataFieldKey.toLowerCase()+"='"+this.MaxValue+"']")){a=Date.parse(n.val().replace(/-/g,"/"));isNaN(a)||(t=new Date(a))}}else t=new Date(a)}return null!=t&&(i+=",maxDate:'"+this._getDateTimeFormatString(t)+"'"),"{"+i+"}"},GetText:function(){return r(this.Element).val().replace(/T/g," ").replace(/Z/g,"")},SetValue:function(e){if(e){Array.isArray(e)&&1===e.length&&(e=e[0]);var t=Date.parse(e.replace(/T/g," ").replace(/-/g,"/"));if(!isNaN(t)){var i=new Date(t);r(this.Element).val(this._getDateTimeFormatString(i))}}},_SetValue:function(e){var t=this._getDateTimeFormatString(e);t=t.replace("T"," "),r(this.Element).val(t)},GetValue:function(){return this.Editable?r(this.Element).val():r(this.Element).siblings("label").html()},SaveDataField:function(){var e={};if(!this.Visiable||!this.Editable)return e;if(this.DataField){var t=r.MvcSheetUI.GetSheetDataItem(this.DataField);if(t){var i=r(this.Element).val();"OnlyTime"==this.TimeMode&&(i="1970-01-01 "+i),e[this.DataField]=t,e[this.DataField].V=i}else-1==this.DataField.indexOf(".")&&alert(SheetLanguages.Current.DataItemNotExists+":"+this.DataField)}return e}})}(jQuery),function(a){a.fn.SheetTimeSpan=function(){return a.MvcSheetUI.Run.call(this,"SheetTimeSpan",arguments)},a.MvcSheetUI.Controls.SheetTimeSpan=function(e,t,i){a.MvcSheetUI.Controls.SheetTimeSpan.Base.constructor.call(this,e,t,i)},a.MvcSheetUI.Controls.SheetTimeSpan.Inherit(a.MvcSheetUI.IControl,{Render:function(){null!=this.V&&0<this.V.indexOf(",")&&(this.V=this.V.replace(/,/g,""));var i=this;if($element=a(this.Element),this.Visiable){this.TrackVisiable&&!this.Originate&&-1==this.DataField.indexOf(".")&&this.RenderDataTrackLink();var e=this._getTimeSpan(this.V);if(this.Editable){var t=this.IsMobile?"35px":"30px";this.$dayElement=a("<input type='number' min='0' max='99999999' style='width:58px;height:"+t+";padding-left:3px;margin:0px 2px 0px 0px' />").val(e.day),this.$hourElement=a("<input type='number' min='0' max='23' style='width:39px;height:"+t+";padding-left:3px;margin:0px 2px 0px 2px;' />").val(e.hour),this.$minuteElement=a("<input type='number' min='0' max='59' style='width:39px;height:"+t+";padding-left:3px;margin:0px 2px 0px 2px' />").val(e.minute),this.$secondElement=a("<input type='number' min='0' max='59' style='width:39px;height:"+t+";padding-left:3px;margin:0px 2px 0px 2px' />").val(e.second),$element.append(this.$dayElement,document.createTextNode(SheetLanguages.Current.Day),this.$hourElement,document.createTextNode(SheetLanguages.Current.Hour),this.$minuteElement,document.createTextNode(SheetLanguages.Current.Minute),this.$secondElement,document.createTextNode(SheetLanguages.Current.Second)),this.$dayElement.unbind("keyup.SheetTimeSpan").bind("keyup.SheetTimeSpan",function(e){var t=a(this).val();i._isDay(t)?8<t.length&&(a(this).val("0"),i._focusText(this)):(a(this).val("0"),i._focusText(this))}),this.$hourElement.unbind("keyup.SheetTimeSpan").bind("keyup.SheetTimeSpan",function(){var e=a(this).val();i._isHour(e)||(a(this).val("0"),i._focusText(this))}),this.$minuteElement.unbind("keyup.SheetTimeSpan").bind("keyup.SheetTimeSpan",function(){var e=a(this).val();i._isMinuteOrSecond(e)||(a(this).val("0"),i._focusText(this))}),this.$secondElement.unbind("keyup.SheetTimeSpan").bind("keyup.SheetTimeSpan",function(){var e=a(this).val();i._isMinuteOrSecond(e)||(a(this).val("0"),i._focusText(this))}),$element.find("input").unbind("focus.SheetTimeSpan").bind("focus.SheetTimeSpan",function(){i._focusText(this)}),$element.find("input").unbind("change.SheetTimeSpan").bind("change.SheetTimeSpan",function(){i.Validate(),i.OnChange&&(i.Element.value=i.GetValue(),i.RunScript(i.Element,i.OnChange))})}else $element.after("<label style='width:100%;'>"+this._getLabelText(e)+"</label>"),$element.hide()}else $element.hide()},_focusText:function(e){this.IsMobile&&a.os.ios?e.setSelectionRange(0,9999):a(e).select()},RenderMobile:function(){if(this.Editable){this.constructor.Base.RenderMobile.apply(this);this._isNotEmpty()?this.Mask.css({color:"#2c3038"}):this.Mask.css({color:"#797f89"}),this.ionicInit(this,a.MvcSheetUI.IonicFramework)}else this.Render()},ionicInit:function(s,l){s.Mask.parent().parent().unbind("click.showTimespan").bind("click.showTimespan",function(){l.$scope.data={day:s.$dayElement.val()-0,hour:s.$hourElement.val()-0,min:s.$minuteElement.val()-0,second:s.$secondElement.val()-0,dataField:s.DataField},l.$ionicPopup.show({templateUrl:"Mobile/form/templates/timeSpanTemp.html",title:"填写时间段",scope:l.$scope,cssClass:"timespan-popup",buttons:[{text:SheetLanguages.Current.Cancel,onTap:function(e){}},{text:"<b>"+SheetLanguages.Current.OK+"</b>",type:"button-calm",onTap:function(e){s.$dayElement.val(l.$scope.data.day),s.$hourElement.val(l.$scope.data.hour),s.$minuteElement.val(l.$scope.data.min),s.$secondElement.val(l.$scope.data.second),s.Validate(),s._SetValue(l.$scope.data)}}]}),l.$scope.DateChange=function(e){if("day"==e){var t=l.$scope.data.day||0;t=t<0?0:99999999<t?99999999:t,l.$scope.data.day=t}else if("hour"==e){var i=l.$scope.data.hour||0;i=i<0?0:23<i?23:i,l.$scope.data.hour=i}else if("min"==e){var a=l.$scope.data.min||0;a=a<0?0:59<a?59:a,l.$scope.data.min=a}else if("second"==e){var n=l.$scope.data.second||0;n=n<0?0:59<n?59:n,l.$scope.data.second=n}s.OnChange&&(s.Element.value=s.GetValue(),s.RunScript(s.Element,s.OnChange))}})},_getTimeSpan:function(e){var t={};if(e){var i=e.indexOf("."),a=e;-1<i&&(t.day=parseInt(e.substring(0,i)),a=e.substring(i+1));var n=a.split(":");n&&3==n.length&&(t.hour=parseInt(n[0]),t.minute=parseInt(n[1]),t.second=parseInt(n[2]))}return t.day||(t.day=0),t.hour||(t.hour=0),t.minute||(t.minute=0),t.second||(t.second=0),t},_isDay:function(e){return/^\d+$/.test(e)},_isHour:function(e){return/^([0-1]?[0-9]|2[0-3])$/.test(e)},_isMinuteOrSecond:function(e){return/^[0-5]?[0-9]$/.test(e)},_getLabelText:function(e){return 0!=e.day?e.day+SheetLanguages.Current.Day+e.hour+SheetLanguages.Current.Hour+e.minute+SheetLanguages.Current.Minute+e.second+SheetLanguages.Current.Second:0!=e.hour?e.hour+SheetLanguages.Current.Hour+e.minute+SheetLanguages.Current.Minute+e.second+SheetLanguages.Current.Second:0!=e.minute?e.minute+SheetLanguages.Current.Minute+e.second+SheetLanguages.Current.Second:e.second+SheetLanguages.Current.Second},GetText:function(){var e=this.GetValue();if(e){var t=this._getTimeSpan(e);return this._getLabelText(t)}return""},GetValue:function(){if(!this.Editable)return this.V;var e=this.$dayElement.val(),t=this.$hourElement.val(),i=this.$minuteElement.val(),a=this.$secondElement.val();return e||t||i||a?(e||"0")+"."+(t||"0")+":"+(i||"0")+":"+(a||"0"):null},SetValue:function(e){if(this.Editable){var t=this._getTimeSpan(e);t&&(this.$dayElement.val(t.day),this.$hourElement.val(t.hour),this.$minuteElement.val(t.minute),this.$secondElement.val(t.second)),this.IsMobile&&this.Mask.html(this.GetText())}},_GetValue:function(e){var t=e.day,i=e.hour,a=e.min,n=e.second;return t||i||a||n?(t||"0")+"."+(i||"0")+":"+(a||"0")+":"+(n||"0"):null},_SetValue:function(e){this._isNotEmpty()?this.Mask.css({color:"#2c3038"}):this.Mask.css({color:"#797f89"}),this.SetValue(this._GetValue(e)),this.Mask.html(this.GetText())},_isNotEmpty:function(){var e=parseInt(this.$dayElement.val()),t=parseInt(this.$hourElement.val()),i=parseInt(this.$minuteElement.val()),a=parseInt(this.$secondElement.val());return e||t||i||a},Validate:function(e,t){return!this.Editable||(t&&this.Required&&!this._isNotEmpty()?(this.AddInvalidText(this.Element,"*",!1),!1):e||!this.Required||this.DoValidate(this._isNotEmpty,[],"*")?this.ValidateResult=!0:this.ValidateResult=!1)},SaveDataField:function(){var e={};if(!this.Visiable||!this.Editable)return e;if(this.DataField){var t=a.MvcSheetUI.GetSheetDataItem(this.DataField);if(t){var i=this.GetValue();e[this.DataField]=t,e[this.DataField].V=i}else-1==this.DataField.indexOf(".")&&alert(SheetLanguages.Current.DataItemNotExists+":"+this.DataField)}return e}})}(jQuery),function(c){c.fn.SheetUser=function(){return c.MvcSheetUI.Run.call(this,"SheetUser",arguments)};var r=!0;c.MvcSheetUI.Controls.SheetUser=function(e,t,i){this.Choices={},this.ChoicesElement=null,this.SearchElement=null,this.SearchTxtElement=null,this.SearchButton=null,this.SelectedValue=null,this.SearchKey=null,this.SearchMode=!1,this.KeyTime=null,this.SearchResults=[],this.SelectorPanel=null,this.EnterSearch=!0,this.OrgTreePanel=null,this.OrgListPanel=null,this.IsOverSelectorPanel=!1;var a=c.MvcSheetUI.PortalRoot?c.MvcSheetUI.PortalRoot:"/Portal";this.SheetUserHandler=c.MvcSheetUI.PortalRoot+"/SheetUser/LoadOrgTreeNodes",this.SheetGetUserProperty=c.MvcSheetUI.PortalRoot+"/SheetUser/GetUserProperty",this.SheetGetUserProperty=a+"/SheetUser/GetUserProperty",this.ModelControl=null,c.MvcSheetUI.Controls.SheetUser.Base.constructor.call(this,e,t,i)},c.MvcSheetUI.Controls.SheetUser.Inherit(c.MvcSheetUI.IControl,{RenderMobile:function(){if(this.IsMultiple=this.LogicType==c.MvcSheetUI.LogicType.MultiParticipant,this.Editable){this.MoveToMobileContainer();this.ionicInit(this,c.MvcSheetUI.IonicFramework)}else c(this.Element).prop("readonly",!0),c(this.Element).addClass(this.Css.Readonly),c(this.Element).addClass("item-content");this.InitValue()},ionicInit:function(n,s){if("fetchUserSelect"==n.DataField||"transferUserSelect"==n.DataField||"copyToUserSelect"==n.DataField){s.TempScope=s.$scope,s.$scope=c.MvcSheetUI.IonicFramework.$scopeFetchUser;n.GetLoadTreeOption();var e=n.SheetUserHandler+"?IsMobile=true&Recursive="+n.Recursive,l=encodeURI(n.DataField).replace(/%/g,"_")+n.Options.RowNum;n.Mask.parent().addClass("item-icon-right"),n.Mask.after('<i class="icon ion-ios-arrow-right"></i>');var t=l;if(-1<t.indexOf(".")&&(t=t.replace(".","_")),s.$scope["sheetUsers"+t]=n.ConvertIonicItems(n.GetChoices()),n.Editable?s.$scope.sheetShow=!0:s.$scope.sheetShow=!1,n.V&&!n.Editable&&n.IsMultiple){var i=[],a=[];n.V.forEach(function(e,t){"U"==e.ContentType?i.push(e):a.push(e)});var h=c.format(SheetLanguages.Current.Record,i.length,a.length);n.Mask.parent().before('<span class="record">'+h+"</span>")}n.Mask.parent().parent().after('<div class="line"></div>'),"fetchUserSelect"!=n.DataField&&"transferUserSelect"!=n.DataField&&"copyToUserSelect"!=n.DataField||n.Mask.parent().parent().after('<bpm-sheet-user-selected sheet-show="sheetShow" tag-name="'+t+'"  select-users="sheetUsers'+t+'" cancel-selected="delUserItem"></bpm-sheet-user-selected>'),n.Mask.parent().parent().attr("data-scopedata",l),n.Mask.parent().parent().attr("data-loadurl",e),n.Mask.parent().parent().attr("data-datafield",l),n.Editable?n.Mask.parent().parent().unbind("click.sheetUser").bind("click.sheetUser",function(){var e=c(this).attr("data-scopedata"),t=c(this).attr("data-loadurl");"fetchUserSelect"==n.DataField||"transferUserSelect"==n.DataField||"copyToUserSelect"==n.DataField?s.$scope=c.MvcSheetUI.IonicFramework.$scopeFetchUser:s.TempScope&&(s.$scope=s.TempScope);var i=s.$scope[l],a={options:i.Options,selecFlag:n.GetSelectableFlag(),dataField:e,ngmodel:l,loadUrl:t,loadOptions:i.GetLoadTreeOption(),initUsers:i.GetChoices(),isMutiple:i.IsMultiple};c.MvcSheetUI.sheetUserParams=a,s.$state.go("form.sheetuser",{index:0,parentID:""})}):n.Mask.parent().css("display","none"),s.$compile(n.Mask.parent().parent().next())(s.$scope),s.$scope[l]=n}else{n.GetLoadTreeOption(),e=n.SheetUserHandler+"?IsMobile=true&Recursive="+n.Recursive,l=n.DataField+n.Options.RowNum;n.Mask.parent().addClass("item-icon-right"),n.Mask.after('<i class="icon ion-ios-arrow-right"></i>'),n.Mask.parent().parent().attr("data-scopedata",n.DataField),n.Mask.parent().parent().attr("data-loadurl",e),n.Mask.parent().parent().attr("data-datafield",n.DataField),n.Mask.parent().parent().unbind("click.sheetUser").bind("click.sheetUser",function(){var e=c(this).attr("data-scopedata"),t=c(this).attr("data-loadurl"),i=s.$scope[l],a={options:i.Options,selecFlag:n.GetSelectableFlag(),dataField:e,ngmodel:l,loadUrl:t,loadOptions:i.GetLoadTreeOption(),initUsers:i.GetChoices(),isMutiple:i.IsMultiple};c.MvcSheetUI.sheetUserParams=a,s.$state.go("form.sheetuser",{index:0,parentID:""})})}s.$scope[l]=n},ConvertIonicItems:function(e){var a=[];if(e)if(e.constructor==Object){var t={id:e.ObjectID,name:e.Name,type:e.type,UserGender:e.UserGender,UserImageUrl:e.UserImageUrl};a.push(t)}else e.forEach(function(e,t){var i={id:e.ObjectID,name:e.Name,type:e.type,UserGender:e.UserGender,UserImageUrl:e.UserImageUrl};a.push(i)});return a},ClearChoices:function(){for(var e in this.Choices)this.RemoveChoice(e);this.OnMobileChange()},RemoveChoice:function(e){this.Choices[e]&&(this.IsMobile,c("#"+this.Choices[e].ChoiceID).remove(),delete this.Choices[e]),this.SetSearchTxtElementWidth.apply(this),this.Validate(),this.OnMobileChange(),this.OnChange&&this.RunScript(this,this.OnChange,[this])},Render:function(){this.Visiable?(this.TrackVisiable&&!this.Originate&&-1==this.DataField.indexOf(".")&&this.RenderDataTrackLink(),this.IsMultiple=this.Options.IsMultiple||this.LogicType==c.MvcSheetUI.LogicType.MultiParticipant,this.Editable?(this.ClearChoices(),this.IsLoaded=!1,this.SelectedValue="",this.__QueryOptions="",this.HtmlRender(),this.BindEnvens()):(c(this.Element).prop("readonly",!0),c(this.Element).addClass(this.Css.Readonly),c(this.Element).css("padding-top","6px")),this.InitValue()):this.Element.style.display="none"},InitValue:function(){this.Originate&&!this.V&&this.DefaultValue&&(this.V=this.DefaultValue,this.V.constructor==String&&("originator"==this.V.toLowerCase()||"{originator}"==this.V.toLowerCase()?this.V=this.SheetInfo.Originator:"{originator.ou}"!=this.V.toLowerCase()&&"originator.ou"!=this.V.toLowerCase()||(this.V=this.SheetInfo.OriginatorOU))),this.SetValue(this.V)},SetRootUnit:function(e){this.RootUnitID=RootUnitID,this.TreeManager.clear(),this.TreeManager.loadData(null,this.SheetUserHandler+"?RootUnitID="+this.RootUnitID)},SetValue:function(e){if(null==e||null==e||""==e)return this.IsMobile?void(this.Editable?(this.PlaceHolder?this.Mask.text(this.PlaceHolder):this.Mask.text(SheetLanguages.Current.PleaseSelect),this.Mask.css({color:"#797f89"})):this.Mask.html(this.PlaceHolder)):void 0;if(e.constructor==Object)this.AddChoice({ObjectID:e.Code,Name:e.Name,type:e.ContentType,UserGender:e.UserGender,UserImageUrl:e.UserImageUrl});else if(e.constructor==Array){for(var t=0;t<e.length;t++)if(e[t].constructor==Object)this.AddChoice({ObjectID:e[t].Code,Name:e[t].Name,type:e[t].ContentType,UserGender:e[t].UserGender,UserImageUrl:e[t].UserImageUrl});else if(e[t].constructor==String&&(this.AddUserID(e[t]),!this.IsMultiple))break}else if(e.constructor==String)if(-1<e.indexOf("[")){var i=e.replace("[","").replace("]","").replace(" ","").split(",");for(t=0;t<i.length&&(this.AddUserID(i[t]),this.IsMultiple);t++);}else this.AddUserID(e);if(this.IsMobile)if(this.Editable)this.Mask.html(this.GetText()),this.Mask.css({color:"#2c3038"});else{this.GetText();var a=c("<label>").html(this.GetText());c(c(this.Element).html("")).append(a)}},GetValue:function(){var e;for(var t in this.Choices)this.IsMultiple?(null==e&&(e=new Array),e.push(t)):e=t;return null==e?"":e},GetChoices:function(){var e;for(var t in this.Choices)this.IsMultiple?(null==e&&(e=new Array),e.push(this.Choices[t])):e=this.Choices[t];return null==e?[]:e},GetText:function(){var e;for(var t in this.Choices)this.IsMultiple?(null==e&&(e=new Array),e.push(this.Choices[t].Name)):e=this.Choices[t].Name;return null==e?"":e.toString()},SaveDataField:function(){var e={};if(!this.Visiable||!this.Editable)return e;if(e[this.DataField]=this.DataItem,!e[this.DataField])return-1==this.DataField.indexOf(".")&&alert(SheetLanguages.Current.DataItemNotExists+":"+this.DataField),{};var t=this.GetValue();return e[this.DataField].V=t,e},HtmlRender:function(){if(this.ID=c(this.Element).attr("ID")||c.MvcSheetUI.NewGuid(),c(this.Element).attr("ID",this.ID),c(this.Element).css("z-index","inherit"),c(this.Element).addClass("select2-container select2-container-multi ").attr("data-sheetusercontrol",!0),c(this.Element).css("min-width","150px"),null==this.ChoicesElement&&(this.ChoicesElement=c("<ul>").addClass("select2-choices").css("overflow","hidden"),this.SearchElement=c("<li>").addClass("select2-search-field"),this.SearchTxtElement=c("<input>").addClass("form-control").addClass("no-padding"),this.SearchTxtElement.width("1px"),this.SearchElement.append(this.SearchTxtElement),this.ChoicesElement.append(this.SearchElement),c(this.Element).append(this.ChoicesElement)),this.SetSearchTxtElementWidth.apply(this),!this.Editable)return c(this.SearchTxtElement).prop("readonly",!0),c(this.SearchElement).width("100%"),c(this.SearchElement).addClass(this.Css.Readonly),this.SearchTxtElement.closest("ul").css("border","0px"),void this.SearchTxtElement.width("100%");null==this.SelectorPanel&&(this.SelectorPanel=c("<div>").addClass("bordered").addClass("SelectorPanel").css("position","absolute").css("z-index","888").width("100%").css("min-width","500px").css("height","300px").css("display","none").css("background-color","#FFFFFF").css("left","0").attr("data-SheetUserPanel","SelectorPanel"),this.OrgTreePanel=c("<div>").css("max-width","40%").css("width","40%").addClass("bordered").css("float","left").height("100%").css("overflow","scroll"),this.SelectorPanel.append(this.OrgTreePanel),this.OrgListPanel=c("<div>").height("100%").css("overflow-y","auto"),this.PanelSelectAll=c('<div class="task" style="padding: 5px 10px; border-bottom: 1px solid rgb(228, 228, 228); cursor: pointer;"><i class="task-sort-icon fa  fa fa-user"></i><span class="task-title" style="word-break: break-all;margin-top: 0;flex-grow:1;padding-left: 4px">'+c.Lang("ReportDesigner.SelectAll")+'</span><div class="action-checkbox pull-right"><input type="checkbox"   id="selectAll" style="height: auto; margin: 0; display: inline-block;"></div></div>'),this.SelectorPanel.append(this.OrgListPanel),c(this.Element).append(this.SelectorPanel)),!this.Recursive||this.RoleName||this.OrgPostCode||this.UserCodes?(this.OrgTreePanel.hide(),this.SelectorPanel.css("min-width","0px")):(this.OrgTreePanel.show(),this.SelectorPanel.css("min-width","500px"))},BindEnvens:function(){var i=this;if(i.canSearch=!0,this.Editable){if(c(this.ChoicesElement).unbind("click.SheetUser").bind("click.SheetUser",this,function(e){e.data.SearchTxtElement.focus()}),c(this.SearchTxtElement).unbind("focusin.SearchTxtElement").bind("focusin.SearchTxtElement",this,function(e){e.data.FocusInput.apply(e.data)}),!this.Recursive){var a=this;return c.ajax({type:"GET",url:this.SheetUserHandler+"?Recursive=false&"+this.GetLoadTreeOption(),dataType:"json",success:function(e){for(var t=0;t<e.length;++t)e[t].Text=e[t].Text,e[t].Code=e[t].Code,a.AddListItem.apply(a,[e[t]])}}),this.IsMobile||c(document).unbind("click."+this.ID).bind("click."+this.ID,this,function(e){0==c(e.target).closest("div[id='"+e.data.ID+"']").length&&e.data.FocusOutput.apply(e.data)}),void c(this.SearchTxtElement).prop("readonly","readonly")}this.IsMobile?(c(this.SearchTxtElement).unbind("keydown.SearchTxtElement").bind("keydown.SearchTxtElement",this,function(e){13==e.which&&(e.preventDefault(),e.stopPropagation())}),c(this.SearchTxtElement).unbind("keyup.SearchTxtElement").bind("keyup.SearchTxtElement",this,function(e){13==e.which&&(e.data.SetSearchTxtElementWidth.apply(e.data),e.data.FocusInput.apply(e.data),e.data.SearchOrg.apply(e.data,[e.data]))})):(c(this.SearchTxtElement).unbind("keyup.SearchTxtElement").bind("keyup.SearchTxtElement",this,function(e){e.data.SetSearchTxtElementWidth.apply(e.data),e.data.FocusInput.apply(e.data),e.data.KeyTime=new Date;var t=e.data;i.canSearch&&(i.canSearch=!1,setTimeout(function(){i.SearchOrg.apply(t,[t]),i.canSearch=!0},500))}),c(this.SearchTxtElement).unbind("keydown.SearchTxtElement").bind("keydown.SearchTxtElement",this,function(e){8==e.keyCode&&""==c(this).val()&&e.data.RemoveChoice.apply(e.data,[c(this).parent().prev().attr("data-code")])})),c(document).unbind("click."+this.ID).bind("click."+this.ID,this,function(e){0==c(e.target).closest("div[id='"+e.data.ID+"']").length&&e.data.FocusOutput.apply(e.data)}),this.IsMobile&&c(this.OrgListBtn).unbind("click.OrgListBtn").bind("click.OrgListBtn",this,function(e){var t=c(this).data("targetID");e.data.AddMobilePanel.apply(e.data,[t,""])})}},AddMobilePanel:function(a,e){this.Level++;var n=this,s=c("#"+a);if(0==s.length){if(s=c("<div>").attr("id",a).addClass("panel").addClass("no-scroll").hide(),""!=e){var t=c("li[objectID='"+e+"']>label");0==t.length&&(t=c("li[objectID='"+e+"']")),s.attr("data-title",t.text())}else s.attr("data-title",c.ui.prevHeader.find("#pageTitle").text());s.attr("data-footer",this.FooterID),s.data("parentid",e);var i=n.SheetUserHandler+"?IsMobile=true&"+n.GetLoadTreeOption();e&&(i=n.SheetUserHandler+"?IsMobile=true&ParentID="+e+"&"+n.GetLoadTreeOption()),c.ajax({type:"GET",url:i,dataType:"json",context:n,async:!1,success:function(e){var t=c("<ul>").addClass("orglist").addClass("list");n.AddMobileOptions(e,t);var i=c("<div class='scroll-wrapper'>");i.append(t),s.append(i),c("#content").append(s),n.SetMobilePanelRefreshOnload(a)}})}c.ui.loadContent(a),this.MobileFindCheckbox(a)},MobilePreBack:function(){var e="#"+c.ui.activeDiv.id;0<this.Level&&this.Level--,this.MobileFindCheckbox(e)},SetMobilePanelRefreshOnload:function(e){window.PanelLoadActions=window.PanelLoadActions||{};var t=this,i="F"+this.EditPanel.attr("id").replace(/\-/g,"");c("#"+e).attr("data-load","window.PanelLoadActions."+i),window.PanelLoadActions[i]=function(){setTimeout(function(){t.RefreshMobilePage()},600)}},AddMobileOptions:function(e,t,i){if(e){var a=this;e instanceof Array?e.length?c(e).each(function(){a._AddMobileOption(this,t,i)}):t.html('<li class="user-item">没有任何组织</li>'):a._AddMobileOption(e,t,i)}else t.html('<li class="user-item">没有任何组织</li>')},GetSelectableFlag:function(){if(void 0===this.__SelectableOption){this.__SelectableOption="",loadOptions=this.GetLoadTreeOption();var e=loadOptions.match(/o=[A-z]*/);e&&e.length&&(this.__SelectableOption=e[0].replace("o=",""))}return this.__SelectableOption},_AddMobileOption:function(e,t,i){var a=this.GetSelectableFlag(),n=c("<li>").addClass("user-item");if(-1<a.indexOf(e.ExtendObject.UnitType)){var s=c.uuid(),l=c("<input type='checkbox'  id='"+s+"' data-objectid='"+e.ObjectID+"'/>");l.attr("checked",this.Choices&&null!=this.Choices[e.ObjectID]),n.append(l);var h=e.Text;i&&-1==(h=h.replace(i,"<span class='bg-info'>"+i+"</span>")).indexOf("["+e.Code+"]")&&(h+="["+e.Code.replace(i,"<span class='bg-info'>"+i+"</span>")+"]"),n.append(c("<label type='checkbox' label-for='"+s+"'>"+h+"</label>").css("float","none").css("left","25px"))}else n.append(e.Text);n.attr("objectID",e.ObjectID);var r=c.uuid();if(n.attr("targetID",r),!e.IsLeaf){var o=c("<a data-ignore=true>"+c(n).html()+"</a>");c(n).html("").append(o),n.append(c("<div>").addClass("org-expand").css({width:"20%",height:"100%","z-index":2,position:"absolute",right:0,top:0}))}t.append(n);var d={ObjectID:e.ObjectID,Name:e.Text};c(n).unbind("click.OrgListBtn").bind("click.OrgListBtn",[this,d],function(e){var t=e.data[0];e.data[1];if(c(e.target).is(".org-expand")||0==c(this).find("input[type=checkbox]").length){var i=c(this).attr("objectID"),a=c(this).attr("targetID");c("#defaultHeader>.backButton").data("pannelid",r),t.AddMobilePanel.apply(t,[a,i])}else{var n=c(this).find("input[type=checkbox]");n.prop("checked",!n.prop("checked")),t.UnitCheckboxClick.apply(c(this).find("input[type=checkbox]").get(0),e.data)}})},MobileFindCheckbox:function(e){null==e&&c.ui.history&&(e=c.ui.history[c.ui.history.length-1].target),e.indexOf("#")<0&&(e="#"+e);var t=this;c(e).find("input:checkbox").each(function(){c(this).prop("checked",null!=t.Choices[c(this).attr("data-objectid")])})},SetSearchTxtElementWidth:function(){if(!this.IsMobile){var e="1px",t=this.SearchTxtElement.val().length;0<t?(e=15*t+"px",this.SearchTxtElement.removeAttr("PlaceHolder",this.PlaceHolder)):c.isEmptyObject(this.Choices)?(e="150px",this.SearchTxtElement.attr("PlaceHolder",this.PlaceHolder)):this.SearchTxtElement.removeAttr("PlaceHolder",this.PlaceHolder),c(this.SearchTxtElement).width(e),this.IsMobile}},FocusInput:function(){if(!this.IsMobile&&!this.SelectorPanel.is(":visible")){c("div[data-SheetUserPanel='SelectorPanel']").hide(),this.SelectorPanel.show();var e=c("body").width()-this.SelectorPanel.width()-this.SelectorPanel.offset().left-100;e<0&&this.SelectorPanel.css("left",e+"px"),this.IsMobile||this.IsLoaded||this.LoadOrgTree(),this.IsMobile||0!=this.OrgListPanel.find("input").length||this.TreeManager.selectNode(this.TreeManager.data[0])}},FocusOutput:function(){this.IsMobile||(0<c(this.SearchTxtElement).val().length&&(this.OrgListPanel.html(""),c(this.SearchTxtElement).val("")),this.SelectorPanel.is(":hidden")||this.SelectorPanel.hide())},MappingControlsHandler:function(e){if(this.MappingControls){for(var t="",n={},i=this.MappingControls.split(","),a=0;a<i.length;a++){var s=i[a].split(":");n[s[0]]=s[1],t+=s[1]+";"}var l=this,h={Command:"GetUserProperty",Param:JSON.stringify([e.ObjectID,t])};c.MvcSheet.GetSheet(h,function(e){for(var t in e)for(var i in n)if(n[i]==t){var a=c.MvcSheetUI.GetElement(i,l.GetRowNumber());(null!=a&&a.data(c.MvcSheetUI.SheetIDKey)||null!=a&&r)&&(r=!1,a.SheetUIManager().SetValue(e[t]))}})}},AddChoice:function(e){if(e&&e.ObjectID&&!this.Choices[e.ObjectID])if(this.IsMultiple||this.ClearChoices(),this.Choices[e.ObjectID]=e,this.MappingControls&&this.MappingControlsHandler(e),this.Editable){var t=c.MvcSheetUI.NewGuid();e.ChoiceID=t;var i=c("<li class='select2-search-choice'></li>"),a=c("<div>"+e.Name+"</div>");i.css("cursor","pointer").css("margin-top","2px").css("background-color","#b0b0b0"),i.attr("id",t).attr("data-code",e.ObjectID).append(a),this.IsMobile?i.css("margin-top","10px"):(this.SearchElement.before(i),this.SetSearchTxtElementWidth.apply(this),i.insertBefore(this.ChoicesElement.find("li:last")));var n=c("<a href='javascript:void(0)' class='select2-search-choice-close'></a>");i.append(n),i.unbind("click.choice").bind("click.choice",this,function(e){e.data.RemoveChoice.apply(e.data,[c(this).attr("data-code")]),c(e.data.Element).trigger("change")}),this.Validate(),this.IsMobile&&this.OnMobileChange(),this.OnChange&&this.RunScript(this,this.OnChange,[this]),c(this.Element).trigger("change")}else c(this.Element).html(this.GetText())},OnMobileChange:function(){if(this.IsMobile){var e=this;setTimeout(function(){e.RefreshMobilePage()},100)}},RefreshMobilePage:function(){this.EditPanelID&&(this.ChoicesPanel.height(c(this.ChoicesElement).outerHeight()),this.SelectorPanel&&this.SelectorPanel.outerHeight(c("#afui").height()-c("header:visible").outerHeight()-c("#footer:visible").outerHeight()-this.ChoicesPanel.outerHeight()-this.SearchElement.parent().outerHeight()))},_GetScroller:function(e){this.IScrollers=this.IScrollers||{};var t=c(e).first(),i=t.data("scroller-id");return i||(i=c.uuid(),t.data("scroller-id",i),this.IScrollers[i]=new IScroll(t.get(0))),this.IScrollers[i]},AddUserID:function(e){var t=this,i={UserID:e,Propertystr:"Name;ObjectID"};c.ajax({type:"GET",url:this.SheetGetUserProperty,data:i,dataType:"json",async:!1,success:function(e){e&&t.AddChoice({ObjectID:e.ObjectID,Name:e.Name})}})},ClearChoices:function(){for(var e in this.Choices)this.RemoveChoice(e);this.OnMobileChange()},RemoveChoice:function(e){this.Choices[e]&&(this.IsMobile||this.OrgListPanel.find("input[ObjectID='"+e+"']").attr("checked",!1),c("#"+this.Choices[e].ChoiceID).remove(),delete this.Choices[e]),this.SetSearchTxtElementWidth.apply(this),this.Validate(),this.OnMobileChange(),this.OnChange&&this.RunScript(this,this.OnChange,[this]),!this.IsMobile&&this.IsMultiple&&this.IsLoaded&&this.OrgListPanel.find("input[ObjectID='"+e+"']").closest("div.SelectorPanel").find("#selectAll").prop("checked",this.isAllSelect(this.Choices))},LoadOrgTree:function(){if(this.OrgTreePanel){var i=this,e=c("<ul>").css("min-width","510px");this.OrgTreePanel.append(e),e.ligerTree||(c("body:first").append("<link rel='stylesheet' type='text/css' href='"+c.MvcSheetUI.PortalRoot+"/WFRes/_Content/themes/ligerUI/Aqua/css/ligerui-tree.css' />"),c.ajax({url:c.MvcSheetUI.PortalRoot+"/WFRes/_Scripts/ligerUI/ligerui.all.min.js",type:"GET",dataType:"script",async:!1,global:!1})),this.IsLoaded=!1;var a=this.GetLoadTreeOption();this.TreeManager=c(e).ligerTree({checkbox:!1,idFieldName:"Code",textFieldName:"Text",iconFieldName:"Icon",btnClickToToggleOnly:!0,isExpand:2,isLeaf:function(e){return e.IsLeaf},delay:function(e){var t=e.data;return null!=t&&(null!=t.IsLeaf&&(!t.IsLeaf&&null==t.children&&{url:i.SheetUserHandler+"?ParentID="+t.Code+"&LoadTree=true&Recursive=false&"+a}))},url:this.SheetUserHandler+"?LoadTree=true&Recursive="+this.Recursive+"&"+a,onSelect:this.TreeNodeClick,onCancelselect:this.TreeNodeClick,SheetUserManager:this,onSuccess:function(){this.options.SheetUserManager.IsLoaded||(0<this.data.length&&this.options.SheetUserManager.TreeNodeClick.apply(this,[{data:this.data[0]}]),this.options.SheetUserManager.IsLoaded=!0)}})}},GetLoadTreeOption:function(){if(!this.__QueryOptions){var e="o=";e="o=";this.SegmentVisible&&(e+="S"),this.OrgUnitVisible&&(e+="O"),this.GroupVisible&&(e+="G"),this.PostVisible&&(e+="P"),this.UserVisible&&(e+="U"),this.VisibleUnits&&(e+="&VisibleUnits="+this.VisibleUnits),this.RootUnitID&&(e+="&RootUnitID="+this.RootUnitID),this.OrgPostCode&&(e+="&OrgPostCode="+encodeURI(this.OrgPostCode)),this.UserCodes&&(e+="&UserCodes="+encodeURI(this.UserCodes)),this.ResignVisible&&(e+="&ResignVisible="+this.ResignVisible),this.__QueryOptions=e}return this.__QueryOptions},TreeNodeClick:function(e){if(null!=e&&null!=e.data){var t=e.data,a=this.options.SheetUserManager;if(a.SelectedValue!=t.ObjectID||a.SearchMode){a.SelectedValue=t.ObjectID,a.SearchMode=!1;var i=a.GetLoadTreeOption();i=i.replace("&VisibleUnits=","&V="),a.OrgListPanel.html(""),0==e.data.treedataindex&&a.OrgUnitVisible&&a.RootSelectable&&!this.options.SheetUserManager.UserCodes&&a.AddListItem.apply(a,[e.data]),c.ajax({type:"GET",url:a.SheetUserHandler+"?ParentID="+t.ObjectID+"&"+i,dataType:"json",success:function(e){0<e.length&&a.IsMultiple&&(a.OrgListPanel.prepend(a.PanelSelectAll),a.PanelSelectAll.bind("click.PanelSelectAll",function(e){a.SelectAll(e,a)}));for(var t=0,i=0;i<e.length;++i)null!=a.Choices[e[i].ObjectID]&&t++,a.AddListItem.apply(a,[e[i]]);0<e.length&&a.IsMultiple&&c("#selectAll")&&(t==e.length?c(".SelectorPanel:visible").find("#selectAll").prop("checked",!0):c(".SelectorPanel:visible").find("#selectAll").prop("checked",!1))}})}}},SearchOrg:function(a){var e=this,n=c(a.SearchTxtElement).val().trim();if(a.SearchKey||n)if(n){for(var t in a.SearchMode=!0,a.SearchKey=n,a.OrgListPanel.html(""),a.SearchResults)if(a.SearchResults[t].SearchKey==n&&a.SearchResults[t].ParentID==a.SelectedValue){if(a.SearchResults[t].Data&&a.SearchResults[t].Data.length){this.IsMultiple&&(a.OrgListPanel.prepend(a.PanelSelectAll),a.PanelSelectAll.bind("click.PanelSelectAll",function(e){a.SelectAll(e,a)}));for(var i=0,s=0;s<a.SearchResults[t].Data.length;++s)null!=a.Choices[a.SearchResults[t].Data[s].ObjectID]&&i++,a.AddListItem.apply(a,[a.SearchResults[t].Data[s],n]);this.IsMultiple&&c("#selectAll")&&(i==a.SearchResults[t].Data.length?c(".SelectorPanel:visible").find("#selectAll").prop("checked",!0):c(".SelectorPanel:visible").find("#selectAll").prop("checked",!1))}else a.OrgListPanel.html('<li class="user-item">没有任何组织</li>');return}c.ajax({type:"GET",url:a.SheetUserHandler+"?IsMobile="+!!this.IsMobile+"&SearchKey="+encodeURI(n)+"&ParentID="+(a.SelectedValue||a.RootUnit||"")+"&"+a.GetLoadTreeOption(),dataType:"json",success:function(e){if(a.IsMobile)a.AddMobileOptions(e,a.OrgListPanel,n),setTimeout(function(){a.RefreshMobilePage()},550);else if(null!=e&&0<e.length){a.IsMultiple&&(a.OrgListPanel.prepend(a.PanelSelectAll),a.PanelSelectAll.bind("click.PanelSelectAll",function(e){a.SelectAll(e,a)}));for(var t=0,i=0;i<e.length;++i)null!=a.Choices[e[i].ObjectID]&&t++,a.AddListItem.apply(a,[e[i],n]);a.IsMultiple&&c("#selectAll")&&(t==e.length?c(".SelectorPanel:visible").find("#selectAll").prop("checked",!0):c(".SelectorPanel:visible").find("#selectAll").prop("checked",!1))}else a.OrgListPanel.html("<li class='user-item'>没搜索到组织</li>");a.SearchResults.push({SearchKey:n,ParentID:a.SelectedValue,Data:e})},complete:function(){e.canSearch=!0}})}else this.IsMobile?a.OrgListPanel.html(""):(a.SearchKey=n,a.OrgListPanel.html(""),a.TreeManager.selectNode(a.TreeManager.nodes[0]))},AddListItem:function(e,t){var i=e.Text,a=e.Text;if(t&&(i=i.replace(t,"<span class='bg-info'>"+t+"</span>"),""!=e.Code&&-1==e.Text.indexOf("["+e.Code+"]")?i+="["+e.orgInfo.replace(t,"<span class='bg-info'>"+t+"</span>")+"]":e.orgInfo&&(i+="["+e.orgInfo+"]")),this.IsMobile){(h=c("<div></div>")).css("border-bottom","1px solid #ccc"),h.height("50px"),h.css("clear","both");var n=c.MvcSheetUI.NewGuid(),s=c("<input type='checkbox' ObjectID='"+e.ObjectID+"' id='"+n+"'/>");h.append(s),h.append(c("<label type='checkbox' label-for='"+n+"'>"+i+"</label>").css("float","none").css("left","25px")),this.OrgListPanel.append(h);var l=this;h.bind("touchstart",function(){s.click(),l.UnitCheckboxClick.apply(s.get(0),[l,{ObjectID:e.ObjectID,Name:e.Text}])})}else{var h;(h=c("<div>").addClass("task").append("<i style='float:left;line-height: 18px;' class='task-sort-icon fa  "+e.Icon+"'></i>").append("<span title='"+a+" ' class='task-title' style='word-break: break-all;display: inline-block;width: 80%;margin-top: 0;overflow: hidden;text-overflow: ellipsis;padding-left: 4px'>"+i+"</span>")).css("padding","5px 10px 5px 10px").css("border-bottom","1px solid #e4e4e4").css("cursor","pointer");n=c.MvcSheetUI.NewGuid(),s=c("<input type='checkbox' ObjectID='"+e.ObjectID+"' id='"+n+"'/>").css("height","auto").css("margin","0px").show();var r=c("<div>").addClass("action-checkbox pull-right").append(s);h.click(function(e){"input"!=e.target.tagName.toLowerCase()&&c(this).find("input").click()}),this.OrgListPanel.append(h.append(r)),s.attr("checked",null!=this.Choices[e.ObjectID]),s.click({that:this,option:{ObjectID:e.ObjectID,Name:e.Text}},function(e){e.data.that.UnitCheckboxClick.apply(this,[e.data.that,e.data.option])})}},UnitCheckboxClick:function(e,t){this.checked?(e.IsMultiple||(e.ClearChoices.apply(e),e.OrgListPanel.find("input").attr("checked",!1),this.checked=!0,e.IsMobile&&0<e.Level&&(c.ui.goBack(e.Level),e.Level=0),e.FocusOutput.apply(e)),e.AddChoice.apply(e,[t]),e.IsMultiple&&c(".SelectorPanel:visible").find("#selectAll").prop("checked",e.isAllSelect(e.Choices))):e.IsMultiple?e.RemoveChoice.apply(e,[t.ObjectID]):e.ClearChoices.apply(e)},isAllSelect:function(e){var t=c(".SelectorPanel:visible").find("#selectAll").closest("div.task").siblings(".task").find("input"),i=0;return t.each(function(){null!=e[c(this).attr("ObjectID")]&&i++}),i==t.length},SelectAll:function(e,t){"input"!=e.target.tagName.toLowerCase()?c(e.target).closest("div.task").find("input")[0].checked?(c(e.target).closest("div.task").find("input")[0].checked=!1,c(e.target).closest("div.task").siblings().each(function(){c(this).find("input")[0].checked=!1,t.RemoveChoice.apply(t,[c(this).find("input").attr("ObjectID")])})):(c(e.target).closest("div.task").find("input")[0].checked=!0,c(e.target).closest("div.task").siblings().each(function(){c(this).find("input")[0].checked=!0,t.AddChoice.apply(t,[{ObjectID:c(this).find("input").attr("ObjectID"),Name:c.trim(c(this).text())}])})):c(e.target)[0].checked?c(e.target).closest("div.task").siblings().each(function(){c(this).find("input")[0].checked=!0,t.AddChoice.apply(t,[{ObjectID:c(this).find("input").attr("ObjectID"),Name:c.trim(c(this).text())}])}):c(e.target).closest("div.task").siblings().each(function(){c(this).find("input")[0].checked=!1,t.RemoveChoice.apply(t,[c(this).find("input").attr("ObjectID")])})}})}(jQuery);